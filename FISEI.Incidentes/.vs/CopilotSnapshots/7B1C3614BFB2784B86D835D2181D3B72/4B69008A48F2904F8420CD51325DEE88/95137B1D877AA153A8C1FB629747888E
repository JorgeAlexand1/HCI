using Microsoft.EntityFrameworkCore;
using FISEI.Incidentes.Core.Entities;
using FISEI.Incidentes.Core.Interfaces.IRepositories;

namespace FISEI.Incidentes.Infrastructure.Data.Repositories
{
    public class ConocimientoRepository : Repository<Conocimiento>, IConocimientoRepository
    {
        public ConocimientoRepository(ApplicationDbContext context) : base(context)
        {
        }

        public override async Task<IEnumerable<Conocimiento>> GetAllAsync()
        {
            return await _dbSet
                .Include(c => c.Categoria)
                .Include(c => c.IncidenteOrigen)
                .OrderByDescending(c => c.FechaCreacion)
                .ToListAsync();
        }

        public async Task<IEnumerable<Conocimiento>> BuscarPorPalabrasClave(string palabrasClave)
        {
            return await _dbSet
                .Include(c => c.Categoria)
                .Where(c => c.Aprobado && 
                    (c.Titulo.Contains(palabrasClave) || 
                     c.Descripcion.Contains(palabrasClave) ||
                     (c.PalabrasClave != null && c.PalabrasClave.Contains(palabrasClave))))
                .OrderByDescending(c => c.Visualizaciones)
                .ToListAsync();
        }

        public async Task<IEnumerable<Conocimiento>> GetArticulosAprobadosAsync()
        {
            return await _dbSet
                .Include(c => c.Categoria)
                .Where(c => c.Aprobado)
                .OrderByDescending(c => c.Visualizaciones)
                .ThenByDescending(c => c.Calificacion)
                .ToListAsync();
        }

        public async Task IncrementarVisualizacionesAsync(int idConocimiento)
        {
            var articulo = await _dbSet.FindAsync(idConocimiento);
            if (articulo != null)
            {
                articulo.Visualizaciones++;
                await _context.SaveChangesAsync();
            }
        }
    }
}