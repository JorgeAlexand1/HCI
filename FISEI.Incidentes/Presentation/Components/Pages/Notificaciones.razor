@page "/notificaciones"
@using FISEI.Incidentes.Core.Entities
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer

<PageTitle>Notificaciones - FISEI Incidentes</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="bi bi-bell-fill"></i> Notificaciones
                    @if (notificacionesNoLeidas.Any())
                    {
                        <span class="badge bg-danger ms-2">@notificacionesNoLeidas.Count</span>
                    }
                </h2>
                @if (notificacionesNoLeidas.Any())
                {
                    <button class="btn btn-outline-primary" @onclick="MarcarTodasLeidas">
                        <i class="bi bi-check-all"></i> Marcar todas como leídas
                    </button>
                }
            </div>

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else if (!notificacionesNoLeidas.Any())
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> No tienes notificaciones pendientes
                </div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var notif in notificacionesNoLeidas.OrderByDescending(n => n.FechaEnvio))
                    {
                        <div class="list-group-item @(!notif.Leido ? "border-start border-primary border-4" : "")">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <p class="mb-1 @(!notif.Leido ? "fw-bold" : "")">
                                        @notif.Mensaje
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> @notif.FechaEnvio.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                                @if (!notif.Leido)
                                {
                                    <button class="btn btn-sm btn-outline-success" 
                                            @onclick="() => MarcarLeida(notif.IdNotificacion)">
                                        <i class="bi bi-check"></i> Marcar leída
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            <!-- Panel de prueba para enviar notificaciones (solo para desarrollo) -->
            <div class="card mt-5 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-bug"></i> Panel de Pruebas SignalR</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ID Usuario Destino</label>
                            <input type="number" class="form-control" @bind="testUsuarioId" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" @bind="testTipo">
                                <option value="info">Info</option>
                                <option value="assignment">Asignación</option>
                                <option value="escalation">Escalamiento</option>
                                <option value="status_change">Cambio Estado</option>
                                <option value="success">Éxito</option>
                                <option value="warning">Advertencia</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Mensaje</label>
                            <input type="text" class="form-control" @bind="testMensaje" 
                                   placeholder="Escribe el mensaje de prueba..." />
                        </div>
                        <div class="col-12">
                            <button class="btn btn-warning w-100" @onclick="EnviarNotificacionPrueba">
                                <i class="bi bi-send"></i> Enviar Notificación de Prueba
                            </button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(testResultado))
                    {
                        <div class="alert alert-@testResultadoTipo mt-3 mb-0" role="alert">
                            @testResultado
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Notificacion> notificacionesNoLeidas = new();
    private bool isLoading = true;
    private int currentUserId;
    private bool hasRendered = false;

    // Variables para pruebas
    private int testUsuarioId = 1;
    private string testMensaje = "Esta es una notificación de prueba desde SignalR";
    private string testTipo = "info";
    private string testResultado = "";
    private string testResultadoTipo = "info";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRendered)
        {
            hasRendered = true;
            
            // Obtener ID del usuario actual del token
            var token = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(token))
            {
                var claims = ParseJwt(token);
                if (claims.TryGetValue("id", out var userId))
                {
                    currentUserId = int.Parse(userId);
                }
            }

            await CargarNotificaciones();
            StateHasChanged();
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task CargarNotificaciones()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetAsync($"api/notificaciones/no-leidas/{currentUserId}");
            if (response.IsSuccessStatusCode)
            {
                notificacionesNoLeidas = await response.Content.ReadFromJsonAsync<List<Notificacion>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando notificaciones: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task MarcarLeida(int idNotificacion)
    {
        try
        {
            var response = await Http.PutAsync($"api/notificaciones/marcar-leida/{idNotificacion}", null);
            if (response.IsSuccessStatusCode)
            {
                await CargarNotificaciones();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marcando notificación: {ex.Message}");
        }
    }

    private async Task MarcarTodasLeidas()
    {
        try
        {
            var response = await Http.PutAsync($"api/notificaciones/marcar-todas-leidas/{currentUserId}", null);
            if (response.IsSuccessStatusCode)
            {
                await CargarNotificaciones();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marcando todas las notificaciones: {ex.Message}");
        }
    }

    private async Task EnviarNotificacionPrueba()
    {
        try
        {
            var response = await Http.PostAsync(
                $"api/notificaciones/enviar?idUsuario={testUsuarioId}&mensaje={Uri.EscapeDataString(testMensaje)}&tipo={testTipo}", 
                null);
            
            if (response.IsSuccessStatusCode)
            {
                testResultado = $"✅ Notificación enviada exitosamente al usuario {testUsuarioId}";
                testResultadoTipo = "success";
                
                // Si es el usuario actual, recargar notificaciones
                if (testUsuarioId == currentUserId)
                {
                    await Task.Delay(500);
                    await CargarNotificaciones();
                }
            }
            else
            {
                testResultado = $"❌ Error al enviar: {response.StatusCode}";
                testResultadoTipo = "danger";
            }
        }
        catch (Exception ex)
        {
            testResultado = $"❌ Excepción: {ex.Message}";
            testResultadoTipo = "danger";
        }

        // Limpiar mensaje después de 5 segundos
        _ = Task.Run(async () =>
        {
            await Task.Delay(5000);
            testResultado = "";
            await InvokeAsync(StateHasChanged);
        });
    }

    private Dictionary<string, string> ParseJwt(string token)
    {
        var payload = token.Split('.')[1];
        var jsonBytes = Convert.FromBase64String(PadBase64(payload));
        var json = System.Text.Encoding.UTF8.GetString(jsonBytes);
        return System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json) ?? new();
    }

    private string PadBase64(string base64)
    {
        var padding = base64.Length % 4;
        if (padding > 0) base64 += new string('=', 4 - padding);
        return base64;
    }
}
