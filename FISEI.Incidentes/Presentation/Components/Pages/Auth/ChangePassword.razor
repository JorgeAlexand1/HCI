@page "/change-password"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Nav

<h3>Cambiar contraseña</h3>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @alertClass">@message</div>
}

<EditForm Model="model" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <div class="mb-3">
        <label class="form-label">Contraseña actual</label>
        <InputText type="password" class="form-control" @bind-Value="model.CurrentPassword" />
    </div>
    <div class="mb-3">
        <label class="form-label">Nueva contraseña</label>
        <InputText type="password" class="form-control" @bind-Value="model.NewPassword" />
        <small class="text-muted">Mínimo 8 caracteres, incluir mayúscula, número.</small>
    </div>
    <div class="mb-3">
        <label class="form-label">Confirmar nueva contraseña</label>
        <InputText type="password" class="form-control" @bind-Value="confirm" />
    </div>
    <button class="btn btn-primary" disabled="@submitting">@((submitting?"Procesando...":"Guardar"))</button>
</EditForm>

@code {
    private ChangePasswordModel model = new();
    private string confirm = string.Empty;
    private bool submitting = false;
    private string? message;
    private string alertClass = "alert-info";

    public class ChangePasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string CurrentPassword { get; set; } = string.Empty;
        [System.ComponentModel.DataAnnotations.Required]
        public string NewPassword { get; set; } = string.Empty;
    }

    private bool ValidateComplexity(string pwd)
    {
        if (pwd.Length < 8) return false;
        if (!pwd.Any(char.IsUpper)) return false;
        if (!pwd.Any(char.IsDigit)) return false;
        return true;
    }

    private async Task OnSubmit()
    {
        message = null;
        if (model.NewPassword != confirm)
        {
            message = "Las contraseñas no coinciden"; alertClass = "alert-danger"; return;
        }
        if (!ValidateComplexity(model.NewPassword))
        {
            message = "La contraseña no cumple requisitos"; alertClass = "alert-danger"; return;
        }
        submitting = true;
        try
        {
            var resp = await Http.PostAsJsonAsync("api/auth/change-password", model);
            if (resp.IsSuccessStatusCode)
            {
                message = "Contraseña cambiada"; alertClass = "alert-success";
                model = new(); confirm = string.Empty;
            }
            else if (resp.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                message = "Sesión expirada"; alertClass = "alert-warning"; Nav.NavigateTo("/login");
            }
            else
            {
                var txt = await resp.Content.ReadAsStringAsync();
                message = string.IsNullOrWhiteSpace(txt)?"Error desconocido":txt; alertClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            message = ex.Message; alertClass = "alert-danger";
        }
        finally { submitting = false; }
    }
}