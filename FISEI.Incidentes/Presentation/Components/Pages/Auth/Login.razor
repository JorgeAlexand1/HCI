@page "/login"
@layout Presentation.Components.Layout.EmptyLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject FISEI.Incidentes.Infrastructure.Services.TokenProvider TokenProvider
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Iniciar Sesión</PageTitle>

<div class="row justify-content-center mt-5">
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Iniciar Sesión</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }
                @if (!string.IsNullOrEmpty(unverifiedEmail))
                {
                    <div class="alert alert-warning d-flex align-items-center justify-content-between">
                        <span>Tu correo no está verificado. Revisa tu bandeja o reenvía la verificación.</span>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ResendVerification" disabled="@resending">
                            @if (resending) { <span class="spinner-border spinner-border-sm me-1"></span> }
                            Reenviar verificación
                        </button>
                    </div>
                }
                <div>
                    <div class="mb-3">
                        <label class="form-label">Correo</label>
                        <InputText class="form-control" @bind-Value="loginModel.Email" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <InputText class="form-control" @bind-Value="loginModel.Password" type="password" />
                    </div>
                    <button class="btn btn-primary w-100" type="button" @onclick="(() => OnSubmit())" disabled="@isSubmitting">
                        @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        Entrar
                    </button>
                    <div class="mt-3 text-center">
                        <a href="/reset-password">¿Olvidaste tu contraseña?</a>
                    </div>
                    <hr />
                    <div class="text-center">
                        <span>¿No tienes una cuenta?</span>
                        <a href="/register" class="ms-2 btn btn-outline-primary btn-sm">Registrarse</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
@* Opcional: sección ayuda *@
</div>

@code {
    private string? errorMessage;
    private bool isSubmitting = false;
    private LoginRequest loginModel = new();

    public class LoginRequest
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Email { get; set; } = string.Empty;
        [System.ComponentModel.DataAnnotations.Required]
        public string Password { get; set; } = string.Empty;
    }

    private async Task OnSubmit()
    {
        errorMessage = null;
        isSubmitting = true;
        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", loginModel);
            if (!response.IsSuccessStatusCode)
            {
                try
                {
                    var err = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                    if (err?.code == "EMAIL_NOT_VERIFIED")
                    {
                        unverifiedEmail = loginModel.Email;
                        errorMessage = "Correo no verificado";
                    }
                    else
                    {
                        errorMessage = err?.message ?? "Credenciales inválidas";
                    }
                }
                catch
                {
                    errorMessage = "Credenciales inválidas";
                }
                return;
            }
            var payload = await response.Content.ReadFromJsonAsync<LoginResponse>();
            if (payload == null || string.IsNullOrWhiteSpace(payload.token))
            {
                errorMessage = "Respuesta inválida del servidor";
                return;
            }

            // Guardar token en sessionStorage (JS) y configurar HttpClient
            await TokenProvider.SetTokenAsync(payload.token);
            
            // Notificar al AuthenticationStateProvider
            if (AuthStateProvider is FISEI.Incidentes.Infrastructure.Security.CustomAuthStateProvider customProvider)
            {
                customProvider.NotifyUserAuthentication(payload.token);
            }
            
            // Pequeña espera para que el estado se propague
            await Task.Delay(100);
            
            Navigation.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class LoginResponse
    {
        public string token { get; set; } = string.Empty;
        public List<string> roles { get; set; } = new();
    }

    private string? unverifiedEmail;
    private bool resending = false;
    private async Task ResendVerification()
    {
        if (string.IsNullOrEmpty(unverifiedEmail)) return;
        resending = true;
        try
        {
            var payload = new { Email = unverifiedEmail };
            await Http.PostAsJsonAsync("api/auth/resend-verification", payload);
        }
        catch { }
        finally { resending = false; }
    }

    public class ErrorResponse
    {
        public string? code { get; set; }
        public string? message { get; set; }
    }
}
