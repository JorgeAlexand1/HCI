@page "/reset-password"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject HttpClient Http
@using System.Net.Http.Json

<h3>Restablecer contraseña</h3>

@if (done)
{
    <div class="alert alert-success">Contraseña actualizada. Puedes <a href="/login">iniciar sesión</a>.</div>
}
else
{
    <EditForm Model="model" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label class="form-label">Nueva contraseña</label>
            <InputText type="password" class="form-control" @bind-Value="model.NewPassword" />
        </div>
        <div class="mb-3">
            <label class="form-label">Confirmar contraseña</label>
            <InputText type="password" class="form-control" @bind-Value="confirm" />
        </div>
        <button class="btn btn-primary" disabled="@submitting">@((submitting?"Procesando...":"Actualizar"))</button>
    </EditForm>
    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-3">@error</div>
    }
}

@code {
    private ResetModel model = new();
    private string confirm = string.Empty;
    private bool submitting = false;
    private bool done = false;
    private string? error;

    protected override void OnInitialized()
    {
        var uri = new Uri(Nav.Uri);
        var q = System.Web.HttpUtility.ParseQueryString(uri.Query);
        model.Email = q.Get("email") ?? string.Empty;
        model.Token = q.Get("token") ?? string.Empty;
    }

    private bool Validate(string pwd)
    {
        if (pwd.Length < 8) return false;
        if (!pwd.Any(char.IsUpper)) return false;
        if (!pwd.Any(char.IsDigit)) return false;
        return true;
    }

    private async Task OnSubmit()
    {
        error = null;
        if (model.NewPassword != confirm) { error = "Las contraseñas no coinciden"; return; }
        if (!Validate(model.NewPassword)) { error = "La contraseña no cumple requisitos"; return; }
        submitting = true;
        try
        {
            var payload = new { Email = model.Email, Token = model.Token, NewPassword = model.NewPassword };
            var resp = await Http.PostAsJsonAsync("api/auth/confirm-password-reset", payload);
            if (resp.IsSuccessStatusCode) { done = true; }
            else error = await resp.Content.ReadAsStringAsync();
        }
        catch (Exception ex) { error = ex.Message; }
        finally { submitting = false; }
    }

    public class ResetModel
    {
        public string Email { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
    }
}