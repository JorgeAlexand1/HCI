@using FISEI.Incidentes.Core.Entities
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

<div class="notification-dropdown">
    <button class="btn btn-link position-relative d-flex align-items-center gap-2" @onclick="ToggleDropdown" type="button" style="text-decoration: none;">
        <i class="bi bi-bell-fill fs-5" style="color: #FFD700;"></i>
        <span style="color: #ffffff; font-weight: 500;">Notificaciones</span>
        @if (unreadCount > 0)
        {
            <span class="position-absolute top-0 start-0 translate-middle badge rounded-pill" style="font-size: 0.65rem; background-color: #C41E3A;">
                @unreadCount
                <span class="visually-hidden">notificaciones no leídas</span>
            </span>
        }
    </button>

    @if (showDropdown)
    {
        <div class="notification-panel show">
            <div class="notification-header">
                <h6 class="mb-0">
                    <i class="bi bi-bell"></i> Notificaciones
                    @if (unreadCount > 0)
                    {
                        <span class="badge bg-danger ms-2">@unreadCount</span>
                    }
                </h6>
                @if (notificaciones.Any(n => !n.Leido))
                {
                    <button class="btn btn-sm btn-link text-primary" @onclick="MarcarTodasLeidas">
                        Marcar todas
                    </button>
                }
            </div>

            <div class="notification-body">
                @if (isLoading)
                {
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                }
                else if (!notificaciones.Any())
                {
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mb-0 mt-2">No tienes notificaciones</p>
                    </div>
                }
                else
                {
                    @foreach (var notif in notificaciones.OrderByDescending(n => n.FechaEnvio).Take(10))
                    {
                        <div class="notification-item @(!notif.Leido ? "unread" : "")" 
                             @onclick="() => MarcarLeida(notif.IdNotificacion)">
                            <div class="notification-icon @GetIconClass(notif.Mensaje)">
                                <i class="bi @GetIconType(notif.Mensaje)"></i>
                            </div>
                            <div class="notification-content">
                                <p class="mb-1 @(!notif.Leido ? "fw-bold" : "")">@notif.Mensaje</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> @GetTimeAgo(notif.FechaEnvio)
                                </small>
                            </div>
                            @if (!notif.Leido)
                            {
                                <div class="notification-badge">
                                    <span class="badge bg-primary rounded-circle p-1"></span>
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

<style>
    .notification-dropdown {
        position: relative;
    }

    .notification-panel {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        width: 380px;
        max-height: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1050;
        margin-top: 10px;
    }

    .notification-panel.show {
        display: flex;
        flex-direction: column;
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .notification-header h6 {
        color: #212529;
        font-weight: 600;
    }

    .notification-body {
        overflow-y: auto;
        max-height: 420px;
    }

    .notification-item {
        display: flex;
        align-items: start;
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .notification-item:hover {
        background-color: #f8f9fa;
    }

    .notification-item.unread {
        background-color: #e7f3ff;
    }

    .notification-item.unread:hover {
        background-color: #d0e9ff;
    }

    .notification-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .notification-icon.info {
        background-color: #cfe2ff;
        color: #0d6efd;
    }

    .notification-icon.assignment {
        background-color: #d1e7dd;
        color: #198754;
    }

    .notification-icon.escalation {
        background-color: #fff3cd;
        color: #ffc107;
    }

    .notification-icon.status {
        background-color: #e2d9f3;
        color: #6f42c1;
    }

    .notification-content {
        flex: 1;
    }

    .notification-content p {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.4;
        color: #212529;
    }

    .notification-content small {
        font-size: 0.8rem;
    }

    .notification-badge {
        margin-left: 8px;
    }

    .notification-badge .badge {
        width: 8px;
        height: 8px;
        padding: 0;
    }
</style>

@code {
    private List<Notificacion> notificaciones = new();
    private bool showDropdown = false;
    private bool isLoading = true;
    private int currentUserId;
    private int unreadCount = 0;
    private bool hasRendered = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRendered)
        {
            hasRendered = true;
            
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("id")?.Value;
                if (!string.IsNullOrEmpty(userIdClaim))
                {
                    currentUserId = int.Parse(userIdClaim);
                    await CargarNotificaciones();
                    StateHasChanged();
                }
            }
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private async Task CargarNotificaciones()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetAsync($"api/notificaciones/no-leidas/{currentUserId}");
            if (response.IsSuccessStatusCode)
            {
                notificaciones = await response.Content.ReadFromJsonAsync<List<Notificacion>>() ?? new();
                unreadCount = notificaciones.Count(n => !n.Leido);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando notificaciones: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task MarcarLeida(int idNotificacion)
    {
        try
        {
            var response = await Http.PutAsync($"api/notificaciones/marcar-leida/{idNotificacion}", null);
            if (response.IsSuccessStatusCode)
            {
                var notif = notificaciones.FirstOrDefault(n => n.IdNotificacion == idNotificacion);
                if (notif != null)
                {
                    notif.Leido = true;
                    unreadCount = notificaciones.Count(n => !n.Leido);
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marcando notificación: {ex.Message}");
        }
    }

    private async Task MarcarTodasLeidas()
    {
        try
        {
            var response = await Http.PutAsync($"api/notificaciones/marcar-todas-leidas/{currentUserId}", null);
            if (response.IsSuccessStatusCode)
            {
                foreach (var notif in notificaciones)
                {
                    notif.Leido = true;
                }
                unreadCount = 0;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marcando todas las notificaciones: {ex.Message}");
        }
    }

    private string GetIconClass(string mensaje)
    {
        if (mensaje.Contains("asignado")) return "assignment";
        if (mensaje.Contains("escalado")) return "escalation";
        if (mensaje.Contains("estado")) return "status";
        return "info";
    }

    private string GetIconType(string mensaje)
    {
        if (mensaje.Contains("asignado")) return "bi-person-check-fill";
        if (mensaje.Contains("escalado")) return "bi-arrow-up-circle-fill";
        if (mensaje.Contains("estado")) return "bi-arrow-repeat";
        return "bi-info-circle-fill";
    }

    private string GetTimeAgo(DateTime fecha)
    {
        var diff = DateTime.Now - fecha;
        
        if (diff.TotalMinutes < 1) return "Ahora mismo";
        if (diff.TotalMinutes < 60) return $"Hace {(int)diff.TotalMinutes} min";
        if (diff.TotalHours < 24) return $"Hace {(int)diff.TotalHours}h";
        if (diff.TotalDays < 7) return $"Hace {(int)diff.TotalDays}d";
        
        return fecha.ToString("dd/MM/yyyy");
    }

    public void HandleNotification()
    {
        _ = CargarNotificaciones();
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}
