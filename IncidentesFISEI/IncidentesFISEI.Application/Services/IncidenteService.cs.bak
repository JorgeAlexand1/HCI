using IncidentesFISEI.Application.DTOs;
using IncidentesFISEI.Application.Interfaces;
using IncidentesFISEI.Domain.Entities;
using IncidentesFISEI.Domain.Interfaces;
using IncidentesFISEI.Domain.Enums;
using Microsoft.Extensions.Logging;
using System.Security.Cryptography;
using System.Text;

namespace IncidentesFISEI.Application.Services;

public class IncidenteService : IIncidenteService
{
    private readonly IIncidenteRepository _incidenteRepository;
    private readonly IUsuarioRepository _usuarioRepository;
    private readonly ICategoriaIncidenteRepository _categoriaRepository;
    private readonly ILogger<IncidenteService> _logger;

    public IncidenteService(
        IIncidenteRepository incidenteRepository,
        IUsuarioRepository usuarioRepository,
        ICategoriaIncidenteRepository categoriaRepository,
        ILogger<IncidenteService> logger)
    {
        _incidenteRepository = incidenteRepository;
        _usuarioRepository = usuarioRepository;
        _categoriaRepository = categoriaRepository;
        _logger = logger;
    }

    public async Task<ApiResponse<IncidenteDto>> CreateIncidenteAsync(CreateIncidenteDto createDto, int reportadoPorId)
    {
        try
        {
            // Validar usuario
            var usuario = await _usuarioRepository.GetByIdAsync(reportadoPorId);
            if (usuario == null)
                return new ApiResponse<IncidenteDto>(false, null, "Usuario no encontrado");

            // Validar categoría
            var categoria = await _categoriaRepository.GetByIdAsync(createDto.CategoriaId);
            if (categoria == null)
                return new ApiResponse<IncidenteDto>(false, null, "Categoría no encontrada");

            // Generar número de incidente
            var numeroIncidente = await _incidenteRepository.GenerateNumeroIncidenteAsync();

            // Crear incidente
            var incidente = new Incidente
            {
                NumeroIncidente = numeroIncidente,
                Titulo = createDto.Titulo,
                Descripcion = createDto.Descripcion,
                Prioridad = createDto.Prioridad,
                Impacto = createDto.Impacto,
                Urgencia = createDto.Urgencia,
                PasosReproducir = createDto.PasosReproducir,
                ActivosAfectados = createDto.ActivosAfectados,
                ReportadoPorId = reportadoPorId,
                CategoriaId = createDto.CategoriaId,
                Estado = EstadoIncidente.Abierto,
                FechaReporte = DateTime.UtcNow
            };

            // Calcular fecha de vencimiento basada en SLA de la categoría
            if (categoria.TiempoResolucionMinutos.HasValue)
            {
                incidente.FechaVencimiento = DateTime.UtcNow.AddMinutes(categoria.TiempoResolucionMinutos.Value);
            }

            var result = await _incidenteRepository.AddAsync(incidente);
            await _incidenteRepository.SaveChangesAsync();

            var incidenteDto = MapToIncidenteDto(result, usuario, null, categoria);

            _logger.LogInformation("Incidente {NumeroIncidente} creado por usuario {UserId}", numeroIncidente, reportadoPorId);

            return new ApiResponse<IncidenteDto>(true, incidenteDto, "Incidente creado exitosamente");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error al crear incidente para usuario {UserId}", reportadoPorId);
            return new ApiResponse<IncidenteDto>(false, null, "Error interno del servidor");
        }
    }

    public async Task<ApiResponse<IncidenteDto>> UpdateIncidenteAsync(UpdateIncidenteDto updateDto, int updatedById)
    {
        try
        {
            var incidente = await _incidenteRepository.GetByIdAsync(updateDto.Id);
            if (incidente == null)
                return new ApiResponse<IncidenteDto>(false, null, "Incidente no encontrado");

            // Validar permisos (solo el reportador, técnico asignado o admin pueden actualizar)
            var usuario = await _usuarioRepository.GetByIdAsync(updatedById);
            if (usuario?.TipoUsuario != TipoUsuario.Administrador && 
                usuario?.TipoUsuario != TipoUsuario.Tecnico &&
                incidente.ReportadoPorId != updatedById &&
                incidente.AsignadoAId != updatedById)
            {
                return new ApiResponse<IncidenteDto>(false, null, "No tiene permisos para actualizar este incidente");
            }

            // Actualizar campos
            if (!string.IsNullOrEmpty(updateDto.Titulo))
                incidente.Titulo = updateDto.Titulo;
            
            if (!string.IsNullOrEmpty(updateDto.Descripcion))
                incidente.Descripcion = updateDto.Descripcion;

            if (updateDto.Estado.HasValue)
            {
                incidente.Estado = updateDto.Estado.Value;
                
                // Actualizar fechas según el estado
                switch (updateDto.Estado.Value)
                {
                    case EstadoIncidente.EnProgreso when incidente.FechaInicioTrabajo == null:
                        incidente.FechaInicioTrabajo = DateTime.UtcNow;
                        break;
                    case EstadoIncidente.Resuelto when incidente.FechaResolucion == null:
                        incidente.FechaResolucion = DateTime.UtcNow;
                        break;
                    case EstadoIncidente.Cerrado when incidente.FechaCierre == null:
                        incidente.FechaCierre = DateTime.UtcNow;
                        break;
                }
            }

            if (updateDto.Prioridad.HasValue)
                incidente.Prioridad = updateDto.Prioridad.Value;

            if (updateDto.Impacto.HasValue)
                incidente.Impacto = updateDto.Impacto.Value;

            if (updateDto.Urgencia.HasValue)
                incidente.Urgencia = updateDto.Urgencia.Value;

            if (updateDto.AsignadoAId.HasValue && updateDto.AsignadoAId != incidente.AsignadoAId)
            {
                incidente.AsignadoAId = updateDto.AsignadoAId;
                incidente.FechaAsignacion = DateTime.UtcNow;
            }

            if (!string.IsNullOrEmpty(updateDto.Solucion))
                incidente.Solucion = updateDto.Solucion;

            if (!string.IsNullOrEmpty(updateDto.CausaRaiz))
                incidente.CausaRaiz = updateDto.CausaRaiz;

            incidente.UpdatedAt = DateTime.UtcNow;

            await _incidenteRepository.UpdateAsync(incidente);
            await _incidenteRepository.SaveChangesAsync();

            // Recargar incidente con relaciones
            var incidenteCompleto = await _incidenteRepository.GetIncidenteCompletoAsync(incidente.Id);
            
            var reportadoPor = await _usuarioRepository.GetByIdAsync(incidenteCompleto!.ReportadoPorId);
            var asignadoA = incidenteCompleto.AsignadoAId.HasValue 
                ? await _usuarioRepository.GetByIdAsync(incidenteCompleto.AsignadoAId.Value) 
                : null;
            var categoria = await _categoriaRepository.GetByIdAsync(incidenteCompleto.CategoriaId);

            var incidenteDto = MapToIncidenteDto(incidenteCompleto, reportadoPor!, asignadoA, categoria!);

            _logger.LogInformation("Incidente {NumeroIncidente} actualizado por usuario {UserId}", incidente.NumeroIncidente, updatedById);

            return new ApiResponse<IncidenteDto>(true, incidenteDto, "Incidente actualizado exitosamente");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error al actualizar incidente {IncidenteId}", updateDto.Id);
            return new ApiResponse<IncidenteDto>(false, null, "Error interno del servidor");
        }
    }

    public async Task<ApiResponse<IncidenteDetalleDto>> GetIncidenteByIdAsync(int id)
    {
        try
        {
            var incidente = await _incidenteRepository.GetIncidenteCompletoAsync(id);
            if (incidente == null)
                return new ApiResponse<IncidenteDetalleDto>(false, null, "Incidente no encontrado");

            // Aquí mapearías a IncidenteDetalleDto con comentarios, archivos, etc.
            // Por simplicidad, solo devuelvo la estructura básica
            var incidenteDto = new IncidenteDetalleDto
            {
                Id = incidente.Id,
                NumeroIncidente = incidente.NumeroIncidente,
                Titulo = incidente.Titulo,
                Descripcion = incidente.Descripcion,
                Estado = incidente.Estado,
                Prioridad = incidente.Prioridad,
                // ... otros campos
            };

            return new ApiResponse<IncidenteDetalleDto>(true, incidenteDto, "Incidente obtenido exitosamente");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error al obtener incidente {IncidenteId}", id);
            return new ApiResponse<IncidenteDetalleDto>(false, null, "Error interno del servidor");
        }
    }

    public async Task<ApiResponse<IEnumerable<IncidenteDto>>> GetIncidentesAsync()
    {
        try
        {
            var incidentes = await _incidenteRepository.GetAllAsync();
            var incidentesDto = new List<IncidenteDto>();

            // Aquí harías el mapeo completo con las relaciones
            // Por simplicidad, devuelvo una lista vacía
            
            return new ApiResponse<IEnumerable<IncidenteDto>>(true, incidentesDto, "Incidentes obtenidos exitosamente");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error al obtener incidentes");
            return new ApiResponse<IEnumerable<IncidenteDto>>(false, null, "Error interno del servidor");
        }
    }

    // Implementar métodos restantes...
    public async Task<ApiResponse<IEnumerable<IncidenteDto>>> GetIncidentesByUsuarioAsync(int usuarioId)
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<IEnumerable<IncidenteDto>>> GetIncidentesByTecnicoAsync(int tecnicoId)
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<IEnumerable<IncidenteDto>>> GetIncidentesByEstadoAsync(EstadoIncidente estado)
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<bool>> AsignarIncidenteAsync(int incidenteId, int tecnicoId, int asignadoPorId)
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<bool>> CerrarIncidenteAsync(int incidenteId, string solucion, int cerradoPorId)
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<Dictionary<EstadoIncidente, int>>> GetEstadisticasEstadoAsync()
    {
        throw new NotImplementedException();
    }

    public async Task<ApiResponse<Dictionary<PrioridadIncidente, int>>> GetEstadisticasPrioridadAsync()
    {
        throw new NotImplementedException();
    }

    private static IncidenteDto MapToIncidenteDto(Incidente incidente, Usuario reportadoPor, Usuario? asignadoA, CategoriaIncidente categoria)
    {
        return new IncidenteDto
        {
            Id = incidente.Id,
            NumeroIncidente = incidente.NumeroIncidente,
            Titulo = incidente.Titulo,
            Descripcion = incidente.Descripcion,
            Estado = incidente.Estado,
            Prioridad = incidente.Prioridad,
            Impacto = incidente.Impacto,
            Urgencia = incidente.Urgencia,
            FechaReporte = incidente.FechaReporte,
            FechaAsignacion = incidente.FechaAsignacion,
            FechaResolucion = incidente.FechaResolucion,
            FechaCierre = incidente.FechaCierre,
            FechaVencimiento = incidente.FechaVencimiento,
            Solucion = incidente.Solucion,
            CausaRaiz = incidente.CausaRaiz,
            PasosReproducir = incidente.PasosReproducir,
            ActivosAfectados = incidente.ActivosAfectados,
            ReportadoPor = new UsuarioDto
            {
                Id = reportadoPor.Id,
                Username = reportadoPor.Username,
                FirstName = reportadoPor.FirstName,
                LastName = reportadoPor.LastName,
                Email = reportadoPor.Email,
                Department = reportadoPor.Department,
                TipoUsuario = reportadoPor.TipoUsuario
            },
            AsignadoA = asignadoA != null ? new UsuarioDto
            {
                Id = asignadoA.Id,
                Username = asignadoA.Username,
                FirstName = asignadoA.FirstName,
                LastName = asignadoA.LastName,
                Email = asignadoA.Email,
                TipoUsuario = asignadoA.TipoUsuario,
                Especialidad = asignadoA.Especialidad
            } : null,
            Categoria = new CategoriaIncidenteDto
            {
                Id = categoria.Id,
                Nombre = categoria.Nombre,
                Descripcion = categoria.Descripcion,
                Color = categoria.Color,
                Icono = categoria.Icono
            }
        };
    }
}