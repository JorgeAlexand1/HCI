@page "/admin/presidente-comision-academica"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@using ProyectoAgiles.Application.DTOs
@using proyectoAgiles.Services
@layout proyectoAgiles.Layout.MainLayout
@inject NavigationManager Navigation
@inject proyectoAgiles.Services.UserSessionService UserSession
@inject proyectoAgiles.Services.AuthService AuthService
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime

<PageTitle>Presidente de la Comisión Académica - UTA</PageTitle>

<div class="presidente-comision-page">
    <!-- Botón Volver Flotante -->
    <div class="back-button-container">
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
    </div>

    <div class="page-container">
        <!-- Título de la Página -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">Presidente de la Comisión Académica</h1>
                <p class="page-subtitle">Gestión de solicitudes de escalafón docente</p>
            </div>
        </div>

        <!-- Resumen de Solicitudes -->
        <div class="summary-cards">
            <div class="summary-card pending">
                <div class="summary-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <h3>@pendingSolicitudes</h3>
                    <p>Solicitudes Pendientes</p>
                </div>
            </div>
            
            <div class="summary-card approved">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h3>@approvedSolicitudes</h3>
                    <p>Solicitudes Aprobadas</p>
                </div>
            </div>
            
            <div class="summary-card approved">
                <div class="summary-icon" style="display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bell" style="font-size: 24px; color: #fff;"></i>
                </div>
                <div class="summary-content">
                    <h3>@verificatedSolicitudes</h3>
                    <p>Verificadas - Listas para Notificar</p>
                </div>
            </div>
            
            <div class="summary-card rejected">
                <div class="summary-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="summary-content">
                    <h3>@rejectedSolicitudes</h3>
                    <p>Solicitudes Rechazadas</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-container">
                <select class="form-select" @bind="selectedFilter">
                    <option value="all">Todas las Solicitudes</option>
                    <option value="pending">Pendientes</option>
                    <option value="approved">Aprobadas</option>
                    <option value="verificado">Verificadas - Listas para Notificar</option>
                    <option value="rejected">Rechazadas</option>
                </select>
                
                <input type="text" class="form-control" placeholder="Buscar por nombre o cédula..." @bind="searchTerm" @oninput="FilterSolicitudes" />
                
                <button class="btn btn-primary" @onclick="RefreshSolicitudes">
                    <i class="fas fa-refresh"></i> Actualizar
                </button>
            </div>
        </div>

        <!-- Lista de Solicitudes -->
        <div class="solicitudes-section">
            @if (filteredSolicitudes?.Any() == true)
            {
                @foreach (var solicitud in filteredSolicitudes)
                {
                    <div class="solicitud-card @GetStatusClass(solicitud.Status)">
                        <div class="solicitud-header">
                            <div class="solicitud-info">
                                <h4>@solicitud.DocenteNombre</h4>
                                <p class="solicitud-cedula">
                                    <i class="fas fa-id-card"></i> @solicitud.DocenteCedula
                                </p>
                                <p class="solicitud-fecha">
                                    <i class="fas fa-calendar"></i> Solicitado: @solicitud.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")
                                </p>
                            </div>
                            <div class="solicitud-status">
                                <span class="status-badge @GetStatusClass(solicitud.Status)">
                                    @GetStatusText(solicitud.Status)
                                </span>
                            </div>
                        </div>

                        <div class="solicitud-details">
                            <div class="detail-row">
                                <span class="detail-label">Nivel Actual:</span>
                                <span class="detail-value">@solicitud.NivelActual</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Nivel Solicitado:</span>
                                <span class="detail-value">@solicitud.NivelSolicitado</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Años de Experiencia:</span>
                                <span class="detail-value">@solicitud.AnosExperiencia años</span>
                            </div>
                        </div>

                        <div class="solicitud-actions">
                            <button class="btn btn-info" @onclick="() => VerDetalles(solicitud.Id)">
                                <i class="fas fa-eye"></i> Ver Detalles
                            </button>
                            
                            @if (solicitud.Status == "Pendiente")
                            {
                                <button class="btn btn-success" @onclick="() => AprobarSolicitud(solicitud.Id)">
                                    <i class="fas fa-check"></i> Aprobar
                                </button>
                                <button class="btn btn-danger" @onclick="() => RechazarSolicitud(solicitud.Id)">
                                    <i class="fas fa-times"></i> Rechazar
                                </button>
                            }
                            
                            @if (solicitud.Status == "Verificado")
                            {
                                <button class="btn btn-primary" @onclick="() => EnviarCorreoResultado(solicitud.Id, true)">
                                    <i class="fas fa-check-circle"></i> Notificar Aprobación
                                </button>
                                <button class="btn btn-warning" @onclick="() => EnviarCorreoResultado(solicitud.Id, false)">
                                    <i class="fas fa-times-circle"></i> Notificar Rechazo
                                </button>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-solicitudes">
                    <div class="no-solicitudes-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>No hay solicitudes</h3>
                    <p>No se encontraron solicitudes que coincidan con los filtros seleccionados.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal de Detalles -->
@if (showDetailsModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de la Solicitud de Escalafón</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedSolicitud != null)
                    {
                        <!-- Resumen de Cumplimiento de Requisitos -->
                        <div class="details-section">
                            <h6><i class="fas fa-clipboard-check"></i> Resumen de Cumplimiento de Requisitos</h6>
                            @if (estadisticasDocente?.Secciones != null)
                            {
                                <div class="requirements-summary">
                                    <div class="requirement-summary-item">
                                        <span class="requirement-name">Años de Experiencia</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Experiencia.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Experiencia.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <div class="requirement-summary-item">
                                        <span class="requirement-name">Publicaciones</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Obras.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Obras.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <div class="requirement-summary-item">
                                        <span class="requirement-name">Capacitaciones</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Capacitaciones.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Capacitaciones.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <div class="requirement-summary-item">
                                        <span class="requirement-name">Evaluación Desempeño</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Evaluaciones.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Evaluaciones.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <div class="overall-compliance">
                                        <span class="overall-label">Estado General:</span>
                                        <span class="overall-status @(estadisticasDocente.Resumen.PuedeSubirNivel ? "cumple-todos" : "no-cumple-todos")">
                                            @if (estadisticasDocente.Resumen.PuedeSubirNivel)
                                            {
                                                <i class="fas fa-check-circle"></i>
                                                <span>Cumple todos los requisitos (@estadisticasDocente.Resumen.RequisitosCumplidos/@estadisticasDocente.Resumen.TotalRequisitos)</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <span>No cumple todos los requisitos (@estadisticasDocente.Resumen.RequisitosCumplidos/@estadisticasDocente.Resumen.TotalRequisitos)</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Cargando estadísticas de requisitos...
                                </div>
                            }
                        </div>

                        <!-- Información Personal -->
                        <div class="details-section">
                            <h6><i class="fas fa-user"></i> Información Personal</h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr>
                                            <td><strong>Nombre Completo:</strong></td>
                                            <td>@selectedSolicitud.DocenteNombre</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Cédula:</strong></td>
                                            <td>@selectedSolicitud.DocenteCedula</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td>@selectedSolicitud.DocenteEmail</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Información Académica -->
                        <div class="details-section">
                            <h6><i class="fas fa-graduation-cap"></i> Información Académica</h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr>
                                            <td><strong>Nivel Actual:</strong></td>
                                            <td>@selectedSolicitud.NivelActual</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Nivel Solicitado:</strong></td>
                                            <td>@selectedSolicitud.NivelSolicitado</td>
                                        </tr>                        <tr>
                            <td><strong>Años de Experiencia:</strong></td>
                            <td>
                                @if (estadisticasDocente?.Secciones?.Experiencia?.Datos != null)
                                {
                                    <div class="requirement-item">
                                        <span>@estadisticasDocente.Secciones.Experiencia.Datos.AñosObtenidos años</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Experiencia.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Experiencia.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <small class="text-muted">Requerido: @estadisticasDocente.Secciones.Experiencia.Datos.AñosRequeridos años - @estadisticasDocente.Secciones.Experiencia.Datos.Detalles</small>
                                }
                                else
                                {
                                    <span>@selectedSolicitud.AnosExperiencia años</span>
                                    <small class="text-muted">Cargando información...</small>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Publicaciones:</strong></td>
                            <td>
                                @if (estadisticasDocente?.Secciones?.Obras?.Datos != null)
                                {
                                    <div class="requirement-item">
                                        <span>Total: @estadisticasDocente.Secciones.Obras.Datos.TotalObras obra(s). Con filiación UTA: @estadisticasDocente.Secciones.Obras.Datos.ObrasConUTA obra(s)</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Obras.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Obras.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <small class="text-muted">@estadisticasDocente.Secciones.Obras.Datos.Detalles</small>
                                }
                                else
                                {
                                    <span>@(string.IsNullOrEmpty(selectedSolicitud.Publicaciones) ? "No especificadas" : selectedSolicitud.Publicaciones)</span>
                                    <small class="text-muted">Cargando información...</small>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Capacitaciones:</strong></td>
                            <td>
                                @if (estadisticasDocente?.Secciones?.Capacitaciones?.Datos != null)
                                {
                                    <div class="requirement-item">
                                        <span>Total: @estadisticasDocente.Secciones.Capacitaciones.Datos.HorasObtenidas horas. Pedagógicas: @estadisticasDocente.Secciones.Capacitaciones.Datos.HorasPedagogicasObtenidas horas</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Capacitaciones.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Capacitaciones.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <small class="text-muted">Requerido: @estadisticasDocente.Secciones.Capacitaciones.Datos.HorasRequeridas horas totales (@estadisticasDocente.Secciones.Capacitaciones.Datos.HorasPedagogicasRequeridas pedagógicas)</small>
                                }
                                else
                                {
                                    <span>@(string.IsNullOrEmpty(selectedSolicitud.Capacitaciones) ? "No especificadas" : selectedSolicitud.Capacitaciones)</span>
                                    <small class="text-muted">Cargando información...</small>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Evaluación de Desempeño:</strong></td>
                            <td>
                                @if (estadisticasDocente?.Secciones?.Evaluaciones?.Datos != null)
                                {
                                    <div class="requirement-item">
                                        <span>Promedio: @estadisticasDocente.Secciones.Evaluaciones.Datos.PromedioObtenido% (@estadisticasDocente.Secciones.Evaluaciones.Datos.EvaluacionesAnalizadas evaluaciones)</span>
                                        <span class="requirement-status @(estadisticasDocente.Secciones.Evaluaciones.Datos.Cumple ? "cumple" : "no-cumple")">
                                            @if (estadisticasDocente.Secciones.Evaluaciones.Datos.Cumple)
                                            {
                                                <i class="fas fa-check"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times"></i>
                                            }
                                        </span>
                                    </div>
                                    <small class="text-muted">Requerido: @estadisticasDocente.Secciones.Evaluaciones.Datos.Requiere75% - @estadisticasDocente.Secciones.Evaluaciones.Datos.Detalles</small>
                                }
                                else
                                {
                                    <span>Cargando información...</span>
                                    <small class="text-muted">Evaluando desempeño...</small>
                                }
                            </td>
                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tabla de Investigación -->
                        <div class="details-section">
                            <h6><i class="fas fa-search"></i> Investigación</h6>
                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-book me-2"></i>Título</th>
                                            <th><i class="fas fa-flask me-2"></i>Área</th>
                                            <th><i class="fas fa-tag me-2"></i>Tipo</th>
                                            <th><i class="fas fa-chart-line me-2"></i>Estado</th>
                                            <th><i class="fas fa-calendar me-2"></i>Fecha Pub.</th>
                                            <th><i class="fas fa-university me-2"></i>Filiación</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (GetInvestigacionesDocente(selectedSolicitud).Any())
                                        {
                                            @foreach (var investigacion in GetInvestigacionesDocente(selectedSolicitud))
                                            {
                                                <tr>
                                                    <td class="col-title">
                                                        <div class="fw-medium">@investigacion.Titulo</div>
                                                        @if (!string.IsNullOrEmpty(investigacion.RevistaOEditorial))
                                                        {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="fas fa-newspaper me-1"></i>@investigacion.RevistaOEditorial
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge info">
                                                            <i class="fas fa-atom"></i>
                                                            @investigacion.CampoConocimiento
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge secondary">
                                                            @investigacion.Tipo
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge success">
                                                            <i class="fas fa-check-circle"></i>
                                                            Publicado
                                                        </span>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        @investigacion.FechaPublicacion.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(investigacion.Filiacion))
                                                        {
                                                            <span class="table-badge @(investigacion.Filiacion.Contains("UTA", StringComparison.OrdinalIgnoreCase) || investigacion.Filiacion.Contains("Universidad Técnica de Ambato", StringComparison.OrdinalIgnoreCase) ? "success" : "secondary")">
                                                                @if (investigacion.Filiacion.Contains("UTA", StringComparison.OrdinalIgnoreCase) || investigacion.Filiacion.Contains("Universidad Técnica de Ambato", StringComparison.OrdinalIgnoreCase))
                                                                {
                                                                    <i class="fas fa-check-circle"></i>
                                                                }
                                                                @investigacion.Filiacion
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">
                                                                <i class="fas fa-minus-circle me-1"></i>Sin filiación
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            @if (investigacion.TienePdf)
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdf(investigacion.Id)" title="Ver PDF">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </span>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="7" class="empty-state">
                                                    <i class="fas fa-search"></i>
                                                    <h6>No hay investigaciones registradas</h6>
                                                    <p>No se encontraron investigaciones para este docente</p>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tabla de Evaluación -->
                        <div class="details-section">
                            <h6><i class="fas fa-chart-line"></i> Evaluación de Desempeño</h6>
                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-calendar-alt me-2"></i>Período</th>
                                            <th><i class="fas fa-calendar me-2"></i>Año</th>
                                            <th><i class="fas fa-list-ol me-2"></i>Sem.</th>
                                            <th><i class="fas fa-chart-bar me-2"></i>Puntaje</th>
                                            <th><i class="fas fa-percentage me-2"></i>Porcentaje</th>
                                            <th><i class="fas fa-check-circle me-2"></i>Estado</th>
                                            <th><i class="fas fa-clock me-2"></i>Fecha Eval.</th>
                                            <th><i class="fas fa-user-tie me-2"></i>Evaluador</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (GetEvaluacionesDocente(selectedSolicitud).Any())
                                        {
                                            @foreach (var evaluacion in GetEvaluacionesDocente(selectedSolicitud))
                                            {
                                                <tr>
                                                    <td class="fw-medium">
                                                        <i class="fas fa-graduation-cap me-2 text-primary"></i>
                                                        @evaluacion.PeriodoAcademico
                                                    </td>
                                                    <td class="col-date">
                                                        <span class="table-badge info">@evaluacion.Anio</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="table-badge secondary">@evaluacion.Semestre</span>
                                                    </td>
                                                    <td class="col-score">
                                                        <div class="fw-bold">@evaluacion.PuntajeObtenido</div>
                                                        <small class="text-muted">/ @evaluacion.PuntajeMaximo</small>
                                                    </td>
                                                    <td class="col-score">
                                                        <span class="table-badge @(evaluacion.PorcentajeObtenido >= 90 ? "success" : evaluacion.PorcentajeObtenido >= 75 ? "warning" : "danger")">
                                                            <i class="fas @(evaluacion.PorcentajeObtenido >= 90 ? "fa-trophy" : evaluacion.PorcentajeObtenido >= 75 ? "fa-star" : "fa-exclamation-triangle")"></i>
                                                            @evaluacion.PorcentajeObtenido.ToString("F1")%
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(evaluacion.CumpleMinimo ? "success" : "danger")">
                                                            <i class="fas @(evaluacion.CumpleMinimo ? "fa-check" : "fa-times")"></i>
                                                            @evaluacion.Estado
                                                        </span>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        @evaluacion.FechaEvaluacion.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(evaluacion.Evaluador))
                                                        {
                                                            <div class="fw-medium">@evaluacion.Evaluador</div>
                                                            <small class="text-muted">@evaluacion.TipoEvaluacion</small>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">
                                                                <i class="fas fa-user-slash me-1"></i>Sin asignar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            @if (!string.IsNullOrEmpty(evaluacion.NombreArchivoRespaldo))
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdfEvaluacion(evaluacion.Id)" title="Ver PDF">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </span>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="empty-state">
                                                    <i class="fas fa-star"></i>
                                                    <h6>No hay evaluaciones de desempeño registradas</h6>
                                                    <p>No se encontraron evaluaciones para este docente</p>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tabla de Capacitación -->
                        <div class="details-section">
                            <h6><i class="fas fa-graduation-cap"></i> Capacitación y Formación</h6>
                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-graduation-cap me-2"></i>Nombre</th>
                                            <th><i class="fas fa-university me-2"></i>Institución</th>
                                            <th><i class="fas fa-tag me-2"></i>Tipo</th>
                                            <th><i class="fas fa-laptop me-2"></i>Modalidad</th>
                                            <th><i class="fas fa-clock me-2"></i>Horas</th>
                                            <th><i class="fas fa-calendar-plus me-2"></i>Fecha Inicio</th>
                                            <th><i class="fas fa-calendar-check me-2"></i>Fecha Fin</th>
                                            <th><i class="fas fa-chart-line me-2"></i>Estado</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (GetCapacitacionesDocente(selectedSolicitud).Any())
                                        {
                                            @foreach (var capacitacion in GetCapacitacionesDocente(selectedSolicitud))
                                            {
                                                <tr>
                                                    <td class="col-title">
                                                        <div class="fw-medium">@capacitacion.NombreCapacitacion</div>
                                                        @if (!string.IsNullOrEmpty(capacitacion.Descripcion))
                                                        {
                                                            <small class="text-muted d-block mt-1" title="@capacitacion.Descripcion">
                                                                <i class="fas fa-info-circle me-1"></i>@capacitacion.Descripcion.Substring(0, Math.Min(50, capacitacion.Descripcion.Length))...
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="fw-medium">@capacitacion.Institucion</div>
                                                        @if (!string.IsNullOrEmpty(capacitacion.Instructor))
                                                        {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="fas fa-user-tie me-1"></i>@capacitacion.Instructor
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(capacitacion.EsPedagogica ? "success" : "info")">
                                                            <i class="fas @(capacitacion.EsPedagogica ? "fa-chalkboard-teacher" : "fa-cogs")"></i>
                                                            @capacitacion.TipoCapacitacion
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge secondary">
                                                            <i class="fas @(capacitacion.Modalidad.Contains("Virtual", StringComparison.OrdinalIgnoreCase) ? "fa-laptop" : capacitacion.Modalidad.Contains("Presencial", StringComparison.OrdinalIgnoreCase) ? "fa-users" : "fa-sync-alt")"></i>
                                                            @capacitacion.Modalidad
                                                        </span>
                                                    </td>
                                                    <td class="col-score">
                                                        <div class="fw-bold text-primary">@capacitacion.HorasAcademicas</div>
                                                        <small class="text-muted">horas</small>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        @capacitacion.FechaInicio.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        @capacitacion.FechaFin.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(capacitacion.Estado?.ToLower() switch { "aprobada" or "completada" => "success", "en progreso" => "warning", "reprobada" => "danger", _ => "secondary" })">
                                                            <i class="fas @(capacitacion.Estado?.ToLower() switch { "aprobada" or "completada" => "fa-check-circle", "en progreso" => "fa-clock", "reprobada" => "fa-times-circle", _ => "fa-question-circle" })"></i>
                                                            @capacitacion.Estado
                                                        </span>
                                                        @if (capacitacion.Calificacion.HasValue)
                                                        {
                                                            <div class="mt-1">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-star me-1"></i>@capacitacion.Calificacion.Value.ToString("F1")
                                                                </small>
                                                            </div>
                                                        }
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            @if (!string.IsNullOrEmpty(capacitacion.NombreArchivoCertificado))
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdfCapacitacion(capacitacion.Id)" title="Ver Certificado">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </span>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="empty-state">
                                                    <i class="fas fa-search"></i>
                                                    <h6>No hay capacitaciones registradas</h6>
                                                    <p>No se encontraron capacitaciones para este docente</p>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Información de la Solicitud -->
                        <div class="details-section">
                            <h6><i class="fas fa-file-alt"></i> Información de la Solicitud</h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr>
                                            <td><strong>Fecha de Solicitud:</strong></td>
                                            <td>@selectedSolicitud.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Estado:</strong></td>
                                            <td>
                                                <span class="status-badge @GetStatusClass(selectedSolicitud.Status)">
                                                    @GetStatusText(selectedSolicitud.Status)
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Observaciones:</strong></td>
                                            <td>@(string.IsNullOrEmpty(selectedSolicitud.Observaciones) ? "Sin observaciones" : selectedSolicitud.Observaciones)</td>
                                        </tr>
                                        @if (!string.IsNullOrEmpty(selectedSolicitud.MotivoRechazo))
                                        {
                                            <tr>
                                                <td><strong>Motivo de Rechazo:</strong></td>
                                                <td>@selectedSolicitud.MotivoRechazo</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (selectedSolicitud?.Status == "Pendiente")
                    {
                        <button type="button" class="btn btn-success" @onclick="() => AprobarSolicitud(selectedSolicitud.Id)">
                            <i class="fas fa-check"></i> Aprobar
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="() => RechazarSolicitud(selectedSolicitud.Id)">
                            <i class="fas fa-times"></i> Rechazar
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Modal de Rechazo -->
@if (showRejectModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechazar Solicitud</h5>
                    <button type="button" class="btn-close" @onclick="CloseRejectModal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea rechazar esta solicitud de escalafón?</p>
                    <div class="mb-3">
                        <label class="form-label">Motivo del rechazo:</label>
                        <textarea class="form-control" rows="3" @bind="motivoRechazo" placeholder="Ingrese el motivo del rechazo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" @onclick="ConfirmReject">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseRejectModal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<SolicitudEscalafon> solicitudes = new();
    private List<SolicitudEscalafon> filteredSolicitudes = new();
    private SolicitudEscalafon? selectedSolicitud;
    
    private string selectedFilter = "all";
    private string searchTerm = "";
    private string motivoRechazo = "";
    
    private bool showDetailsModal = false;
    private bool showRejectModal = false;
    private int selectedSolicitudId = 0;
    
    private int pendingSolicitudes = 0;
    private int approvedSolicitudes = 0;
    private int rejectedSolicitudes = 0;
    private int verificatedSolicitudes = 0;
    
    // Datos reales de la API
    private List<proyectoAgiles.Services.InvestigacionDto> investigaciones = new();
    private List<proyectoAgiles.Services.EvaluacionDesempenoDto> evaluaciones = new();
    private List<ProyectoAgiles.Application.DTOs.DiticDto> capacitaciones = new();
    private proyectoAgiles.Services.EstadisticasDocenteResponse? estadisticasDocente;

    protected override async Task OnInitializedAsync()
    {
        await UserSession.InitializeAsync();
        
        if (UserSession.CurrentUser == null || UserSession.CurrentUser.UserType != 1)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadSolicitudes();
    }

    private async Task LoadSolicitudes()
    {
        try
        {
            // Cargar solicitudes desde la API
            var response = await HttpClient.GetAsync("/api/solicitudes-escalafon");
            
            if (response.IsSuccessStatusCode)
            {
                var solicitudesDto = await response.Content.ReadFromJsonAsync<List<ProyectoAgiles.Application.DTOs.SolicitudEscalafonDto>>();
                
                if (solicitudesDto != null)
                {
                    // Convertir DTOs a modelo local
                    solicitudes = solicitudesDto.Select(dto => new SolicitudEscalafon
                    {
                        Id = dto.Id,
                        DocenteNombre = dto.DocenteNombre,
                        DocenteCedula = dto.DocenteCedula,
                        DocenteEmail = dto.DocenteEmail,
                        DocenteTelefono = dto.DocenteTelefono ?? "",
                        Facultad = dto.Facultad ?? "",
                        Carrera = dto.Carrera ?? "",
                        NivelActual = dto.NivelActual,
                        NivelSolicitado = dto.NivelSolicitado,
                        AnosExperiencia = dto.AnosExperiencia,
                        Titulos = dto.Titulos ?? "",
                        Publicaciones = dto.Publicaciones ?? "",
                        Capacitaciones = dto.Capacitaciones ?? "",
                        FechaSolicitud = dto.FechaSolicitud,
                        FechaAprobacion = dto.FechaAprobacion,
                        FechaRechazo = dto.FechaRechazo,
                        Status = dto.Status,
                        Observaciones = dto.Observaciones ?? "",
                        MotivoRechazo = dto.MotivoRechazo ?? ""
                    }).ToList();
                }
                else
                {
                    solicitudes = new List<SolicitudEscalafon>();
                }
            }
            else
            {
                // En caso de error de API, inicializar lista vacía
                solicitudes = new List<SolicitudEscalafon>();
                await JSRuntime.InvokeVoidAsync("console.error", $"Error loading solicitudes: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            // En caso de error, inicializar lista vacía
            solicitudes = new List<SolicitudEscalafon>();
            await JSRuntime.InvokeVoidAsync("console.error", $"Exception loading solicitudes: {ex.Message}");
        }

        FilterSolicitudes();
        UpdateSummary();
    }

    private void FilterSolicitudes()
    {
        // EXCLUIR las apelaciones - estas solo las ve la Comisión Académica de Escalafón
        // EXCLUIR también las rechazadas por la Comisión Académica de Escalafón (después de procesar apelaciones)
        // EXCLUIR también las procesadas por Talento Humano
        var solicitudesFiltradas = solicitudes.Where(s => s.Status != "Apelacion" && s.Status != "RechazadoComision" && s.Status != "Procesado");
        
        filteredSolicitudes = solicitudesFiltradas.Where(s => 
            (selectedFilter == "all" || 
             (selectedFilter == "pending" && s.Status == "Pendiente") ||
             (selectedFilter == "approved" && s.Status == "Aprobado") ||
             (selectedFilter == "verificado" && s.Status == "Verificado") ||
             (selectedFilter == "rejected" && s.Status == "RechazadoPresidente")) &&
            (string.IsNullOrEmpty(searchTerm) || 
             s.DocenteNombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             s.DocenteCedula.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        ).ToList();
    }

    private void UpdateSummary()
    {
        // Contar solo las solicitudes que no sean apelaciones, rechazadas por la Comisión, ni procesadas por Talento Humano
        var solicitudesSinApelaciones = solicitudes.Where(s => s.Status != "Apelacion" && s.Status != "RechazadoComision" && s.Status != "Procesado");
        
        pendingSolicitudes = solicitudesSinApelaciones.Count(s => s.Status == "Pendiente");
        approvedSolicitudes = solicitudesSinApelaciones.Count(s => s.Status == "Aprobado");
        rejectedSolicitudes = solicitudesSinApelaciones.Count(s => s.Status == "RechazadoPresidente");
        verificatedSolicitudes = solicitudesSinApelaciones.Count(s => s.Status == "Verificado");
    }

    private async Task VerDetalles(int solicitudId)
    {
        selectedSolicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
        if (selectedSolicitud != null)
        {
            // Cargar datos del docente desde la API
            await CargarDatosDocente(selectedSolicitud.DocenteCedula);
        }
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedSolicitud = null;
    }

    private async Task AprobarSolicitud(int solicitudId)
    {
        try
        {
            var updateDto = new UpdateSolicitudStatusDto
            {
                Id = solicitudId,
                Status = "Aprobado"
            };

            var response = await HttpClient.PutAsJsonAsync($"/api/solicitudes-escalafon/{solicitudId}/status", updateDto);
            
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                    "Solicitud Aprobada", 
                    "La solicitud de escalafón ha sido aprobada exitosamente.");
                
                await LoadSolicitudes();
                CloseDetailsModal();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "Error", 
                    "No se pudo aprobar la solicitud. Inténtalo más tarde.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al aprobar la solicitud: {ex.Message}");
        }
    }

    private void RechazarSolicitud(int solicitudId)
    {
        selectedSolicitudId = solicitudId;
        showRejectModal = true;
    }

    private async Task ConfirmReject()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(motivoRechazo))
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.warning", 
                    "Motivo Requerido", 
                    "Debe proporcionar un motivo para rechazar la solicitud.");
                return;
            }

            // Usar el nuevo endpoint de rechazo con motivo
            var rechazarDto = new { 
                MotivoRechazo = motivoRechazo,
                RechazadoPor = "Presidente de la Comisión Académica",
                NivelRechazo = "PresidenteComision"
            };

            var response = await HttpClient.PostAsJsonAsync($"/api/solicitudes-escalafon/{selectedSolicitudId}/rechazar", rechazarDto);
            
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                    "Solicitud Rechazada", 
                    "La solicitud de escalafón ha sido rechazada. Se ha enviado un email al docente con el motivo del rechazo.");
                
                await LoadSolicitudes();
                CloseRejectModal();
                CloseDetailsModal();
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "Error", 
                    $"No se pudo rechazar la solicitud: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al rechazar la solicitud: {ex.Message}");
        }
    }

    private void CloseRejectModal()
    {
        showRejectModal = false;
        motivoRechazo = "";
        selectedSolicitudId = 0;
    }

    private async Task RefreshSolicitudes()
    {
        await LoadSolicitudes();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/admin/talento-humano");
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Pendiente" => "pending",
            "Aprobado" => "approved",
            "Verificado" => "processed",
            "AprobadoPresidente" => "finalized",
            "RechazadoPresidente" => "rejected",
            _ => ""
        };
    }

    private string GetStatusText(string status)
    {
        return status switch
        {
            "Pendiente" => "Pendiente",
            "Aprobado" => "Aprobado",
            "Verificado" => "Verificado - Listo para Notificar",
            "AprobadoPresidente" => "Aprobado - Generando Informe",
            "RechazadoPresidente" => "Rechazado",
            _ => status
        };
    }

    // Método para cargar datos del docente desde la API
    private async Task CargarDatosDocente(string cedula)
    {
        try
        {
            // Limpiar datos anteriores
            investigaciones.Clear();
            evaluaciones.Clear();
            capacitaciones.Clear();
            estadisticasDocente = null;

            // Cargar investigaciones
            await CargarInvestigaciones(cedula);
            
            // Cargar evaluaciones
            await CargarEvaluaciones(cedula);
            
            // Cargar capacitaciones
            await CargarCapacitaciones(cedula);
            
            // Obtener estadísticas actualizadas del docente (incluye requisitos)
            estadisticasDocente = await AuthService.ObtenerEstadisticasDocente(cedula);
            
            // Actualizar datos de la solicitud con las estadísticas
            await ActualizarEstadisticasSolicitud(cedula);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error cargando datos del docente: {ex.Message}");
        }
    }
    
    // Método para actualizar las estadísticas de la solicitud con datos reales
    private async Task ActualizarEstadisticasSolicitud(string cedula)
    {
        try
        {
            if (selectedSolicitud == null || estadisticasDocente?.Secciones == null) return;
            
            // Actualizar años de experiencia
            if (estadisticasDocente.Secciones.Experiencia?.Datos != null)
            {
                selectedSolicitud.AnosExperiencia = (int)Math.Round(estadisticasDocente.Secciones.Experiencia.Datos.AñosObtenidos);
            }
            
            // Actualizar publicaciones
            if (estadisticasDocente.Secciones.Obras?.Datos != null)
            {
                var datos = estadisticasDocente.Secciones.Obras.Datos;
                selectedSolicitud.Publicaciones = $"Total: {datos.TotalObras} obra(s) registrada(s). Con filiación UTA: {datos.ObrasConUTA} obra(s).";
            }
            
            // Actualizar capacitaciones
            if (estadisticasDocente.Secciones.Capacitaciones?.Datos != null)
            {
                var datos = estadisticasDocente.Secciones.Capacitaciones.Datos;
                selectedSolicitud.Capacitaciones = $"Total: {datos.HorasObtenidas} horas de capacitación. Horas pedagógicas: {datos.HorasPedagogicasObtenidas} horas.";
            }
            
            // Forzar actualización de la UI
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error actualizando estadísticas: {ex.Message}");
        }
    }

    private async Task CargarInvestigaciones(string cedula)
    {
        try
        {
            var response = await AuthService.GetInvestigacionesPorCedula(cedula);
            if (response != null)
            {
                investigaciones = response.ToList();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error cargando investigaciones: {ex.Message}");
        }
    }

    private async Task CargarEvaluaciones(string cedula)
    {
        try
        {
            var response = await AuthService.GetEvaluacionesPorCedula(cedula);
            if (response != null)
            {
                evaluaciones = response.ToList();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error cargando evaluaciones: {ex.Message}");
        }
    }

    private async Task CargarCapacitaciones(string cedula)
    {
        try
        {
            var response = await AuthService.GetCapacitacionesPorCedula(cedula);
            if (response != null)
            {
                capacitaciones = response.ToList();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error cargando capacitaciones: {ex.Message}");
        }
    }

    // Métodos para obtener datos de las tablas
    private List<proyectoAgiles.Services.InvestigacionDto> GetInvestigacionesDocente(SolicitudEscalafon solicitud)
    {
        return investigaciones;
    }

    private List<proyectoAgiles.Services.EvaluacionDesempenoDto> GetEvaluacionesDocente(SolicitudEscalafon solicitud)
    {
        return evaluaciones;
    }

    private List<ProyectoAgiles.Application.DTOs.DiticDto> GetCapacitacionesDocente(SolicitudEscalafon solicitud)
    {
        return capacitaciones;
    }
    
    // Métodos para ver PDFs
    private async Task VerPdf(int investigacionId)
    {
        try
        {
            var pdfBytes = await AuthService.ObtenerPdfInvestigacion(investigacionId);
            
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"investigacion_{investigacionId}.pdf";
                
                // Usar la función JavaScript personalizada
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                
                if (!success)
                {
                    await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                        "PDF descargado", 
                        "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "PDF no disponible", 
                    "No se encontró el archivo PDF para esta investigación.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al obtener el PDF: {ex.Message}");
        }
    }

    private async Task VerPdfEvaluacion(int evaluacionId)
    {
        try
        {
            var pdfBytes = await AuthService.ObtenerPdfEvaluacion(evaluacionId);
            
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"evaluacion_{evaluacionId}.pdf";
                
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                
                if (!success)
                {
                    await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                        "PDF descargado", 
                        "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "PDF no disponible", 
                    "No se encontró el archivo PDF para esta evaluación.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al obtener el PDF: {ex.Message}");
        }
    }

    private async Task VerPdfCapacitacion(int capacitacionId)
    {
        try
        {
            var pdfBytes = await AuthService.ObtenerPdfCapacitacion(capacitacionId);
            
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"capacitacion_{capacitacionId}.pdf";
                
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                
                if (!success)
                {
                    await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                        "PDF descargado", 
                        "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "PDF no disponible", 
                    "No se encontró el archivo PDF para esta capacitación.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al obtener el PDF: {ex.Message}");
        }
    }

    // Método para enviar correo de resultado
    private async Task EnviarCorreoResultado(int solicitudId, bool aprobado)
    {
        try
        {
            var solicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
            if (solicitud == null) return;

            // Actualizar el estado de la solicitud
            var nuevoEstado = aprobado ? "AprobadoPresidente" : "RechazadoPresidente";
            var updateDto = new { Id = solicitudId, Status = nuevoEstado };
            var response = await HttpClient.PutAsJsonAsync($"/api/solicitudes-escalafon/{solicitudId}/status", updateDto);
            
            if (response.IsSuccessStatusCode)
            {
                if (aprobado)
                {
                    // Si es aprobado, enviar notificación por correo
                    try
                    {
                        var emailResponse = await HttpClient.PostAsync($"/api/solicitudes-escalafon/{solicitudId}/notificar-aprobacion", null);
                        if (emailResponse.IsSuccessStatusCode)
                        {
                            await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                                "Solicitud Aprobada y Notificada", 
                                $"La solicitud ha sido aprobada y se ha enviado la notificación por correo a {solicitud.DocenteEmail}");
                        }
                        else
                        {
                            await JSRuntime.InvokeVoidAsync("toastNotifications.warning", 
                                "Solicitud Aprobada", 
                                "La solicitud ha sido aprobada, pero no se pudo enviar el correo de notificación.");
                        }
                    }
                    catch (Exception emailEx)
                    {
                        await JSRuntime.InvokeVoidAsync("toastNotifications.warning", 
                            "Solicitud Aprobada", 
                            $"La solicitud ha sido aprobada, pero hubo un error enviando el correo: {emailEx.Message}");
                    }
                }
                else
                {
                    // Si es rechazado, mostrar notificación (podrías implementar un endpoint similar para rechazos)
                    await JSRuntime.InvokeVoidAsync("toastNotifications.success", 
                        "Solicitud Rechazada", 
                        $"La solicitud ha sido rechazada. Se debería notificar a {solicitud.DocenteEmail}");
                }
                
                // Actualizar la lista de solicitudes
                await LoadSolicitudes();
                FilterSolicitudes();
                UpdateSummary();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                    "Error", 
                    "No se pudo actualizar el estado de la solicitud.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("toastNotifications.error", 
                "Error", 
                $"Error al procesar solicitud: {ex.Message}");
        }
    }

    public class SolicitudEscalafon
    {
        public int Id { get; set; }
        public string DocenteNombre { get; set; } = "";
        public string DocenteCedula { get; set; } = "";
        public string DocenteEmail { get; set; } = "";
        public string DocenteTelefono { get; set; } = "";
        public string Facultad { get; set; } = "";
        public string Carrera { get; set; } = "";
        public string NivelActual { get; set; } = "";
        public string NivelSolicitado { get; set; } = "";
        public int AnosExperiencia { get; set; }
        public string Titulos { get; set; } = "";
        public string Publicaciones { get; set; } = "";
        public string Capacitaciones { get; set; } = "";
        public DateTime FechaSolicitud { get; set; }
        public DateTime? FechaAprobacion { get; set; }
        public DateTime? FechaRechazo { get; set; }
        public string Status { get; set; } = "";
        public string Observaciones { get; set; } = "";
        public string MotivoRechazo { get; set; } = "";
    }
}
