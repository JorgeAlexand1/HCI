@page "/docente"
@using Microsoft.AspNetCore.Components.Web
@using System.Text.Json
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using System.Reflection
@using proyectoAgiles.Services
@using static proyectoAgiles.Services.AuthService
@using ProyectoAgiles.Application.DTOs
@using ProyectoAgiles.Domain.Entities
@layout proyectoAgiles.Layout.MainLayout
@inject NavigationManager Navigation
@inject proyectoAgiles.Services.AuthService AuthService
@inject UserSessionService UserSession
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient

<PageTitle>Panel de Docente - UTA</PageTitle>

<div class="teacher-dashboard">
    <!-- Alerta de Estado de Configuración -->
    @if (!isTimeConfigurationActive)
    {
        <div class="alert alert-warning mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Período Inactivo:</strong> Las solicitudes de escalafón están temporalmente deshabilitadas. 
            El administrador debe activar un período de solicitudes para procesar escalafones.
        </div>
    }
    else
    {
        <div class="alert alert-success mb-4">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Período Activo:</strong> Las solicitudes de escalafón están habilitadas.
            </div>
            @if (currentTimeConfig != null)
            {
                <div class="period-info-horizontal">
                    @if (!string.IsNullOrEmpty(currentTimeConfig.Description))
                    {
                        <div class="period-item">
                            <span class="period-label">Descripción:</span>
                            <span class="period-value">@currentTimeConfig.Description</span>
                        </div>
                    }
                    <div class="period-item">
                        <span class="period-label">Período Vigente:</span>
                        <span class="period-value">@currentTimeConfig.StartDate.ToString("dd/MM/yyyy") - @currentTimeConfig.EndDate.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="period-item">
                        <span class="period-label">Días Restantes:</span>
                        <span class="period-value @(GetDaysRemaining() <= 7 ? "text-danger" : "text-success")">
                            @GetDaysRemaining() días
                        </span>
                    </div>
                    <div class="period-item">
                        <span class="period-label">Estado:</span>
                        <span class="badge bg-success">Activo</span>
                    </div>
                </div>
            }
        </div>
    }
    
    <!-- Sección de Nivel - Diseño Mejorado para Pantalla Completa -->
    <div class="nivel-section-fullwidth">
        <div class="nivel-container">
            <!-- Información del Nivel Actual -->
            <div class="nivel-info-section">
                <div class="nivel-header">
                    <h4 class="nivel-title">
                        <i class="fas fa-graduation-cap"></i>
                        Nivel Académico Actual
                    </h4>
                </div>
                <div class="nivel-badge-section">
                    <span class="nivel-badge-main">@UserSession.GetUserNivel()</span>
                </div>
            </div>

            <!-- Acciones del Nivel -->
            <div class="nivel-actions-section">
                <div class="actions-grid">
                    <button class="btn @(isTimeConfigurationActive ? "btn-success" : "btn-secondary") nivel-btn-primary" 
                            @onclick="ShowRequisitosModal" 
                            disabled="@(!isTimeConfigurationActive || isCheckingTimeConfiguration)">
                        <div class="btn-content">
                            @if (isCheckingTimeConfiguration)
                            {
                                <i class="fas fa-spinner fa-spin"></i>
                            }
                            else if (isTimeConfigurationActive)
                            {
                                <i class="fas fa-arrow-up"></i>
                            }
                            else
                            {
                                <i class="fas fa-lock"></i>
                            }
                            <span class="btn-text">
                                @if (isCheckingTimeConfiguration)
                                {
                                    <text>Verificando...</text>
                                }
                                else if (!isTimeConfigurationActive)
                                {
                                    <text>Período Inactivo</text>
                                }
                                else if (configuracionRequisitos != null)
                                {
                                    <text>Ascender a @configuracionRequisitos.NivelObjetivo</text>
                                }
                                else
                                {
                                    <text>Subir de Nivel</text>
                                }
                            </span>
                        </div>
                    </button>
                    
                    <button class="btn btn-info nivel-btn-secondary" @onclick="ShowHistorialModal">
                        <div class="btn-content">
                            <i class="fas fa-history"></i>
                            <span class="btn-text">Ver Historial</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (showRequisitosModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-level-up-alt me-2"></i>
                            @if (configuracionRequisitos != null)
                            {
                                @($"Requisitos para subir de nivel - {configuracionRequisitos.NivelObjetivo}")
                            }
                            else
                            {
                                @("Requisitos para subir de nivel")
                            }
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseRequisitosModal"></button>
                    </div>
                    <div class="modal-body">
                        @if (!isTimeConfigurationActive)
                        {
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Período Inactivo:</strong> Las solicitudes de escalafón están temporalmente deshabilitadas. 
                                El administrador debe configurar un período activo para procesar solicitudes.
                            </div>
                        }
                        @if (isLoadingRequisitos)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Verificando requisitos...</span>
                                </div>
                                <p class="mt-3">Verificando requisitos...</p>
                            </div>
                        }
                        else if (requisitosEscalafonDinamicos is not null)
                        {
                            <!-- Resultado de verificación dinámica -->
                            <div class="alert @(requisitosEscalafonDinamicos.CumpleTodosRequisitos ? "alert-success" : "alert-warning") mb-4">
                                <h6 class="alert-heading mb-2">
                                    @if (requisitosEscalafonDinamicos.CumpleTodosRequisitos)
                                    {
                                        <i class="fas fa-check-circle me-2"></i>@("¡FELICIDADES!")
                                    }
                                    else
                                    {
                                        <i class="fas fa-exclamation-triangle me-2"></i>@("REQUISITOS PENDIENTES")
                                    }
                                </h6>
                                <p class="mb-0">@requisitosEscalafonDinamicos.Mensaje</p>
                                <small class="text-muted">Verificación realizada el: @requisitosEscalafonDinamicos.FechaVerificacion.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>

                            <!-- Detalles de cada requisito dinámico -->
                            <div class="row">
                                <div class="col-12">
                                    <!-- Requisito de Experiencia -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex align-items-center">
                                            @if (requisitosEscalafonDinamicos.Experiencia.Cumple)
                                            {
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times-circle text-danger me-2"></i>
                                            }
                                            <strong>1. Experiencia Mínima</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">@requisitosEscalafonDinamicos.Experiencia.Mensaje</p>
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Valor obtenido:</small>
                                                    <div>@requisitosEscalafonDinamicos.Experiencia.ValorObtenido</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Requerido:</small>
                                                    <div>@requisitosEscalafonDinamicos.Experiencia.ValorRequerido</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Requisito de Obras Relevantes -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex align-items-center">
                                            @if (requisitosEscalafonDinamicos.ObrasRelevantes.Cumple)
                                            {
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times-circle text-danger me-2"></i>
                                            }
                                            <strong>2. Obras Relevantes/Artículos Indexados</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">@requisitosEscalafonDinamicos.ObrasRelevantes.Mensaje</p>
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Valor obtenido:</small>
                                                    <div>@requisitosEscalafonDinamicos.ObrasRelevantes.ValorObtenido</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Requerido:</small>
                                                    <div>@requisitosEscalafonDinamicos.ObrasRelevantes.ValorRequerido</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Requisito de Evaluación de Desempeño -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex align-items-center">
                                            @if (requisitosEscalafonDinamicos.EvaluacionDesempeno.Cumple)
                                            {
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times-circle text-danger me-2"></i>
                                            }
                                            <strong>3. Evaluación de Desempeño</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">@requisitosEscalafonDinamicos.EvaluacionDesempeno.Mensaje</p>
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Valor obtenido:</small>
                                                    <div>@requisitosEscalafonDinamicos.EvaluacionDesempeno.ValorObtenido</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Requerido:</small>
                                                    <div>@requisitosEscalafonDinamicos.EvaluacionDesempeno.ValorRequerido</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Requisito de Capacitación -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex align-items-center">
                                            @if (requisitosEscalafonDinamicos.Capacitacion.Cumple)
                                            {
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-times-circle text-danger me-2"></i>
                                            }
                                            <strong>4. Capacitación</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-2">@requisitosEscalafonDinamicos.Capacitacion.Mensaje</p>
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Valor obtenido:</small>
                                                    <div>@requisitosEscalafonDinamicos.Capacitacion.ValorObtenido</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <small class="text-muted">Requerido:</small>
                                                    <div>@requisitosEscalafonDinamicos.Capacitacion.ValorRequerido</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Requisito de Proyectos de Investigación (si aplica) -->
                                    @if (requisitosEscalafonDinamicos.ProyectosInvestigacion != null)
                                    {
                                        <div class="card mb-3">
                                            <div class="card-header d-flex align-items-center">
                                                @if (requisitosEscalafonDinamicos.ProyectosInvestigacion.Cumple)
                                                {
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                }
                                                <strong>5. Proyectos de Investigación</strong>
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-2">@requisitosEscalafonDinamicos.ProyectosInvestigacion.Mensaje</p>
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <small class="text-muted">Valor obtenido:</small>
                                                        <div>@requisitosEscalafonDinamicos.ProyectosInvestigacion.ValorObtenido</div>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <small class="text-muted">Requerido:</small>
                                                        <div>@requisitosEscalafonDinamicos.ProyectosInvestigacion.ValorRequerido</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Lista inicial de requisitos dinámicos -->
                            <div class="alert alert-info mb-4">
                                <h6 class="alert-heading">
                                    @if (configuracionRequisitos != null)
                                    {
                                        @($"Requisitos para ascender a {configuracionRequisitos.NivelObjetivo}")
                                    }
                                    else
                                    {
                                        @("Requisitos para ascender")
                                    }
                                </h6>
                                <p class="mb-0">Haz clic en "Verificar requisitos" para comprobar si cumples con todos los requisitos necesarios.</p>
                            </div>

                            @if (configuracionRequisitos != null)
                            {
                                <div class="accordion" id="requisitosAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOne">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                                <strong>1. Experiencia mínima (@configuracionRequisitos.AnosExperienciaRequeridos años)</strong>
                                            </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#requisitosAccordion">
                                            <div class="accordion-body">
                                                @configuracionRequisitos.DescripcionExperiencia
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingTwo">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                                <strong>2. Obra relevante o artículo indexado (@configuracionRequisitos.ObrasRelevantesConUTA con filiación UTA)</strong>
                                            </button>
                                        </h2>
                                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#requisitosAccordion">
                                            <div class="accordion-body">
                                                @configuracionRequisitos.DescripcionObras
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingThree">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                                <strong>3. Evaluación @configuracionRequisitos.PorcentajeEvaluacionMinimo% mínimo</strong>
                                            </button>
                                        </h2>
                                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#requisitosAccordion">
                                            <div class="accordion-body">
                                                @configuracionRequisitos.DescripcionEvaluacion
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingFour">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                                <strong>4. Capacitación @configuracionRequisitos.HorasCapacitacionRequeridas horas (@configuracionRequisitos.HorasCapacitacionPedagogicas h pedagógicas)</strong>
                                            </button>
                                        </h2>
                                        <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#requisitosAccordion">
                                            <div class="accordion-body">
                                                @configuracionRequisitos.DescripcionCapacitacion
                                            </div>
                                        </div>
                                    </div>

                                    @if (configuracionRequisitos.RequiereProyectosInvestigacion)
                                    {
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingFive">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive">
                                                    <strong>5. Proyectos de investigación (@configuracionRequisitos.MesesProyectosInvestigacion meses)</strong>
                                                </button>
                                            </h2>
                                            <div id="collapseFive" class="accordion-collapse collapse" data-bs-parent="#requisitosAccordion">
                                                <div class="accordion-body">
                                                    @configuracionRequisitos.DescripcionProyectos
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No se encontraron requisitos configurados para tu nivel actual.
                                </div>
                            }
                        }
                    </div>
                    <div class="modal-footer">
                        @if (requisitosEscalafonDinamicos == null)
                        {
                            <button class="btn btn-primary" @onclick="VerificarRequisitos" disabled="@isLoadingRequisitos">
                                @if (isLoadingRequisitos)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="fas fa-search me-1"></i>
                                Verificar requisitos
                            </button>
                        }
                        else if (requisitosEscalafonDinamicos.CumpleTodosRequisitos)
                        {
                            <button class="btn @(isTimeConfigurationActive ? "btn-success" : "btn-secondary") me-2" 
                                    @onclick="SubirNivel" 
                                    disabled="@(!isTimeConfigurationActive)">
                                @if (!isTimeConfigurationActive)
                                {
                                    <i class="fas fa-lock me-1"></i>
                                    <text>Período Inactivo</text>
                                }
                                else
                                {
                                    <i class="fas fa-arrow-up me-1"></i>
                                    @if (configuracionRequisitos != null)
                                    {
                                        <text>Ascender a @configuracionRequisitos.NivelObjetivo</text>
                                    }
                                    else
                                    {
                                        <text>Subir de nivel</text>
                                    }
                                }
                            </button>
                            <button class="btn btn-outline-primary" @onclick="VerificarRequisitos">
                                <i class="fas fa-refresh me-1"></i>
                                Verificar nuevamente
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-outline-primary" @onclick="VerificarRequisitos">
                                <i class="fas fa-refresh me-1"></i>
                                Verificar nuevamente
                            </button>
                        }
                        <button class="btn btn-secondary" @onclick="CloseRequisitosModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>    }

    <!-- Modal de Historial de Escalafones -->
    @if (showHistorialModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-history me-2"></i>
                            Historial de Escalafones
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseHistorialModal"></button>
                    </div>
                    <div class="modal-body">
                        @if (isLoadingHistorial)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando historial...</span>
                                </div>
                                <p class="mt-2">Cargando historial de escalafones...</p>
                            </div>
                        }
                        else if (historialEscalafones?.Any() == true)
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Información importante:</strong> Los documentos marcados como "utilizados" ya no pueden ser reutilizados para futuras promociones.
                            </div>
                            
                            @foreach (var historial in historialEscalafones.OrderByDescending(h => h.FechaPromocion))
                            {
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">
                                                <i class="fas fa-arrow-up text-success me-2"></i>
                                                Promoción de <span class="badge bg-secondary">@historial.NivelAnterior</span> 
                                                a <span class="badge bg-primary">@historial.NivelNuevo</span>
                                            </h6>
                                        </div>
                                        <div>
                                            <span class="badge bg-success">@historial.EstadoSolicitud</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-calendar me-2"></i>Información General</h6>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>Fecha de Promoción:</strong></td>
                                                        <td>@historial.FechaPromocion.ToString("dd/MM/yyyy")</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Aprobado por:</strong></td>
                                                        <td>@historial.AprobadoPor</td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-12">
                                                <h6><i class="fas fa-file-alt me-2"></i>Documentos Específicos Utilizados</h6>
                                                
                                                <!-- Mostrar resumen de verificación de requisitos -->
                                                @if (historial.DocumentosDetalles?.VerificacionRequisitos != null)
                                                {
                                                    <div class="alert alert-info mb-3">
                                                        <div class="row text-center">
                                                            <div class="col-3">
                                                                <h6 class="mb-0">@historial.DocumentosDetalles.VerificacionRequisitos.TotalInvestigaciones</h6>
                                                                <small>Publicaciones</small>
                                                            </div>
                                                            <div class="col-3">
                                                                <h6 class="mb-0">@historial.DocumentosDetalles.VerificacionRequisitos.TotalHorasCapacitacion h</h6>
                                                                <small>Capacitación</small>
                                                            </div>
                                                            <div class="col-3">
                                                                <h6 class="mb-0">@historial.DocumentosDetalles.VerificacionRequisitos.PromedioEvaluaciones.ToString("F1")%</h6>
                                                                <small>Promedio DAC</small>
                                                            </div>
                                                            <div class="col-3">
                                                                <h6 class="mb-0">@historial.DocumentosDetalles.VerificacionRequisitos.PeriodosEvaluados</h6>
                                                                <small>Evaluaciones</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                
                                                <!-- Tabs para cada tipo de documento -->
                                                <ul class="nav nav-tabs" id="documentos-tabs-@historial.Id" role="tablist">
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link active" id="investigaciones-tab-@historial.Id" data-bs-toggle="tab" 
                                                                data-bs-target="#investigaciones-@historial.Id" type="button" role="tab">
                                                            <i class="fas fa-microscope me-1"></i>
                                                            Investigaciones (@(historial.DocumentosDetalles?.Investigaciones?.Count ?? 0))
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="evaluaciones-tab-@historial.Id" data-bs-toggle="tab" 
                                                                data-bs-target="#evaluaciones-@historial.Id" type="button" role="tab">
                                                            <i class="fas fa-star me-1"></i>
                                                            Evaluaciones (@(historial.DocumentosDetalles?.Evaluaciones?.Count ?? 0))
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="capacitaciones-tab-@historial.Id" data-bs-toggle="tab" 
                                                                data-bs-target="#capacitaciones-@historial.Id" type="button" role="tab">
                                                            <i class="fas fa-graduation-cap me-1"></i>
                                                            Capacitaciones (@(historial.DocumentosDetalles?.Capacitaciones?.Count ?? 0))
                                                        </button>
                                                    </li>
                                                </ul>
                                                
                                                <div class="tab-content mt-3" id="documentos-content-@historial.Id">
                                                    <!-- Tab de Investigaciones -->
                                                    <div class="tab-pane fade show active" id="investigaciones-@historial.Id" role="tabpanel">
                                                        @if (historial.DocumentosDetalles?.Investigaciones?.Any() == true)
                                                        {
                                                            @foreach (var inv in historial.DocumentosDetalles.Investigaciones)
                                                            {
                                                                <div class="border rounded p-2 mb-2">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div class="flex-grow-1">
                                                                            <h6 class="mb-1">
                                                                                <i class="fas fa-file-text me-1"></i>
                                                                                @inv.Titulo
                                                                                @if (inv.TieneFiliacionUTA)
                                                                                {
                                                                                    <span class="badge bg-success ms-2">UTA</span>
                                                                                }
                                                                            </h6>
                                                                            <p class="mb-1 text-muted small">
                                                                                <strong>@inv.Tipo</strong> - @inv.RevistaOEditorial
                                                                            </p>
                                                                            <p class="mb-0 text-muted small">
                                                                                <i class="fas fa-calendar me-1"></i>@inv.FechaPublicacion.ToString("MMM yyyy")
                                                                                | <i class="fas fa-university me-1"></i>@inv.Filiacion
                                                                            </p>
                                                                        </div>
                                                                        <span class="badge bg-warning text-dark">
                                                                            <i class="fas fa-lock me-1"></i>Utilizada
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <p class="text-muted text-center py-3">No se utilizaron investigaciones específicas</p>
                                                        }
                                                    </div>
                                                    
                                                    <!-- Tab de Evaluaciones -->
                                                    <div class="tab-pane fade" id="evaluaciones-@historial.Id" role="tabpanel">
                                                        @if (historial.DocumentosDetalles?.Evaluaciones?.Any() == true)
                                                        {
                                                            @foreach (var eval in historial.DocumentosDetalles.Evaluaciones)
                                                            {
                                                                <div class="border rounded p-2 mb-2">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <div class="flex-grow-1">
                                                                            <h6 class="mb-1">
                                                                                <i class="fas fa-star me-1"></i>
                                                                                Evaluación @eval.PeriodoAcademico
                                                                            </h6>
                                                                            <p class="mb-0 text-muted small">
                                                                                <i class="fas fa-calendar me-1"></i>@eval.Anio - Semestre @eval.Semestre
                                                                                | <i class="fas fa-chart-line me-1"></i>@eval.PuntajeObtenido/@eval.PuntajeMaximo puntos
                                                                            </p>
                                                                        </div>
                                                                        <div class="text-end">
                                                                            <span class="badge @(eval.Porcentaje >= 75 ? "bg-success" : "bg-warning")">
                                                                                @eval.Porcentaje.ToString("F1")%
                                                                            </span>
                                                                            <br>
                                                                            <span class="badge bg-warning text-dark mt-1">
                                                                                <i class="fas fa-lock me-1"></i>Utilizada
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <p class="text-muted text-center py-3">No se utilizaron evaluaciones específicas</p>
                                                        }
                                                    </div>
                                                    
                                                    <!-- Tab de Capacitaciones -->
                                                    <div class="tab-pane fade" id="capacitaciones-@historial.Id" role="tabpanel">
                                                        @if (historial.DocumentosDetalles?.Capacitaciones?.Any() == true)
                                                        {
                                                            @foreach (var cap in historial.DocumentosDetalles.Capacitaciones)
                                                            {
                                                                <div class="border rounded p-2 mb-2">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div class="flex-grow-1">
                                                                            <h6 class="mb-1">
                                                                                <i class="fas fa-graduation-cap me-1"></i>
                                                                                @cap.NombreCurso
                                                                                @if (cap.EsPedagogica)
                                                                                {
                                                                                    <span class="badge bg-info ms-2">Pedagógica</span>
                                                                                }
                                                                            </h6>
                                                                            <p class="mb-1 text-muted small">
                                                                                <strong>@cap.HorasAcademicas horas</strong> - @cap.Tipo
                                                                            </p>
                                                                            <p class="mb-0 text-muted small">
                                                                                <i class="fas fa-user me-1"></i>@cap.Facilitador
                                                                                | <i class="fas fa-calendar me-1"></i>@cap.FechaInicio.ToString("MMM yyyy") - @cap.FechaFin.ToString("MMM yyyy")
                                                                            </p>
                                                                        </div>
                                                                        <span class="badge bg-warning text-dark">
                                                                            <i class="fas fa-lock me-1"></i>Utilizada
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <p class="text-muted text-center py-3">No se utilizaron capacitaciones específicas</p>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(historial.ObservacionesFinales))
                                        {
                                            <div class="mt-3">
                                                <h6><i class="fas fa-comment me-2"></i>Observaciones</h6>
                                                <p class="text-muted">@historial.ObservacionesFinales</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-history fa-3x text-muted"></i>
                                </div>
                                <h5>No hay historial de escalafones</h5>
                                <p class="text-muted">Aún no has realizado ninguna promoción de nivel académico.</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseHistorialModal">
                            <i class="fas fa-times me-1"></i>
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showInvestigacionesModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestión de Investigaciones</h5>
                        <button type="button" class="btn-close" @onclick="CloseInvestigacionesModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Mis Investigaciones</h6>
                            <div>
                                <button class="btn btn-success me-2" @onclick="ShowAgregarInvestigacion">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                                <button class="btn btn-primary" @onclick="ImportarInvestigaciones">
                                    <i class="fas fa-download"></i> Importar
                                </button>
                            </div>
                        </div>
                          @if (isLoadingInvestigaciones)
                        {
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando investigaciones...</p>
                            </div>
                        }                        else
                        {
                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-book me-2"></i>Título</th>
                                            <th><i class="fas fa-flask me-2"></i>Área</th>
                                            <th><i class="fas fa-tag me-2"></i>Tipo</th>
                                            <th><i class="fas fa-chart-line me-2"></i>Estado</th>
                                            <th><i class="fas fa-calendar me-2"></i>Fecha Pub.</th>
                                            <th><i class="fas fa-university me-2"></i>Filiación</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (investigaciones.Any())
                                        {
                                            @foreach (var investigacion in investigaciones)
                                            {
                                                <tr>
                                                    <td class="col-title">
                                                        <div class="fw-medium">@investigacion.Titulo</div>
                                                        @if (!string.IsNullOrEmpty(investigacion.RevistaOEditorial))
                                                        {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="fas fa-newspaper me-1"></i>@investigacion.RevistaOEditorial
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge info">
                                                            <i class="fas fa-atom"></i>
                                                            @investigacion.Area
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge secondary">
                                                            @investigacion.Tipo
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(investigacion.Estado == "Completado" ? "success" : "warning")">
                                                            <i class="fas @(investigacion.Estado == "Completado" ? "fa-check-circle" : "fa-clock")"></i>
                                                            @investigacion.Estado
                                                        </span>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        @investigacion.FechaInicio.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(investigacion.Filiacion))
                                                        {
                                                            <span class="table-badge @(investigacion.Filiacion.Contains("UTA", StringComparison.OrdinalIgnoreCase) || investigacion.Filiacion.Contains("Universidad Técnica de Ambato", StringComparison.OrdinalIgnoreCase) ? "success" : "secondary")">
                                                                @if (investigacion.Filiacion.Contains("UTA", StringComparison.OrdinalIgnoreCase) || investigacion.Filiacion.Contains("Universidad Técnica de Ambato", StringComparison.OrdinalIgnoreCase))
                                                                {
                                                                    <i class="fas fa-check-circle"></i>
                                                                }
                                                                @investigacion.Filiacion
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">
                                                                <i class="fas fa-minus-circle me-1"></i>Sin filiación
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            <button class="action-btn edit" @onclick="() => EditarInvestigacion(investigacion)" title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="action-btn delete" @onclick="() => EliminarInvestigacion(investigacion.Id)" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            @if (investigacion.TienePdf)
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdf(investigacion.Id)" title="Ver PDF">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="7" class="empty-state">
                                                    <i class="fas fa-search"></i>
                                                    <h6>No hay investigaciones cargadas</h6>
                                                    <p>Haz clic en "Importar" para cargar tus investigaciones desde la base de datos</p>
                                                    <small class="text-info">Cédula actual: @(UserSession.CurrentUser?.Cedula ?? "No disponible")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        
                        @* Mostrar resumen de investigaciones con filiación UTA *@
                        @if (investigaciones.Any())
                        {
                            <div class="mt-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-chart-line"></i> Verificación Requisito Obras con UTA
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge @(cumpleObrasUTA ? "bg-success" : "bg-danger") me-2">
                                                        <i class="fas @(cumpleObrasUTA ? "fa-check" : "fa-times")"></i>
                                                    </span>
                                                    <strong>@(cumpleObrasUTA ? "CUMPLE" : "NO CUMPLE")</strong>
                                                </div>
                                                <p class="mb-1 mt-2">
                                                    @if (cumpleObrasUTA)
                                                    {
                                                        <text>El docente cumple con el requisito de obras relevantes con filiación UTA.</text>
                                                    }
                                                    else
                                                    {
                                                        <text>Te faltan @(obrasConUTARequeridas - obrasConUTAObtenidas) obra(s) más con filiación UTA.</text>
                                                    }
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>Investigaciones analizadas:</strong> @totalObrasObtenidas</p>
                                                <p class="mb-1"><strong>Con filiación UTA:</strong> @obrasConUTAObtenidas / @obrasConUTARequeridas</p>
                                                <p class="mb-0"><strong>Total requeridas:</strong> @totalObrasObtenidas / @totalObrasRequeridas</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseInvestigacionesModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showAgregarModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(editingInvestigacion is not null ? "Editar" : "Agregar") Investigación</h5>
                        <button type="button" class="btn-close" @onclick="CloseAgregarModal"></button>
                    </div>
                    <div class="modal-body">
                        <form class="professional-form">
                            <div class="form-grid">
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-book section-icon"></i>
                                        Información Básica
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-heading label-icon"></i>
                                                Título *
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaInvestigacion.Titulo" 
                                                   placeholder="Ingrese el título de la investigación" required />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-microscope label-icon"></i>
                                                Área de Conocimiento *
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaInvestigacion.Area" 
                                                   placeholder="Ej: Ingeniería de Software, Matemáticas, etc." required />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-calendar section-icon"></i>
                                        Detalles de Publicación
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-calendar-alt label-icon"></i>
                                                Fecha de Publicación *
                                            </label>
                                            <input type="date" class="form-input" @bind="nuevaInvestigacion.FechaInicio" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-university label-icon"></i>
                                                Filiación
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaInvestigacion.Filiacion" 
                                                   placeholder="Ej: Universidad Técnica de Ambato (UTA)" />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-comment-alt section-icon"></i>
                                        Información Adicional
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-sticky-note label-icon"></i>
                                                Observaciones
                                            </label>
                                            <textarea class="form-textarea" rows="3" @bind="nuevaInvestigacion.Descripcion" 
                                                      placeholder="Descripción o comentarios adicionales sobre la investigación"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-paperclip section-icon"></i>
                                        Archivo Adjunto
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-file-pdf label-icon"></i>
                                                Archivo PDF
                                            </label>
                                            <div class="file-upload-container">
                                                <div class="file-input-hidden">
                                                    <InputFile OnChange="HandlePdfSelected" accept=".pdf" id="investigacion-file-input" />
                                                </div>
                                                <div class="file-upload-area" onclick="document.getElementById('investigacion-file-input').click();">
                                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                                    <span class="upload-text">Seleccionar archivo PDF</span>
                                                    <span class="upload-subtext">Arrastra y suelta tu archivo aquí o haz clic para seleccionar<br/>Formatos soportados: PDF • Tamaño máximo: 10MB</span>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrEmpty(pdfFileName))
                                            {
                                                <div class="file-selected">
                                                    <i class="fas fa-file-pdf file-icon"></i>
                                                    <span class="file-name">@pdfFileName</span>
                                                    <i class="fas fa-check file-check"></i>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-professional btn-primary" @onclick="GuardarInvestigacion" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <i class="fas fa-save me-2"></i>
                                <span>@(editingInvestigacion is not null ? "Actualizar" : "Guardar")</span>
                            }
                        </button>
                        <button class="btn-professional btn-secondary" @onclick="CloseAgregarModal">
                            <i class="fas fa-times me-2"></i>
                            <span>Cancelar</span>
                        </button>
                    </div>
                </div>
            </div>        </div>
    }    @* Modal para Evaluaciones de Desempeño *@
    @if (showEvaluacionesModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestión de Evaluaciones de Desempeño DAC</h5>
                        <button type="button" class="btn-close" @onclick="CloseEvaluacionesModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Mis Evaluaciones DAC</h6>
                            <div>
                                <button class="btn btn-success me-2" @onclick="ShowAgregarEvaluacion">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                                <button class="btn btn-primary" @onclick="ImportarEvaluaciones">
                                    <i class="fas fa-download"></i> Importar
                                </button>
                            </div>
                        </div>
                          @if (isLoadingEvaluaciones)
                        {
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando evaluaciones...</p>
                            </div>
                        }
                        else
                        {                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-calendar-alt me-2"></i>Período</th>
                                            <th><i class="fas fa-calendar me-2"></i>Año</th>
                                            <th><i class="fas fa-list-ol me-2"></i>Sem.</th>
                                            <th><i class="fas fa-chart-bar me-2"></i>Puntaje</th>
                                            <th><i class="fas fa-percentage me-2"></i>Porcentaje</th>
                                            <th><i class="fas fa-check-circle me-2"></i>Estado</th>
                                            <th><i class="fas fa-clock me-2"></i>Fecha Eval.</th>
                                            <th><i class="fas fa-user-tie me-2"></i>Evaluador</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (evaluaciones.Any())
                                        {
                                            @foreach (var evaluacion in evaluaciones)
                                            {
                                                <tr>
                                                    <td class="fw-medium">
                                                        <i class="fas fa-graduation-cap me-2 text-primary"></i>
                                                        @evaluacion.PeriodoAcademico
                                                    </td>
                                                    <td class="col-date">
                                                        <span class="table-badge info">@evaluacion.Anio</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="table-badge secondary">@evaluacion.Semestre</span>
                                                    </td>
                                                    <td class="col-score">
                                                        <div class="fw-bold">@evaluacion.PuntajeObtenido</div>
                                                        <small class="text-muted">/ @evaluacion.PuntajeMaximo</small>
                                                    </td>
                                                    <td class="col-score">
                                                        <span class="table-badge @(evaluacion.PorcentajeObtenido >= 90 ? "success" : evaluacion.PorcentajeObtenido >= 75 ? "warning" : "danger")">
                                                            <i class="fas @(evaluacion.PorcentajeObtenido >= 90 ? "fa-trophy" : evaluacion.PorcentajeObtenido >= 75 ? "fa-star" : "fa-exclamation-triangle")"></i>
                                                            @evaluacion.PorcentajeObtenido.ToString("F1")%
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(evaluacion.CumpleMinimo ? "success" : "danger")">
                                                            <i class="fas @(evaluacion.CumpleMinimo ? "fa-check" : "fa-times")"></i>
                                                            @evaluacion.Estado
                                                        </span>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        @evaluacion.FechaEvaluacion.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(evaluacion.Evaluador))
                                                        {
                                                            <div class="fw-medium">@evaluacion.Evaluador</div>
                                                            <small class="text-muted">@evaluacion.TipoEvaluacion</small>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">
                                                                <i class="fas fa-user-slash me-1"></i>Sin asignar
                                                            </span>
                                                        }
                                                    </td>                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            <button class="action-btn edit" @onclick="() => EditarEvaluacion(evaluacion)" title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="action-btn delete" @onclick="() => EliminarEvaluacion(evaluacion.Id)" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            @if (!string.IsNullOrEmpty(evaluacion.NombreArchivoRespaldo))
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdfEvaluacion(evaluacion.Id)" title="Ver PDF">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="empty-state">
                                                    <i class="fas fa-star"></i>
                                                    <h6>No hay evaluaciones de desempeño cargadas</h6>
                                                    <p>Haz clic en "Importar" para cargar tus evaluaciones desde la base de datos DAC</p>
                                                    <small class="text-info">Cédula actual: @(UserSession.CurrentUser?.Cedula ?? "No disponible")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            @* Mostrar resumen de cumplimiento del requisito de evaluaciones *@
                            @if (evaluaciones.Any())
                            {
                                <div class="mt-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-chart-line"></i> Verificación Requisito @porcentajeEvaluacionRequerido%
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge @(cumpleEvaluaciones ? "bg-success" : "bg-danger") me-2">
                                                            <i class="fas @(cumpleEvaluaciones ? "fa-check" : "fa-times")"></i>
                                                        </span>
                                                        <strong>@(cumpleEvaluaciones ? "CUMPLE" : "NO CUMPLE")</strong>
                                                    </div>
                                                    <p class="mb-1 mt-2">
                                                        @if (cumpleEvaluaciones)
                                                        {
                                                            <text>El docente cumple con el requisito de @porcentajeEvaluacionRequerido% en evaluaciones de desempeño.</text>
                                                        }
                                                        else
                                                        {
                                                            <text>El promedio actual (@porcentajeEvaluacionObtenido%) no alcanza el @porcentajeEvaluacionRequerido% requerido.</text>
                                                        }
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1"><strong>Evaluaciones analizadas:</strong> @periodosEvaluacionAnalizados / @periodosEvaluacionRequeridos</p>
                                                    <p class="mb-1"><strong>Promedio obtenido:</strong> @porcentajeEvaluacionObtenido%</p>
                                                    <p class="mb-0"><strong>Requerido:</strong> @porcentajeEvaluacionRequerido%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseEvaluacionesModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal para Capacitaciones DITIC *@
    @if (showCapacitacionesModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestión de Capacitaciones DITIC</h5>
                        <button type="button" class="btn-close" @onclick="CloseCapacitacionesModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Mis Capacitaciones</h6>
                            <div>
                                <button class="btn btn-success me-2" @onclick="ShowAgregarCapacitacion">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                                <button class="btn btn-primary" @onclick="ImportarCapacitaciones">
                                    <i class="fas fa-download"></i> Importar
                                </button>
                            </div>
                        </div>
                          @if (isLoadingCapacitaciones)
                        {
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando capacitaciones...</p>
                            </div>
                        }                        else
                        {                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-graduation-cap me-2"></i>Nombre</th>
                                            <th><i class="fas fa-university me-2"></i>Institución</th>
                                            <th><i class="fas fa-tag me-2"></i>Tipo</th>
                                            <th><i class="fas fa-laptop me-2"></i>Modalidad</th>
                                            <th><i class="fas fa-clock me-2"></i>Horas</th>
                                            <th><i class="fas fa-calendar-plus me-2"></i>Fecha Inicio</th>
                                            <th><i class="fas fa-calendar-check me-2"></i>Fecha Fin</th>
                                            <th><i class="fas fa-chart-line me-2"></i>Estado</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (capacitaciones.Any())
                                        {
                                            @foreach (var capacitacion in capacitaciones)
                                            {
                                                <tr>
                                                    <td class="col-title">
                                                        <div class="fw-medium">@capacitacion.NombreCapacitacion</div>
                                                        @if (!string.IsNullOrEmpty(capacitacion.Descripcion))
                                                        {
                                                            <small class="text-muted d-block mt-1" title="@capacitacion.Descripcion">
                                                                <i class="fas fa-info-circle me-1"></i>@capacitacion.Descripcion.Substring(0, Math.Min(50, capacitacion.Descripcion.Length))...
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="fw-medium">@capacitacion.Institucion</div>
                                                        @if (!string.IsNullOrEmpty(capacitacion.Instructor))
                                                        {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="fas fa-user-tie me-1"></i>@capacitacion.Instructor
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(capacitacion.EsPedagogica ? "success" : "info")">
                                                            <i class="fas @(capacitacion.EsPedagogica ? "fa-chalkboard-teacher" : "fa-cogs")"></i>
                                                            @capacitacion.TipoCapacitacion
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge secondary">
                                                            <i class="fas @(capacitacion.Modalidad.Contains("Virtual", StringComparison.OrdinalIgnoreCase) ? "fa-laptop" : capacitacion.Modalidad.Contains("Presencial", StringComparison.OrdinalIgnoreCase) ? "fa-users" : "fa-sync-alt")"></i>
                                                            @capacitacion.Modalidad
                                                        </span>
                                                    </td>
                                                    <td class="col-score">
                                                        <div class="fw-bold text-primary">@capacitacion.HorasAcademicas</div>
                                                        <small class="text-muted">horas</small>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        @capacitacion.FechaInicio.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        @capacitacion.FechaFin.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(capacitacion.Estado?.ToLower() switch { "aprobada" or "completada" => "success", "en progreso" => "warning", "reprobada" => "danger", _ => "secondary" })">
                                                            <i class="fas @(capacitacion.Estado?.ToLower() switch { "aprobada" or "completada" => "fa-check-circle", "en progreso" => "fa-clock", "reprobada" => "fa-times-circle", _ => "fa-question-circle" })"></i>
                                                            @capacitacion.Estado
                                                        </span>
                                                        @if (capacitacion.Calificacion.HasValue)
                                                        {
                                                            <div class="mt-1">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-star me-1"></i>@capacitacion.Calificacion.Value.ToString("F1")
                                                                </small>
                                                            </div>
                                                        }
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            <button class="action-btn edit" @onclick="() => EditarCapacitacion(capacitacion)" title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="action-btn delete" @onclick="() => EliminarCapacitacion(capacitacion.Id)" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            @if (!string.IsNullOrEmpty(capacitacion.NombreArchivoCertificado))
                                                            {
                                                                <button class="action-btn view" @onclick="() => VerPdfCapacitacion(capacitacion.Id)" title="Ver Certificado">
                                                                    <i class="fas fa-file-pdf"></i>
                                                                </button>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="empty-state">
                                                    <i class="fas fa-search"></i>
                                                    <h6>No hay capacitaciones cargadas</h6>
                                                    <p>Haz clic en "Importar" para cargar tus capacitaciones desde la base de datos</p>
                                                    <small class="text-info">Cédula actual: @(UserSession.CurrentUser?.Cedula ?? "No disponible")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>                            </div>
                        }
                        
                        @* Mostrar resumen de capacitaciones DITIC *@
                        @if (capacitaciones.Any())
                        {
                            <div class="mt-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-chart-line"></i> Verificación Requisito @horasCapacitacionRequeridas Horas (@horasPedagogicasRequeridas h pedagógicas)
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge @(cumpleCapacitaciones ? "bg-success" : "bg-danger") me-2">
                                                        <i class="fas @(cumpleCapacitaciones ? "fa-check" : "fa-times")"></i>
                                                    </span>
                                                    <strong>@(cumpleCapacitaciones ? "CUMPLE" : "NO CUMPLE")</strong>
                                                </div>
                                                <p class="mb-1 mt-2">
                                                    @if (cumpleCapacitaciones)
                                                    {
                                                        <text>El docente cumple con el requisito de @horasCapacitacionRequeridas horas de capacitación.</text>
                                                    }
                                                    else
                                                    {
                                                        @if (horasCapacitacionObtenidas < horasCapacitacionRequeridas)
                                                        {
                                                            <text>Te faltan @(horasCapacitacionRequeridas - horasCapacitacionObtenidas) horas más de capacitación.</text>
                                                        }
                                                        else if (horasPedagogicasObtenidas < horasPedagogicasRequeridas)
                                                        {
                                                            <text>Tienes suficientes horas totales (@horasCapacitacionObtenidas/@horasCapacitacionRequeridas), pero te faltan @(horasPedagogicasRequeridas - horasPedagogicasObtenidas) horas pedagógicas.</text>
                                                        }
                                                        else
                                                        {
                                                            <text>No cumples con los requisitos de capacitación. Revisa los detalles específicos.</text>
                                                        }
                                                    }
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>Capacitaciones disponibles:</strong> @capacitaciones.Count (no utilizadas)</p>
                                                <p class="mb-1"><strong>Horas totales:</strong> @horasCapacitacionObtenidas / @horasCapacitacionRequeridas</p>
                                                <p class="mb-0"><strong>Horas pedagógicas:</strong> @horasPedagogicasObtenidas / @horasPedagogicasRequeridas</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseCapacitacionesModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal para Solicitudes *@
    @if (showSolicitudesModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestión de Solicitudes</h5>
                        <button type="button" class="btn-close" @onclick="CloseSolicitudesModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Mis Solicitudes</h6>
                            <div>
                                <button class="btn btn-primary" @onclick="ImportarSolicitudes">
                                    <i class="fas fa-download"></i> Importar Solicitudes
                                </button>
                            </div>
                        </div>
                        
                        @if (isLoadingSolicitudes)
                        {
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando solicitudes...</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table professional-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-file-alt me-2"></i>Tipo de Solicitud</th>
                                            <th><i class="fas fa-traffic-light me-2"></i>Estado</th>
                                            <th><i class="fas fa-calendar-plus me-2"></i>Fecha Solicitud</th>
                                            <th><i class="fas fa-calendar-check me-2"></i>Fecha Respuesta</th>
                                            <th><i class="fas fa-level-down-alt me-2"></i>Nivel Actual</th>
                                            <th><i class="fas fa-level-up-alt me-2"></i>Nivel Solicitado</th>
                                            <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (solicitudes.Any())
                                        {
                                            @foreach (var solicitud in solicitudes)
                                            {
                                                <tr>
                                                    <td class="col-title">
                                                        <div class="fw-medium">@solicitud.TipoSolicitud</div>
                                                        @if (!string.IsNullOrEmpty(solicitud.Observaciones))
                                                        {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="fas fa-comment me-1"></i>@solicitud.Observaciones.Substring(0, Math.Min(50, solicitud.Observaciones.Length))@(solicitud.Observaciones.Length > 50 ? "..." : "")
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge @(solicitud.Estado.ToLower() switch { "aprobada" => "success", "en revisión" or "en revision" => "warning", "rechazada" => "danger", _ => "secondary" })">
                                                            <i class="fas @(solicitud.Estado.ToLower() switch { "aprobada" => "fa-check-circle", "en revisión" or "en revision" => "fa-clock", "rechazada" => "fa-times-circle", _ => "fa-question-circle" })"></i>
                                                            @solicitud.Estado
                                                        </span>
                                                    </td>
                                                    <td class="col-date">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        @solicitud.FechaSolicitud.ToString("dd/MM/yyyy")
                                                    </td>
                                                    <td class="col-date">
                                                        @if (solicitud.FechaRespuesta.HasValue)
                                                        {
                                                            <i class="fas fa-calendar-check me-1 text-success"></i>
                                                            @solicitud.FechaRespuesta.Value.ToString("dd/MM/yyyy")
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">
                                                                <i class="fas fa-clock me-1"></i>Pendiente
                                                            </span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="table-badge secondary">
                                                            @solicitud.NivelActual
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="table-badge info">
                                                            <i class="fas fa-arrow-up"></i>
                                                            @solicitud.NivelSolicitado
                                                        </span>
                                                    </td>
                                                    <td class="col-actions">
                                                        <div class="action-btn-group">
                                                            <button class="action-btn view" @onclick="() => VerDetalleSolicitud(solicitud.Id)" title="Ver Detalle">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            @if (solicitud.Estado.ToLower() == "en revisión" || solicitud.Estado.ToLower() == "en revision")
                                                            {
                                                                <button class="action-btn cancel" @onclick="() => CancelarSolicitud(solicitud.Id)" title="Cancelar Solicitud">
                                                                    <i class="fas fa-ban"></i>
                                                                </button>
                                                            }                                            @* Debug: mostrar el estado y la condición de apelación *@
                                            @{
                                                bool esRechazada = solicitud.Estado.ToLower().Contains("rechazada") || 
                                                                   solicitud.Estado.ToLower().Contains("rechazado") ||
                                                                   solicitud.Estado.ToLower().Contains("denegada") ||
                                                                   solicitud.Estado.ToLower().Contains("denegado");
                                            }
                                            @if (esRechazada)
                                            {
                                                <button class="action-btn appeal" @onclick="() => AbrirModalApelacion(solicitud.Id)" title="Apelar Decisión">
                                                    <i class="fas fa-gavel"></i>
                                                </button>
                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="7" class="empty-state">
                                                    <i class="fas fa-file-alt"></i>
                                                    <h6>No hay solicitudes registradas</h6>
                                                    <p>Haz clic en "Importar Solicitudes" para ver el estado de tus solicitudes</p>
                                                    <small class="text-info">Cédula actual: @(UserSession.CurrentUser?.Cedula ?? "No disponible")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        
                        @* Mostrar resumen de solicitudes *@
                        @if (solicitudes.Any())
                        {
                            <div class="mt-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-chart-pie"></i> Resumen de Solicitudes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        @if (isLoadingEstadisticasSolicitudes)
                                        {
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Cargando estadísticas...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Cargando estadísticas...</p>
                                            </div>
                                        }
                                        else if (estadisticasSolicitudes.HasValue)
                                        {
                                            <div class="row g-3">
                                                <!-- Estadísticas principales -->
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern total-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-file-alt"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("total").GetInt32())</h3>
                                                            <p class="stat-label">Total</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern pending-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-clock"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("pendientes").GetInt32())</h3>
                                                            <p class="stat-label">Pendientes</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern approved-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-check-circle"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("aprobadas").GetInt32())</h3>
                                                            <p class="stat-label">Aprobadas</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern process-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-cog"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("enProceso").GetInt32())</h3>
                                                            <p class="stat-label">En Proceso</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            @* Segunda fila para estadísticas adicionales *@
                                            <div class="row g-3 mt-2">
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern review-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-search"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("enRevision").GetInt32())</h3>
                                                            <p class="stat-label">En Revisión</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern completed-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-check-double"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("completadas").GetInt32())</h3>
                                                            <p class="stat-label">Completadas</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern appeal-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-gavel"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("apelaciones").GetInt32())</h3>
                                                            <p class="stat-label">Apelaciones</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
                                                    <div class="stat-card-modern rejected-card">
                                                        <div class="stat-icon">
                                                            <i class="fas fa-times-circle"></i>
                                                        </div>
                                                        <div class="stat-info">
                                                            <h3 class="stat-number">@(estadisticasSolicitudes.Value.GetProperty("rechazadas").GetInt32())</h3>
                                                            <p class="stat-label">Rechazadas</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary me-2">
                                                            <i class="fas fa-list"></i>
                                                        </span>
                                                        <div>
                                                            <strong>Total: @solicitudes.Count</strong>
                                                            <small class="d-block text-muted">Solicitudes</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-9">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        <strong>Estadísticas detalladas disponibles desde la API</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseSolicitudesModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal para Detalle de Solicitud *@
    @if (showDetalleSolicitudModal && solicitudSeleccionada != null)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-alt me-2"></i>
                            Detalle de Solicitud
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseDetalleSolicitudModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-file-alt me-2"></i>Tipo de Solicitud
                                    </h6>
                                    <p class="info-value">@solicitudSeleccionada.TipoSolicitud</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-traffic-light me-2"></i>Estado
                                    </h6>
                                    <span class="badge @(solicitudSeleccionada.Estado.ToLower() switch { 
                                        "aprobada" => "bg-success", 
                                        "en revisión" or "en revision" => "bg-warning text-dark", 
                                        "rechazada" => "bg-danger", 
                                        _ => "bg-secondary" 
                                    }) fs-6">
                                        <i class="fas @(solicitudSeleccionada.Estado.ToLower() switch { 
                                            "aprobada" => "fa-check-circle", 
                                            "en revisión" or "en revision" => "fa-clock", 
                                            "rechazada" => "fa-times-circle", 
                                            _ => "fa-question-circle" 
                                        }) me-1"></i>
                                        @solicitudSeleccionada.Estado
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-calendar-plus me-2"></i>Fecha de Solicitud
                                    </h6>
                                    <p class="info-value">@solicitudSeleccionada.FechaSolicitud.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-calendar-check me-2"></i>Fecha de Respuesta
                                    </h6>
                                    @if (solicitudSeleccionada.FechaRespuesta.HasValue)
                                    {
                                        <p class="info-value">@solicitudSeleccionada.FechaRespuesta.Value.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))</p>
                                    }
                                    else
                                    {
                                        <p class="info-value text-muted">
                                            <i class="fas fa-clock me-1"></i>Pendiente de respuesta
                                        </p>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-level-down-alt me-2"></i>Nivel Actual
                                    </h6>
                                    <span class="badge bg-secondary fs-6">@solicitudSeleccionada.NivelActual</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-card">
                                    <h6 class="info-label">
                                        <i class="fas fa-level-up-alt me-2"></i>Nivel Solicitado
                                    </h6>
                                    <span class="badge bg-info text-dark fs-6">
                                        <i class="fas fa-arrow-up me-1"></i>@solicitudSeleccionada.NivelSolicitado
                                    </span>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(solicitudSeleccionada.Observaciones))
                            {
                                <div class="col-md-12 mb-3">
                                    <div class="info-card">
                                        <h6 class="info-label">
                                            <i class="fas fa-comment-alt me-2"></i>Observaciones
                                        </h6>
                                        <div class="alert alert-light border-start border-info border-4">
                                            <p class="mb-0">@solicitudSeleccionada.Observaciones</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        @if (solicitudSeleccionada.Estado.ToLower() == "en revisión" || solicitudSeleccionada.Estado.ToLower() == "en revision")
                        {
                            <button class="btn btn-outline-danger me-2" @onclick="() => CancelarSolicitudDetalle(solicitudSeleccionada.Id)">
                                <i class="fas fa-times me-1"></i>
                                Cancelar Solicitud
                            </button>
                        }
                        <button class="btn btn-secondary" @onclick="CloseDetalleSolicitudModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal para Apelación de Solicitud *@
    @if (showApelacionModal && solicitudParaApelar != null)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-gavel me-2"></i>
                            Apelación de Solicitud Rechazada
                        </h5>
                        <button type="button" class="btn-close btn-close-dark" @onclick="CerrarModalApelacion"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info mb-4">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>
                                Información de la Solicitud Original
                            </h6>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <strong>Solicitud:</strong> #@solicitudParaApelar.Id<br>
                                    <strong>Nivel solicitado:</strong> @solicitudParaApelar.NivelSolicitado<br>
                                    <strong>Estado:</strong> <span class="badge bg-danger">@solicitudParaApelar.Estado</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Fecha solicitud:</strong> @solicitudParaApelar.FechaSolicitud.ToString("dd/MM/yyyy")<br>
                                    <strong>Motivo rechazo:</strong><br>
                                    <small class="text-muted">
                                        @if (!string.IsNullOrEmpty(solicitudParaApelar.MotivoRechazo))
                                        {
                                            @solicitudParaApelar.MotivoRechazo
                                        }
                                        else if (!string.IsNullOrEmpty(solicitudParaApelar.MotivoRechazoConsejo))
                                        {
                                            @solicitudParaApelar.MotivoRechazoConsejo
                                        }
                                        else if (!string.IsNullOrEmpty(solicitudParaApelar.Observaciones))
                                        {
                                            @solicitudParaApelar.Observaciones
                                        }
                                        else
                                        {
                                            <em>No se especificó motivo de rechazo</em>
                                        }
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-pen me-2"></i>
                                Justificación de la Apelación *
                            </label>
                            <textarea class="form-control" @bind="justificacionApelacion" 
                                      rows="6" placeholder="Explique detalladamente por qué considera que la decisión de rechazo debe ser revisada. Incluya cualquier documentación adicional o argumento que respalde su apelación." 
                                      maxlength="1000" required></textarea>
                            <small class="form-text text-muted">
                                Máximo 1000 caracteres. Caracteres restantes: @(1000 - (justificacionApelacion?.Length ?? 0))
                            </small>
                        </div>

                        <div class="form-group mt-4">
                            <label class="form-label">
                                <i class="fas fa-paperclip me-2"></i>
                                Documentos de Respaldo (Opcional)
                            </label>
                            <div class="border rounded p-3 bg-light">
                                <InputFile multiple OnChange="HandleArchivosApelacionSelected" 
                                          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" 
                                          class="form-control mb-2" />
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Formatos permitidos: PDF, DOC, DOCX, JPG, PNG. Máximo 5 archivos, 10MB cada uno.
                                </small>
                                
                                @if (archivosApelacion.Any())
                                {
                                    <div class="mt-3">
                                        <h6 class="mb-2">Archivos seleccionados:</h6>
                                        @foreach (var archivo in archivosApelacion)
                                        {
                                            <div class="d-flex align-items-center justify-content-between bg-white p-2 border rounded mb-2">
                                                <span>
                                                    <i class="fas fa-file me-2 text-primary"></i>
                                                    @archivo.Name
                                                    <small class="text-muted">(@(Math.Round((double)archivo.Size / 1024 / 1024, 2)) MB)</small>
                                                </span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        @onclick="() => RemoverArchivoApelacion(archivo)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                @if (errorMensajeArchivos != null)
                                {
                                    <div class="alert alert-danger mt-2 mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        @errorMensajeArchivos
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Importante
                            </h6>
                            <ul class="mb-0">
                                <li>La apelación será enviada directamente a la <strong>Comisión Académica de Escalafón</strong> para su revisión.</li>
                                <li>Se creará una nueva solicitud con estado "Apelación Pendiente".</li>
                                <li>Los documentos adjuntos servirán como respaldo a su solicitud de apelación.</li>
                                <li>Recibirá una notificación por correo electrónico cuando se procese su apelación.</li>
                                <li>Esta acción no se puede deshacer una vez enviada.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CerrarModalApelacion" disabled="@isCreatingApelacion">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </button>
                        <button class="btn btn-warning" @onclick="MostrarConfirmacionApelacion" disabled="@(isCreatingApelacion || string.IsNullOrWhiteSpace(justificacionApelacion))">
                            @if (isCreatingApelacion)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <text>Enviando Apelación...</text>
                            }
                            else
                            {
                                <i class="fas fa-gavel me-1"></i>
                                <text>Enviar Apelación</text>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal de Confirmación Profesional de Apelación *@
    @if (showConfirmacionApelacionModal && solicitudParaApelar != null)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-gradient-warning text-dark border-0">
                        <h5 class="modal-title fw-bold">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Confirmación de Apelación
                        </h5>
                        <button type="button" class="btn-close btn-close-dark" @onclick="CerrarConfirmacionApelacion"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="alert alert-warning border-0 mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-info-circle fa-lg me-3 text-warning"></i>
                                <h6 class="mb-0 fw-bold">Información de la Apelación</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Solicitud</small>
                                    <div class="fw-bold">#@solicitudParaApelar.Id</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Escalafón</small>
                                    <div class="fw-bold">@solicitudParaApelar.NivelActual → @solicitudParaApelar.NivelSolicitado</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    Detalles del Proceso
                                </h6>
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-arrow-right text-success me-2"></i>
                                        Su apelación será enviada a la <strong>Comisión Académica de Escalafón</strong>
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-clock text-info me-2"></i>
                                        El proceso de revisión puede tomar <strong>3-5 días hábiles</strong>
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-envelope text-warning me-2"></i>
                                        Recibirá una notificación por correo electrónico cuando sea procesada
                                    </li>
                                    @if (archivosApelacion.Any())
                                    {
                                        <li class="mb-0">
                                            <i class="fas fa-paperclip text-secondary me-2"></i>
                                            Se incluirán <strong>@archivosApelacion.Count archivo(s)</strong> adjunto(s)
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="mb-0 text-muted">
                                <i class="fas fa-question-circle me-1"></i>
                                ¿Está seguro de que desea proceder con el envío de la apelación?
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-outline-secondary" @onclick="CerrarConfirmacionApelacion">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-warning" @onclick="ProcesarApelacion" disabled="@isCreatingApelacion">
                            @if (isCreatingApelacion)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <text>Enviando...</text>
                            }
                            else
                            {
                                <i class="fas fa-paper-plane me-1"></i>
                                <text>Confirmar y Enviar</text>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal para Agregar/Editar Evaluaciones *@
    @if (showAgregarEvaluacionModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(editingEvaluacion is not null ? "Editar" : "Agregar") Evaluación DAC</h5>
                        <button type="button" class="btn-close" @onclick="CloseAgregarEvaluacionModal"></button>
                    </div>
                    <div class="modal-body">
                        <form class="professional-form">
                            <div class="form-grid">
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-calendar-check section-icon"></i>
                                        Información del Período
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-graduation-cap label-icon"></i>
                                                Período Académico *
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaEvaluacion.PeriodoAcademico" 
                                                   placeholder="Ej: 2024-1" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-calendar label-icon"></i>
                                                Año *
                                            </label>
                                            <input type="number" class="form-input" @bind="nuevaEvaluacion.Anio" 
                                                   min="2020" max="2030" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-list-ol label-icon"></i>
                                                Semestre *
                                            </label>
                                            <select class="form-select" @bind="nuevaEvaluacion.Semestre" required>
                                                <option value="">Seleccione...</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-chart-line section-icon"></i>
                                        Puntuación y Resultados
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-star label-icon"></i>
                                                Puntaje Obtenido *
                                            </label>
                                            <input type="number" class="form-input" @bind="nuevaEvaluacion.PuntajeObtenido" 
                                                   min="0" max="100" step="0.01" placeholder="0.00" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-trophy label-icon"></i>
                                                Puntaje Máximo
                                            </label>
                                            <input type="number" class="form-input" @bind="nuevaEvaluacion.PuntajeMaximo" 
                                                   min="0" max="100" step="0.01" placeholder="100.00" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-calendar-day label-icon"></i>
                                                Fecha de Evaluación *
                                            </label>
                                            <input type="date" class="form-input" @bind="nuevaEvaluacion.FechaEvaluacion" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-cogs section-icon"></i>
                                        Detalles de la Evaluación
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-tag label-icon"></i>
                                                Tipo de Evaluación *
                                            </label>
                                            <select class="form-select" @bind="nuevaEvaluacion.TipoEvaluacion" required>
                                                <option value="">Seleccione tipo de evaluación...</option>
                                                <option value="Autoevaluación">Autoevaluación</option>
                                                <option value="Coevaluación">Coevaluación</option>
                                                <option value="Heteroevaluación">Heteroevaluación</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user-tie label-icon"></i>
                                                Evaluador *
                                            </label>
                                            <select class="form-select" @bind="nuevaEvaluacion.Evaluador" required>
                                                <option value="">Seleccione evaluador...</option>
                                                <option value="Evaluación por la Institución">Evaluación por la Institución</option>
                                                <option value="Evaluación por Estudiantes">Evaluación por Estudiantes</option>
                                                <option value="Evaluación por Autoridades">Evaluación por Autoridades</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-info-circle label-icon"></i>
                                                Estado
                                            </label>
                                            <select class="form-select" @bind="nuevaEvaluacion.Estado">
                                                <option value="">Seleccione...</option>
                                                <option value="Completada">Completada</option>
                                                <option value="En Proceso">En Proceso</option>
                                                <option value="Pendiente">Pendiente</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-comment-alt section-icon"></i>
                                        Información Adicional
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-sticky-note label-icon"></i>
                                                Observaciones
                                            </label>
                                            <textarea class="form-textarea" rows="3" @bind="nuevaEvaluacion.Observaciones" 
                                                      placeholder="Observaciones adicionales sobre la evaluación"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-paperclip section-icon"></i>
                                        Archivo Adjunto
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-file-pdf label-icon"></i>
                                                Archivo PDF
                                            </label>
                                            <div class="file-upload-container">
                                                <div class="file-input-hidden">
                                                    <InputFile OnChange="HandleEvaluacionPdfSelected" accept=".pdf" id="evaluacion-file-input" />
                                                </div>
                                                <div class="file-upload-area" onclick="document.getElementById('evaluacion-file-input').click();">
                                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                                    <span class="upload-text">Seleccionar archivo PDF</span>
                                                    <span class="upload-subtext">Arrastra y suelta tu archivo aquí o haz clic para seleccionar<br/>Formatos soportados: PDF • Tamaño máximo: 10MB</span>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrEmpty(evaluacionPdfFileName))
                                            {
                                                <div class="file-selected">
                                                    <i class="fas fa-file-pdf file-icon"></i>
                                                    <span class="file-name">@evaluacionPdfFileName</span>
                                                    <i class="fas fa-check file-check"></i>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-professional btn-primary" @onclick="GuardarEvaluacion" disabled="@isSavingEvaluacion">
                            @if (isSavingEvaluacion)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <i class="fas fa-save me-2"></i>
                                <span>@(editingEvaluacion is not null ? "Actualizar" : "Guardar")</span>
                            }
                        </button>
                        <button class="btn-professional btn-secondary" @onclick="CloseAgregarEvaluacionModal">
                            <i class="fas fa-times me-2"></i>
                            <span>Cancelar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>    }

    @* Modal para Agregar/Editar Capacitaciones *@
    @if (showAgregarCapacitacionModal)
    {
        <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(editingCapacitacion is not null ? "Editar" : "Agregar") Capacitación DITIC</h5>
                        <button type="button" class="btn-close" @onclick="CloseAgregarCapacitacionModal"></button>
                    </div>
                    <div class="modal-body">
                        <form class="professional-form">
                            <div class="form-grid">
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-certificate section-icon"></i>
                                        Información Básica
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-graduation-cap label-icon"></i>
                                                Nombre de la Capacitación *
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaCapacitacion.NombreCapacitacion" 
                                                   placeholder="Ingrese el nombre de la capacitación" required />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-university label-icon"></i>
                                                Institución *
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaCapacitacion.Institucion" 
                                                   placeholder="Nombre de la institución" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user-tie label-icon"></i>
                                                Instructor
                                            </label>
                                            <input type="text" class="form-input" @bind="nuevaCapacitacion.Instructor" 
                                                   placeholder="Nombre del instructor" />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-cogs section-icon"></i>
                                        Características de la Capacitación
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-tag label-icon"></i>
                                                Tipo de Capacitación
                                            </label>
                                            <select class="form-select" @bind="nuevaCapacitacion.TipoCapacitacion">
                                                <option value="">Seleccione...</option>
                                                <option value="Técnica">Técnica</option>
                                                <option value="Pedagogica">Pedagógica</option>
                                                <option value="Investigación">Investigación</option>
                                                <option value="Gestión">Gestión</option>
                                                <option value="Otra">Otra</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-laptop label-icon"></i>
                                                Modalidad
                                            </label>
                                            <select class="form-select" @bind="nuevaCapacitacion.Modalidad">
                                                <option value="">Seleccione...</option>
                                                <option value="Presencial">Presencial</option>
                                                <option value="Virtual">Virtual</option>
                                                <option value="Semipresencial">Semipresencial</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-clock label-icon"></i>
                                                Horas Académicas *
                                            </label>
                                            <input type="number" class="form-input" @bind="nuevaCapacitacion.HorasAcademicas" 
                                                   min="1" placeholder="Número de horas" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-calendar-alt section-icon"></i>
                                        Fechas y Duración
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-play label-icon"></i>
                                                Fecha Inicio *
                                            </label>
                                            <input type="date" class="form-input" @bind="nuevaCapacitacion.FechaInicio" required />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-stop label-icon"></i>
                                                Fecha Fin *
                                            </label>
                                            <input type="date" class="form-input" @bind="nuevaCapacitacion.FechaFin" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-chart-line section-icon"></i>
                                        Estado y Evaluación
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-info-circle label-icon"></i>
                                                Estado
                                            </label>
                                            <select class="form-select" @bind="nuevaCapacitacion.Estado">
                                                <option value="">Seleccione...</option>
                                                <option value="Completada">Completada</option>
                                                <option value="En Progreso">En Progreso</option>
                                                <option value="Aprobada">Aprobada</option>
                                                <option value="Reprobada">Reprobada</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-star label-icon"></i>
                                                Calificación
                                            </label>
                                            <input type="number" class="form-input" @bind="nuevaCapacitacion.Calificacion" 
                                                   min="0" max="100" step="0.01" placeholder="0.00 - 100.00" />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-comment-alt section-icon"></i>
                                        Descripción
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-sticky-note label-icon"></i>
                                                Descripción
                                            </label>
                                            <textarea class="form-textarea" rows="3" @bind="nuevaCapacitacion.Descripcion" 
                                                      placeholder="Descripción de la capacitación"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-paperclip section-icon"></i>
                                        Certificado
                                    </h6>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">
                                                <i class="fas fa-file-pdf label-icon"></i>
                                                Certificado PDF
                                            </label>
                                            <div class="file-upload-container">
                                                <div class="file-input-hidden">
                                                    <InputFile OnChange="HandleCapacitacionPdfSelected" accept=".pdf" id="capacitacion-file-input" />
                                                </div>
                                                <div class="file-upload-area" onclick="document.getElementById('capacitacion-file-input').click();">
                                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                                    <span class="upload-text">Seleccionar certificado PDF</span>
                                                    <span class="upload-subtext">Arrastra y suelta tu certificado aquí o haz clic para seleccionar<br/>Formatos soportados: PDF • Tamaño máximo: 10MB</span>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrEmpty(capacitacionPdfFileName))
                                            {
                                                <div class="file-selected">
                                                    <i class="fas fa-file-pdf file-icon"></i>
                                                    <span class="file-name">@capacitacionPdfFileName</span>
                                                    <i class="fas fa-check file-check"></i>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-professional btn-primary" @onclick="GuardarCapacitacion" disabled="@isSavingCapacitacion">
                            @if (isSavingCapacitacion)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <i class="fas fa-save me-2"></i>
                                <span>@(editingCapacitacion is not null ? "Actualizar" : "Guardar")</span>
                            }
                        </button>
                        <button class="btn-professional btn-secondary" @onclick="CloseAgregarCapacitacionModal">
                            <i class="fas fa-times me-2"></i>
                            <span>Cancelar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Tarjetas de Estadísticas de Promoción -->
    <div class="stats-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
        </div>
        
        @if (estadisticasDocente is null)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando estadísticas...</span>
                </div>
                <p class="mt-3">Cargando estadísticas de promoción...</p>
            </div>
        }
        else
        {
            // Contar el número de secciones para aplicar clase CSS específica
            var numSecciones = estadisticasDocente.Secciones.GetType().GetProperties().Count(p => p.GetValue(estadisticasDocente.Secciones) != null);
            var containerClass = numSecciones == 5 ? "stats-cards-container five-cards" : "stats-cards-container";
            
            <div class="@containerClass">
                @* Generar tarjetas dinámicamente para cada sección de requisitos *@
                @foreach (var seccion in estadisticasDocente.Secciones.GetType().GetProperties())
                {
                    var valorSeccion = seccion.GetValue(estadisticasDocente.Secciones);
                    if (valorSeccion != null)
                    {
                        var tituloPropiedad = valorSeccion.GetType().GetProperty("Titulo");
                        var iconoPropiedad = valorSeccion.GetType().GetProperty("Icono");
                        var datosPropiedad = valorSeccion.GetType().GetProperty("Datos");
                        
                        if (tituloPropiedad != null && iconoPropiedad != null && datosPropiedad != null)
                        {
                            var titulo = tituloPropiedad.GetValue(valorSeccion)?.ToString() ?? seccion.Name;
                            var icono = iconoPropiedad.GetValue(valorSeccion)?.ToString() ?? "fas fa-chart-bar";
                            var datos = datosPropiedad.GetValue(valorSeccion);
                            
                            if (datos != null)
                            {
                                var cumplePropiedad = datos.GetType().GetProperty("Cumple");
                                var detallesPropiedad = datos.GetType().GetProperty("Detalles");
                                
                                if (cumplePropiedad != null)
                                {
                                    var cumple = (bool)(cumplePropiedad.GetValue(datos) ?? false);
                                    var detalles = detallesPropiedad?.GetValue(datos)?.ToString() ?? "";
                                    
                                    <!-- Tarjeta dinámica para @titulo -->
                                    <div class="stat-card @(cumple ? "border-success" : "border-warning")">
                                        @{
                                            // Asignar clase específica para cada tipo de requisito
                                            var claseIcono = seccion.Name switch
                                            {
                                                "Experiencia" => "students",
                                                "Obras" => "courses",
                                                "Evaluaciones" => "schedule",
                                                "Capacitaciones" => "pending",
                                                "Proyectos" => "proyectos",
                                                _ => "courses"
                                            };
                                            
                                            // Si no cumple el requisito, usar pending siempre
                                            if (!cumple) claseIcono = "pending";
                                        }
                                        <div class="stat-icon @claseIcono">
                                            <i class="@icono"></i>
                                        </div>
                                        <div class="stat-content">
                                            @* Mostrar valores específicos según el tipo de requisito *@
                                            @if (seccion.Name == "Experiencia")
                                            {
                                                var añosObtenidos = datos.GetType().GetProperty("AñosObtenidos")?.GetValue(datos);
                                                var añosRequeridos = datos.GetType().GetProperty("AñosRequeridos")?.GetValue(datos);
                                                <h3 class="stat-number">@(añosObtenidos?.ToString() ?? "0")</h3>
                                                <p class="stat-label">Años Experiencia</p>
                                                <small class="text-muted">Requiere: @(añosRequeridos?.ToString() ?? "0") años</small>
                                            }
                                            else if (seccion.Name == "Obras")
                                            {
                                                var obrasConUTA = datos.GetType().GetProperty("ObrasConUTA")?.GetValue(datos);
                                                <h3 class="stat-number">@(obrasConUTA?.ToString() ?? "0")</h3>
                                                <p class="stat-label">Obras con UTA</p>
                                                <small class="text-muted">@detalles</small>
                                            }
                                            else if (seccion.Name == "Evaluaciones")
                                            {
                                                var promedioObtenido = datos.GetType().GetProperty("PromedioObtenido")?.GetValue(datos);
                                                var requiere75 = datos.GetType().GetProperty("Requiere75")?.GetValue(datos);
                                                <h3 class="stat-number">@(promedioObtenido?.ToString() ?? "0")%</h3>
                                                <p class="stat-label">Promedio Evaluaciones</p>
                                                <small class="text-muted">Requiere: @(requiere75?.ToString() ?? "75")%</small>
                                            }
                                            else if (seccion.Name == "Capacitaciones")
                                            {
                                                var horasObtenidas = datos.GetType().GetProperty("HorasObtenidas")?.GetValue(datos);
                                                var horasRequeridas = datos.GetType().GetProperty("HorasRequeridas")?.GetValue(datos);
                                                var horasPedagogicasObtenidas = datos.GetType().GetProperty("HorasPedagogicasObtenidas")?.GetValue(datos);
                                                var horasPedagogicasRequeridas = datos.GetType().GetProperty("HorasPedagogicasRequeridas")?.GetValue(datos);
                                                <h3 class="stat-number">@(horasObtenidas?.ToString() ?? "0")</h3>
                                                <p class="stat-label">Horas Capacitación</p>
                                                <small class="text-muted">Requiere: @(horasRequeridas?.ToString() ?? "0") h (Ped: @(horasPedagogicasObtenidas?.ToString() ?? "0")/@(horasPedagogicasRequeridas?.ToString() ?? "0"))</small>
                                            }
                                            else if (seccion.Name == "Proyectos")
                                            {
                                                var mesesObtenidos = datos.GetType().GetProperty("MesesObtenidos")?.GetValue(datos);
                                                var mesesRequeridos = datos.GetType().GetProperty("MesesRequeridos")?.GetValue(datos);
                                                var proyectosActivos = datos.GetType().GetProperty("ProyectosActivos")?.GetValue(datos);
                                                <h3 class="stat-number">@(mesesObtenidos?.ToString() ?? "0")</h3>
                                                <p class="stat-label">Meses Investigación</p>
                                                <small class="text-muted">Requiere: @(mesesRequeridos?.ToString() ?? "0") meses</small>
                                            }
                                            else
                                            {
                                                @* Para nuevos requisitos que se agreguen *@
                                                var valorObtenidoProp = datos.GetType().GetProperty("ValorObtenido");
                                                var valorRequeridoProp = datos.GetType().GetProperty("ValorRequerido");
                                                var valorObtenido = valorObtenidoProp?.GetValue(datos)?.ToString() ?? "0";
                                                var valorRequerido = valorRequeridoProp?.GetValue(datos)?.ToString() ?? "0";
                                                
                                                <h3 class="stat-number">@valorObtenido</h3>
                                                <p class="stat-label">@titulo</p>
                                                <small class="text-muted">@detalles</small>
                                            }
                                            
                                            @if (cumple)
                                            {
                                                <div class="mt-1"><i class="fas fa-check-circle text-success"></i> Cumple</div>
                                            }
                                            else
                                            {
                                                <div class="mt-1"><i class="fas fa-times-circle text-warning"></i> Pendiente</div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                        }
                    }
                }
            </div>
        }
    </div>

    <!-- Sección de Gestión Académica -->
    <div class="quick-actions">
        <h2 class="section-title">Gestión Académica</h2>
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="action-card" @onclick="() => NavigateToInvestigaciones()">
                    <div class="action-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <h3>Investigaciones</h3>
                    <p>Gestionar y consultar tus proyectos de investigación</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="action-card" @onclick="() => ShowEvaluacionesModal()">
                    <div class="action-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3>Evaluaciones DAC</h3>
                    <p>Consultar evaluaciones de desempeño docente</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="action-card" @onclick="() => ShowCapacitacionesModal()">
                    <div class="action-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h3>Capacitaciones DITIC</h3>
                    <p>Gestionar capacitaciones y actualización profesional</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="action-card" @onclick="() => ShowSolicitudesModal()">
                    <div class="action-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h3>Solicitudes</h3>
                    <p>Ver estado de solicitudes de promoción y escalafón</p>
                </div>
            </div>
        </div>
    </div>
</div>


@code {    private bool showRequisitosModal = false;
    private bool showHistorialModal = false;
    private EstadisticasDocenteResponse? estadisticasDocente = null;
    private bool showInvestigacionesModal = false;
    private bool showEvaluacionesModal = false;
    private bool showCapacitacionesModal = false;
    private bool showSolicitudesModal = false;
    private bool showDetalleSolicitudModal = false;
    private bool showApelacionModal = false;
    private bool showConfirmacionApelacionModal = false;
    private SolicitudDto? solicitudSeleccionada = null;
    private SolicitudDto? solicitudParaApelar = null;
    private string justificacionApelacion = string.Empty;
    private bool isCreatingApelacion = false;
    private List<IBrowserFile> archivosApelacion = new List<IBrowserFile>();
    private string? errorMensajeArchivos = null;
    private bool showAgregarModal = false;
    private bool showAgregarEvaluacionModal = false;
    private bool showAgregarCapacitacionModal = false;
private bool isLoadingInvestigaciones = false;
    private bool isLoadingEvaluaciones = false;
    private bool isLoadingCapacitaciones = false;
    private bool isLoadingSolicitudes = false;
    private bool isLoadingRequisitos = false;    private bool isSaving = false;
    private bool isSavingEvaluacion = false;
    private bool isSavingCapacitacion = false;
    
    // Estadísticas de solicitudes
    private JsonElement? estadisticasSolicitudes = null;
    private bool isLoadingEstadisticasSolicitudes = false;
    
    private List<Investigacion> investigaciones = new();    private List<proyectoAgiles.Services.EvaluacionDesempenoDto> evaluaciones = new();
    private proyectoAgiles.Services.EvaluacionDesempenoDto nuevaEvaluacion = new();
    private proyectoAgiles.Services.EvaluacionDesempenoDto? editingEvaluacion = null;
    private VerificacionRequisito75Dto? verificacionRequisito = null;
      // Variables para DITIC
    private List<ProyectoAgiles.Application.DTOs.DiticDto> capacitaciones = new();
    private ProyectoAgiles.Application.DTOs.DiticDto nuevaCapacitacion = new();
    private ProyectoAgiles.Application.DTOs.DiticDto? editingCapacitacion = null;
    
    
    // Variables para Solicitudes
    private List<SolicitudDto> solicitudes = new();
    
    // Variables para Historial de Escalafones
    private List<HistorialEscalafonDto> historialEscalafones = new();
    private bool isLoadingHistorial = false;
      // Variables para verificación de requisitos de subir de nivel
    private proyectoAgiles.Services.VerificacionRequisitosSubirNivelDto? requisitosVerificacion = null;
    
    // Variables para verificación de requisitos dinámicos
    private proyectoAgiles.Services.VerificacionRequisitosEscalafonDto? requisitosEscalafonDinamicos = null;
    private ProyectoAgiles.Application.DTOs.RequisitoEscalafonConfigDto? configuracionRequisitos = null;
    
    // Variables para controlar el estado de la configuración de tiempo
    private bool isTimeConfigurationActive = false;
    private bool isCheckingTimeConfiguration = false;
    private TimeConfiguration? currentTimeConfig = null;
    
    // Variables para resúmenes dinámicos (se actualizan con la verificación)
    private bool cumpleObrasUTA = false;
    private int obrasConUTARequeridas = 0;
    private int obrasConUTAObtenidas = 0;
    private int totalObrasRequeridas = 0;
    private int totalObrasObtenidas = 0;
    
    private bool cumpleEvaluaciones = false;
    private decimal porcentajeEvaluacionRequerido = 0;
    private decimal porcentajeEvaluacionObtenido = 0;
    private int periodosEvaluacionRequeridos = 0;
    private int periodosEvaluacionAnalizados = 0;
    
    private bool cumpleCapacitaciones = false;
    private int horasCapacitacionRequeridas = 0;
    private int horasCapacitacionObtenidas = 0;
    private int horasPedagogicasRequeridas = 0;
    private int horasPedagogicasObtenidas = 0;
      private Investigacion nuevaInvestigacion = new();
    private Investigacion? editingInvestigacion = null;    private IBrowserFile? selectedPdf;
    private string? pdfFileName;
    private IBrowserFile? selectedEvaluacionPdf;
    private string? evaluacionPdfFileName;
    private IBrowserFile? selectedCapacitacionPdf;
    private string? capacitacionPdfFileName;private void HandlePdfSelected(InputFileChangeEventArgs e)
    {
        selectedPdf = e.File;
        pdfFileName = selectedPdf?.Name;
    }    private void HandleEvaluacionPdfSelected(InputFileChangeEventArgs e)
    {
        selectedEvaluacionPdf = e.File;
        evaluacionPdfFileName = selectedEvaluacionPdf?.Name;
    }

    private void HandleCapacitacionPdfSelected(InputFileChangeEventArgs e)
    {
        selectedCapacitacionPdf = e.File;
        capacitacionPdfFileName = selectedCapacitacionPdf?.Name;
    }private async Task VerPdf(int investigacionId)
    {
        try
        {
            Console.WriteLine($"VerPdf - Solicitando PDF para investigación ID: {investigacionId}");            var pdfBytes = await AuthService.ObtenerPdfInvestigacion(investigacionId);
            Console.WriteLine($"VerPdf - PDF recibido: {pdfBytes?.Length ?? 0} bytes");
            
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"investigacion_{investigacionId}.pdf";
                
                Console.WriteLine($"VerPdf - DataURL generado: {pdfDataUrl.Substring(0, Math.Min(100, pdfDataUrl.Length))}...");
                
                // Usar la función JavaScript personalizada
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                
                if (!success)
                {
                    await MostrarNotificacionExito("PDF descargado", "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                Console.WriteLine("VerPdf - PDF vacío o nulo");
                await MostrarNotificacionError("PDF no disponible", "No se encontró el archivo PDF para esta investigación.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"VerPdf - Error: {ex.Message}");
            await MostrarNotificacionError("Error", $"Error al obtener el PDF: {ex.Message}");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Asegurar que la sesión esté inicializada
        await UserSession.InitializeAsync();
        
        // Refrescar datos del usuario para obtener información actualizada
        await UserSession.RefreshUserDataAsync(HttpClient);
        
        // Forzar actualización de la interfaz después de refrescar datos
        StateHasChanged();
        
        // Verificar que el usuario esté autenticado y sea docente
        if (UserSession.CurrentUser == null || UserSession.CurrentUser.UserType != 2)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // Cargar configuración de requisitos dinámicos
        CargarConfiguracionRequisitos();

        // Verificar si hay configuración de tiempo activa
        await VerificarConfiguracionTiempo();

        await LoadDashboardData();
    }

    private void CargarConfiguracionRequisitos()
    {
        try
        {
            var nivelActual = UserSession.CurrentUser?.Nivel;
            if (!string.IsNullOrEmpty(nivelActual))
            {
                var requisitosService = new ProyectoAgiles.Application.Services.RequisitosEscalafonService();
                configuracionRequisitos = requisitosService.GetRequisitosParaNivel(nivelActual);
                Console.WriteLine($"CargarConfiguracionRequisitos: Configuración cargada para nivel {nivelActual}");
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("CargarConfiguracionRequisitos: Nivel de usuario no disponible");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando configuración de requisitos: {ex.Message}");
        }
    }

    private async Task VerificarConfiguracionTiempo()
    {
        try
        {
            isCheckingTimeConfiguration = true;
            StateHasChanged();
            
            // Verificar si hay configuración activa
            var response = await HttpClient.GetAsync("/api/TimeConfiguration/is-active");
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<bool>();
                isTimeConfigurationActive = result;
                Console.WriteLine($"VerificarConfiguracionTiempo: Configuración activa = {isTimeConfigurationActive}");
                
                // Si hay configuración activa, obtener los detalles
                if (isTimeConfigurationActive)
                {
                    var configResponse = await HttpClient.GetAsync("/api/TimeConfiguration/current");
                    if (configResponse.IsSuccessStatusCode)
                    {
                        currentTimeConfig = await configResponse.Content.ReadFromJsonAsync<TimeConfiguration>();
                    }
                }
                else
                {
                    currentTimeConfig = null;
                }
            }
            else
            {
                Console.WriteLine($"VerificarConfiguracionTiempo: Error al verificar - {response.StatusCode}");
                isTimeConfigurationActive = false;
                currentTimeConfig = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"VerificarConfiguracionTiempo: Excepción - {ex.Message}");
            isTimeConfigurationActive = false;
            currentTimeConfig = null;
        }
        finally
        {
            isCheckingTimeConfiguration = false;
            StateHasChanged();
        }
    }

    private async Task ActualizarConfiguracionTiempo()
    {
        await VerificarConfiguracionTiempo();
    }
    private async Task LoadDashboardData()
    {
        try
        {
            // Cargar estadísticas de promoción
            Console.WriteLine("LoadDashboardData: Iniciando carga inicial de estadísticas...");
            await CargarEstadisticas();
            Console.WriteLine("LoadDashboardData: Estadísticas cargadas al inicializar.");
            
            // NO cargar capacitaciones automáticamente - solo cuando el usuario lo solicite
            Console.WriteLine("LoadDashboardData: Capacitaciones DITIC se cargarán bajo demanda.");
        }
        catch (Exception ex)
        {
            // En caso de error, mostrar mensaje en consola
            Console.WriteLine($"Error cargando estadísticas: {ex.Message}");
            await MostrarNotificacionError("Error al cargar datos", "Hubo un problema al cargar las estadísticas del dashboard.");
        }
    }private void NavigateToInvestigaciones()
    {
        showInvestigacionesModal = true;
        // No cargar automáticamente - solo mostrar tabla vacía
    }

    private void NavigateToEvaluaciones()    {
        showEvaluacionesModal = true;
        // No cargar automáticamente - solo mostrar tabla vacía
    }

    private async Task LoadInvestigaciones()
    {
        isLoadingInvestigaciones = true;
        StateHasChanged();
        
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula ?? string.Empty;
            if (string.IsNullOrEmpty(cedula))
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la cédula del usuario.");
                return;
            }

            // Debug: Mostrar la cédula que se está usando
            Console.WriteLine($"Cargando investigaciones para cédula: {cedula}");

            // Obtener investigaciones disponibles (no utilizadas) de la API
            var response = await HttpClient.GetAsync($"/api/investigaciones/disponibles/{cedula}");
            
            if (response.IsSuccessStatusCode)
            {
                var investigacionesApi = await response.Content.ReadFromJsonAsync<List<proyectoAgiles.Services.InvestigacionDto>>();
                
                Console.WriteLine($"Investigaciones disponibles obtenidas de la API: {investigacionesApi?.Count ?? 0}");
                
                if (investigacionesApi == null || !investigacionesApi.Any())
                {
                    investigaciones = new List<Investigacion>();
                    await JSRuntime.InvokeVoidAsync("console.log", $"No se encontraron investigaciones disponibles para la cédula: {cedula}");
                    return;
                }
                
                // Mapear de InvestigacionDto a nuestro modelo local
                investigaciones = investigacionesApi.Select(inv => new Investigacion
                {
                    Id = inv.Id,
                    Cedula = inv.Cedula,
                    Titulo = inv.Titulo,
                    Tipo = inv.Tipo,
                    RevistaOEditorial = inv.RevistaOEditorial,
                    Area = inv.CampoConocimiento, // Mapear CampoConocimiento a Area
                    Estado = DeterminarEstado(inv.FechaPublicacion), // Determinar estado basado en fecha
                    FechaInicio = inv.FechaPublicacion, // Usar FechaPublicacion como FechaInicio
                    FechaFin = null, // No hay fecha fin en la base de datos
                    Descripcion = inv.Observacion, // Mapear Observacion a Descripcion
                    Filiacion = inv.Filiacion,
                    TienePdf = inv.TienePdf // Verificar si tiene PDF
                }).ToList();

                Console.WriteLine($"Investigaciones disponibles mapeadas: {investigaciones.Count}");
            }
            else
            {
                // Fallback: usar el método anterior si la nueva API no está disponible
                Console.WriteLine("API de investigaciones disponibles no encontrada, usando método anterior");
                var investigacionesApi = await AuthService.GetInvestigacionesPorCedula(cedula);
                
                if (investigacionesApi != null && investigacionesApi.Any())
                {
                    investigaciones = investigacionesApi.Select(inv => new Investigacion
                    {
                        Id = inv.Id,
                        Cedula = inv.Cedula,
                        Titulo = inv.Titulo,
                        Tipo = inv.Tipo,
                        RevistaOEditorial = inv.RevistaOEditorial,
                        Area = inv.CampoConocimiento,
                        Estado = DeterminarEstado(inv.FechaPublicacion),
                        FechaInicio = inv.FechaPublicacion,
                        FechaFin = null,
                        Descripcion = inv.Observacion,
                        Filiacion = inv.Filiacion,
                        TienePdf = inv.TienePdf,
                        TieneFiliacionUTA = !string.IsNullOrEmpty(inv.Filiacion) && inv.Filiacion.ToUpper().Contains("UTA")
                    }).ToList();
                    
                    Console.WriteLine($"Investigaciones cargadas: {investigaciones.Count}");
                }
                else
                {
                    investigaciones = new List<Investigacion>();
                }
            }
            
            // Actualizar resúmenes dinámicos para sincronizar con los datos cargados
            await ActualizarResumenesDinamicos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar investigaciones: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar investigaciones: {ex.Message}");
            investigaciones = new List<Investigacion>();
        }
        finally
        {
            isLoadingInvestigaciones = false;
            StateHasChanged();
        }
    }    private async Task ImportarInvestigaciones()
    {
        isLoadingInvestigaciones = true;
        StateHasChanged();
        
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula ?? string.Empty;
            if (string.IsNullOrEmpty(cedula))
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la cédula del usuario.");
                return;
            }

            // Cargar las investigaciones desde la base de datos
            await LoadInvestigaciones();
              if (investigaciones.Any())
            {
                await MostrarNotificacionExito($"📊 Importación Exitosa", 
                    $"Se han cargado {investigaciones.Count} investigación{(investigaciones.Count > 1 ? "es" : "")} desde la base de datos institucional.");
            }
            else
            {                await MostrarNotificacionInfo("ℹ️ Sin Datos Disponibles", 
                    "No se encontraron investigaciones asociadas a tu cédula en la base de datos institucional.");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("❌ Error de importación", 
                $"No se pudieron cargar las investigaciones: {ex.Message}");
        }
        finally
        {
            isLoadingInvestigaciones = false;
            StateHasChanged();
        }
    }

    private void ShowAgregarInvestigacion()
    {
        editingInvestigacion = null;
        nuevaInvestigacion = new Investigacion();
        showAgregarModal = true;
    }    private void EditarInvestigacion(Investigacion investigacion)
    {
        editingInvestigacion = investigacion;
        nuevaInvestigacion = new Investigacion
        {
            Id = investigacion.Id,
            Titulo = investigacion.Titulo,
            Area = investigacion.Area,
            FechaInicio = investigacion.FechaInicio,
            RevistaOEditorial = investigacion.RevistaOEditorial,
            Descripcion = investigacion.Descripcion,
            Filiacion = investigacion.Filiacion
        };
        showAgregarModal = true;
    }private async Task GuardarInvestigacion()
    {
        if (string.IsNullOrWhiteSpace(nuevaInvestigacion.Titulo) || 
            string.IsNullOrWhiteSpace(nuevaInvestigacion.Area))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Por favor complete los campos obligatorios.");
            return;
        }

        isSaving = true;
        StateHasChanged();

        try
        {
            var cedula = UserSession.CurrentUser?.Cedula ?? string.Empty;
            if (string.IsNullOrEmpty(cedula))            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la cédula del usuario.");
                return;
            }
            
            if (editingInvestigacion is not null)
            {
                // Verificar si se ha seleccionado un nuevo PDF
                if (selectedPdf is not null)
                {
                    // Actualizar con PDF
                    var updateWithPdfDto = new proyectoAgiles.Services.UpdateInvestigacionWithPdfDto
                    {
                        Id = editingInvestigacion.Id,
                        Cedula = cedula,
                        Titulo = nuevaInvestigacion.Titulo,
                        Tipo = "Artículo", // Valor por defecto
                        RevistaOEditorial = !string.IsNullOrWhiteSpace(nuevaInvestigacion.RevistaOEditorial) ? nuevaInvestigacion.RevistaOEditorial : "N/A",
                        FechaPublicacion = nuevaInvestigacion.FechaInicio,
                        CampoConocimiento = nuevaInvestigacion.Area,
                        Filiacion = nuevaInvestigacion.Filiacion ?? "Universidad Técnica de Ambato",
                        Observacion = nuevaInvestigacion.Descripcion ?? "",
                        ArchivoPdf = selectedPdf
                    };

                    var updatedWithPdf = await AuthService.ActualizarInvestigacionConPdf(updateWithPdfDto);
                    
                    // Actualizar en la lista local
                    var index = investigaciones.FindIndex(i => i.Id == editingInvestigacion.Id);
                    if (index >= 0)
                    {
                        investigaciones[index] = MapearDesdeDto(updatedWithPdf);
                    }
                }
                else
                {
                    // Actualizar sin PDF (solo datos)
                    var updateDto = new proyectoAgiles.Services.UpdateInvestigacionDto
                    {
                        Id = editingInvestigacion.Id,
                        Cedula = cedula,
                        Titulo = nuevaInvestigacion.Titulo,
                        Tipo = "Artículo", // Valor por defecto
                        RevistaOEditorial = !string.IsNullOrWhiteSpace(nuevaInvestigacion.RevistaOEditorial) ? nuevaInvestigacion.RevistaOEditorial : "N/A",
                        FechaPublicacion = nuevaInvestigacion.FechaInicio,
                        CampoConocimiento = nuevaInvestigacion.Area,
                        Filiacion = nuevaInvestigacion.Filiacion ?? "Universidad Técnica de Ambato",
                        Observacion = nuevaInvestigacion.Descripcion ?? ""
                    };

                    var updated = await AuthService.ActualizarInvestigacion(updateDto);
                    
                    // Actualizar en la lista local
                    var index = investigaciones.FindIndex(i => i.Id == editingInvestigacion.Id);
                    if (index >= 0)
                    {
                        investigaciones[index] = MapearDesdeDto(updated);
                    }
                }
            }
            else
            {
                // Crear nueva investigación
                var createDto = new proyectoAgiles.Services.CreateInvestigacionWithPdfDto
                {
                    Cedula = cedula,
                    Titulo = nuevaInvestigacion.Titulo,
                    Tipo = "Artículo",
                    RevistaOEditorial = !string.IsNullOrWhiteSpace(nuevaInvestigacion.RevistaOEditorial) ? nuevaInvestigacion.RevistaOEditorial : "N/A",
                    FechaPublicacion = nuevaInvestigacion.FechaInicio,
                    CampoConocimiento = nuevaInvestigacion.Area,
                    Filiacion = nuevaInvestigacion.Filiacion ?? "Universidad Técnica de Ambato",
                    Observacion = nuevaInvestigacion.Descripcion ?? "",
                    ArchivoPdf = selectedPdf
                };

                var created = await AuthService.CrearInvestigacionConPdf(createDto);
                investigaciones.Add(MapearDesdeDto(created));            }              CloseAgregarModal();
            await MostrarNotificacionExito("🎉 Investigación Guardada",
                editingInvestigacion is not null ? 
                "La investigación ha sido actualizada exitosamente en el sistema." : 
                "La nueva investigación ha sido registrada correctamente y está disponible en tu perfil académico.");
            
            // Actualizar estadísticas automáticamente con mejor logging
            Console.WriteLine("GuardarInvestigacion: Iniciando actualización de estadísticas...");
            await Task.Delay(500); // Esperar medio segundo para que el backend procese
            await CargarEstadisticas();
            Console.WriteLine("GuardarInvestigacion: Estadísticas actualizadas.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }    private async Task EliminarInvestigacion(int id)
    {
        var confirmDelete = await JSRuntime.InvokeAsync<bool>("confirm", 
            "¿Está seguro de que desea eliminar esta investigación?");
        
        if (confirmDelete)
        {
            try
            {
                // Eliminar de la base de datos
                var success = await AuthService.EliminarInvestigacion(id);
                  if (success)
                {                    // Eliminar de la lista local
                    investigaciones.RemoveAll(i => i.Id == id);
                    await MostrarNotificacionExito("🗑️ Eliminación Exitosa", "La investigación ha sido eliminada permanentemente del sistema.");
                    
                    // Actualizar estadísticas automáticamente con mejor logging
                    Console.WriteLine("EliminarInvestigacion: Iniciando actualización de estadísticas...");
                    await CargarEstadisticas();
                    Console.WriteLine("EliminarInvestigacion: Estadísticas actualizadas.");
                    StateHasChanged();
                }                else
                {
                    await MostrarNotificacionError("❌ Error de Eliminación", "No se pudo completar la eliminación de la investigación. Inténtalo nuevamente.");
                }
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error al eliminar: {ex.Message}");
            }
        }
    }private void CloseInvestigacionesModal()
    {
        showInvestigacionesModal = false;
    }

    // Métodos para Evaluaciones de Desempeño
    private void CloseEvaluacionesModal()
    {
        showEvaluacionesModal = false;
    }

    private void CloseSolicitudesModal()
    {
        showSolicitudesModal = false;
    }    private async Task ImportarEvaluaciones()
    {
        try
        {
            if (UserSession.CurrentUser?.Cedula == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la cédula del usuario");
                return;
            }

            isLoadingEvaluaciones = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser.Cedula;

            // Importar solo evaluaciones disponibles (no utilizadas en escalafones previos)
            var response = await HttpClient.GetAsync($"/api/EvaluacionesDesempeno/disponibles/{cedula}");
            List<proyectoAgiles.Services.EvaluacionDesempenoDto>? apiEvaluaciones = null;
            
            if (response.IsSuccessStatusCode)
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                apiEvaluaciones = System.Text.Json.JsonSerializer.Deserialize<List<proyectoAgiles.Services.EvaluacionDesempenoDto>>(
                    jsonResponse, 
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            
            if (apiEvaluaciones is not null && apiEvaluaciones.Any())
            {
                evaluaciones = apiEvaluaciones.ToList();
                
                Console.WriteLine($"Evaluaciones cargadas: {evaluaciones.Count}");

                // Actualizar verificación del requisito 75%
                await ActualizarVerificacionRequisito75();
                
                // Actualizar resúmenes dinámicos para sincronizar con los datos cargados
                await ActualizarResumenesDinamicos();
                  
                await MostrarNotificacionExito($"📊 Evaluaciones Importadas", 
                    $"Se han cargado {evaluaciones.Count} evaluación{(evaluaciones.Count != 1 ? "es" : "")} desde la base de datos DAC.");
            }
            else
            {
                evaluaciones = new List<proyectoAgiles.Services.EvaluacionDesempenoDto>();
                await MostrarNotificacionInfo("ℹ️ Sin Datos Disponibles", "No se encontraron evaluaciones de desempeño asociadas a tu cédula en la base de datos DAC.");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("❌ Error de importación", 
                $"No se pudieron cargar las evaluaciones: {ex.Message}");
        }
        finally
        {
            isLoadingEvaluaciones = false;
            StateHasChanged();
        }
    }

    private async Task ImportarSolicitudes()
    {
        try
        {
            if (UserSession.CurrentUser?.Cedula == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la cédula del usuario");
                return;
            }

            isLoadingSolicitudes = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser.Cedula;

            // Obtener solicitudes reales desde la API
            var apiSolicitudes = await AuthService.GetSolicitudesPorCedula(cedula);
            
            if (apiSolicitudes is not null && apiSolicitudes.Any())
            {
                // Debug: mostrar los estados originales
                await JSRuntime.InvokeVoidAsync("console.log", "Estados originales de las solicitudes:");
                foreach (var s in apiSolicitudes)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", $"Solicitud {s.Id}: Status='{s.Status}' -> Mapeado='{MapearEstado(s.Status)}'");
                }

                // Mapear las solicitudes de la API a nuestro modelo local
                solicitudes = apiSolicitudes.Select(s => new SolicitudDto
                {
                    Id = s.Id,
                    TipoSolicitud = "Promoción de Escalafón", // No hay TipoSolicitud en el DTO, usar valor fijo
                    Estado = MapearEstado(s.Status), // Mapear el estado para mejor visualización
                    FechaSolicitud = s.FechaSolicitud,
                    FechaRespuesta = s.FechaAprobacion ?? s.FechaRechazo, // Usar la fecha que esté disponible
                    NivelActual = s.NivelActual ?? "No especificado",
                    NivelSolicitado = s.NivelSolicitado ?? "No especificado",
                    Observaciones = s.Observaciones ?? "Sin observaciones",
                    MotivoRechazo = s.MotivoRechazo,
                    MotivoRechazoConsejo = s.MotivoRechazoConsejo
                }).ToList();

                // Debug: Mostrar información de mapeo de estados
                await JSRuntime.InvokeVoidAsync("console.log", "=== DEBUG SOLICITUDES ===");
                foreach (var solicitud in solicitudes)
                {
                    var estadoOriginal = apiSolicitudes.FirstOrDefault(a => a.Id == solicitud.Id)?.Status;
                    var esRechazada = solicitud.Estado.ToLower().Contains("rechazada") || 
                                      solicitud.Estado.ToLower().Contains("rechazado") ||
                                      solicitud.Estado.ToLower().Contains("denegada") ||
                                      solicitud.Estado.ToLower().Contains("denegado");
                    await JSRuntime.InvokeVoidAsync("console.log", $"Solicitud #{solicitud.Id}: Estado original='{estadoOriginal}', Estado mapeado='{solicitud.Estado}', Es rechazada={esRechazada}");
                }
                await JSRuntime.InvokeVoidAsync("console.log", "========================");
                
                await MostrarNotificacionExito($"📋 Solicitudes Importadas", 
                    $"Se han cargado {solicitudes.Count} solicitud{(solicitudes.Count != 1 ? "es" : "")} desde la base de datos.");
                
                // Cargar estadísticas después de importar las solicitudes
                await CargarEstadisticasSolicitudes();
            }
            else
            {
                solicitudes = new List<SolicitudDto>();
                await MostrarNotificacionInfo("ℹ️ Sin Datos Disponibles", 
                    "No se encontraron solicitudes asociadas a tu cédula en la base de datos.");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("❌ Error de importación", 
                $"No se pudieron cargar las solicitudes: {ex.Message}");
            solicitudes = new List<SolicitudDto>();
        }
        finally
        {
            isLoadingSolicitudes = false;
            StateHasChanged();
        }
    }

    private async Task CargarEstadisticasSolicitudes()
    {
        try
        {
            if (UserSession.CurrentUser?.Cedula == null)
            {
                return;
            }

            isLoadingEstadisticasSolicitudes = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser.Cedula;
            var response = await HttpClient.GetAsync($"api/solicitudes-escalafon/estadisticas/{cedula}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                estadisticasSolicitudes = JsonSerializer.Deserialize<JsonElement>(content);
                
                // Debug: Log de estadísticas obtenidas
                await JSRuntime.InvokeVoidAsync("console.log", "=== ESTADÍSTICAS OBTENIDAS ===");
                await JSRuntime.InvokeVoidAsync("console.log", content);
                await JSRuntime.InvokeVoidAsync("console.log", "===============================");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"Error al obtener estadísticas: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error al cargar estadísticas: {ex.Message}");
        }
        finally
        {
            isLoadingEstadisticasSolicitudes = false;
            StateHasChanged();
        }
    }

    private void ShowAgregarEvaluacion()
    {        nuevaEvaluacion = new proyectoAgiles.Services.EvaluacionDesempenoDto
        {
            Cedula = UserSession.CurrentUser?.Cedula ?? "",
            FechaEvaluacion = DateTime.Now,
            Anio = DateTime.Now.Year,
            Semestre = DateTime.Now.Month <= 6 ? 1 : 2,
            PuntajeMaximo = 100,
            TipoEvaluacion = "Integral",
            Estado = "Completada"
        };
        editingEvaluacion = null;
        selectedEvaluacionPdf = null;
        evaluacionPdfFileName = null;
        showAgregarEvaluacionModal = true;
        StateHasChanged();
    }

    private void CloseAgregarEvaluacionModal()
    {
        showAgregarEvaluacionModal = false;
        editingEvaluacion = null;
        nuevaEvaluacion = new proyectoAgiles.Services.EvaluacionDesempenoDto();
        selectedEvaluacionPdf = null;
        evaluacionPdfFileName = null;
        StateHasChanged();
    }    private async Task GuardarEvaluacion()
    {
        try
        {            if (string.IsNullOrWhiteSpace(nuevaEvaluacion.PeriodoAcademico) ||
                string.IsNullOrWhiteSpace(nuevaEvaluacion.Cedula))
            {
                await MostrarNotificacionError("🔒 Error de Validación", "Todos los campos obligatorios deben estar completados antes de guardar la evaluación.");
                return;
            }

            isSavingEvaluacion = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser?.Cedula ?? string.Empty;
            if (string.IsNullOrEmpty(cedula))
            {
                await MostrarNotificacionError("Error", "No se pudo obtener la cédula del usuario.");
                return;
            }
            
            if (editingEvaluacion is not null)
            {
                // Verificar si se ha seleccionado un nuevo PDF
                if (selectedEvaluacionPdf is not null)
                {
                    // Actualizar con PDF
                    var updateWithPdfDto = new proyectoAgiles.Services.UpdateEvaluacionDesempenoWithPdfDto
                    {
                        Id = editingEvaluacion.Id,
                        Cedula = cedula,
                        PeriodoAcademico = nuevaEvaluacion.PeriodoAcademico,
                        Anio = nuevaEvaluacion.Anio,
                        Semestre = nuevaEvaluacion.Semestre,
                        PuntajeObtenido = nuevaEvaluacion.PuntajeObtenido,
                        PuntajeMaximo = nuevaEvaluacion.PuntajeMaximo,
                        FechaEvaluacion = nuevaEvaluacion.FechaEvaluacion,
                        TipoEvaluacion = nuevaEvaluacion.TipoEvaluacion,
                        Observaciones = nuevaEvaluacion.Observaciones,
                        Estado = nuevaEvaluacion.Estado,
                        Evaluador = nuevaEvaluacion.Evaluador,
                        ArchivoPdf = selectedEvaluacionPdf
                    };

                    var updatedWithPdf = await AuthService.ActualizarEvaluacionConPdf(updateWithPdfDto);
                    
                    // Actualizar en la lista local
                    var index = evaluaciones.FindIndex(e => e.Id == editingEvaluacion.Id);
                    if (index >= 0)
                    {
                        evaluaciones[index] = updatedWithPdf;
                    }
                }
                else
                {
                    // Actualizar sin PDF (solo datos)
                    var updateDto = new proyectoAgiles.Services.UpdateEvaluacionDesempenoDto
                    {
                        Id = editingEvaluacion.Id,
                        Cedula = cedula,
                        PeriodoAcademico = nuevaEvaluacion.PeriodoAcademico,
                        Anio = nuevaEvaluacion.Anio,
                        Semestre = nuevaEvaluacion.Semestre,
                        PuntajeObtenido = nuevaEvaluacion.PuntajeObtenido,
                        PuntajeMaximo = nuevaEvaluacion.PuntajeMaximo,
                        FechaEvaluacion = nuevaEvaluacion.FechaEvaluacion,
                        TipoEvaluacion = nuevaEvaluacion.TipoEvaluacion,
                        Observaciones = nuevaEvaluacion.Observaciones,
                        Estado = nuevaEvaluacion.Estado,
                        Evaluador = nuevaEvaluacion.Evaluador
                    };

                    var updated = await AuthService.ActualizarEvaluacion(updateDto);
                    
                    // Actualizar en la lista local
                    var index = evaluaciones.FindIndex(e => e.Id == editingEvaluacion.Id);
                    if (index >= 0)
                    {
                        evaluaciones[index] = updated;
                    }
                }
            }
            else
            {
                // Crear nueva evaluación
                if (selectedEvaluacionPdf is not null)
                {
                    // Crear con PDF
                    var createWithPdfDto = new proyectoAgiles.Services.CreateEvaluacionDesempenoWithPdfDto
                    {
                        Cedula = cedula,
                        PeriodoAcademico = nuevaEvaluacion.PeriodoAcademico,
                        Anio = nuevaEvaluacion.Anio,
                        Semestre = nuevaEvaluacion.Semestre,
                        PuntajeObtenido = nuevaEvaluacion.PuntajeObtenido,
                        PuntajeMaximo = nuevaEvaluacion.PuntajeMaximo,
                        FechaEvaluacion = nuevaEvaluacion.FechaEvaluacion,
                        TipoEvaluacion = nuevaEvaluacion.TipoEvaluacion,
                        Observaciones = nuevaEvaluacion.Observaciones,
                        Estado = nuevaEvaluacion.Estado,
                        Evaluador = nuevaEvaluacion.Evaluador,
                        ArchivoPdf = selectedEvaluacionPdf
                    };

                    var created = await AuthService.CrearEvaluacionConPdf(createWithPdfDto);
                    evaluaciones.Add(created);
                }
                else
                {
                    // Crear sin PDF
                    var createDto = new proyectoAgiles.Services.CreateEvaluacionDesempenoDto
                    {
                        Cedula = cedula,
                        PeriodoAcademico = nuevaEvaluacion.PeriodoAcademico,
                        Anio = nuevaEvaluacion.Anio,
                        Semestre = nuevaEvaluacion.Semestre,
                        PuntajeObtenido = nuevaEvaluacion.PuntajeObtenido,
                        PuntajeMaximo = nuevaEvaluacion.PuntajeMaximo,
                        FechaEvaluacion = nuevaEvaluacion.FechaEvaluacion,
                        TipoEvaluacion = nuevaEvaluacion.TipoEvaluacion,
                        Observaciones = nuevaEvaluacion.Observaciones,
                        Estado = nuevaEvaluacion.Estado,
                        Evaluador = nuevaEvaluacion.Evaluador
                    };

                    var created = await AuthService.CrearEvaluacion(createDto);
                    evaluaciones.Add(created);
                }
            }              CloseAgregarEvaluacionModal();
            await MostrarNotificacionExito("🎯 Evaluación Registrada",
                editingEvaluacion is not null ? 
                "La evaluación de desempeño ha sido actualizada correctamente en el sistema académico." : 
                "La nueva evaluación DAC ha sido registrada exitosamente y contribuye a tu perfil de promoción.");
            
            // Actualizar estadísticas automáticamente con mejor logging
            Console.WriteLine("GuardarEvaluacion: Iniciando actualización de estadísticas...");
            await Task.Delay(500); // Esperar medio segundo para que el backend procese
            await CargarEstadisticas();
            Console.WriteLine("GuardarEvaluacion: Estadísticas actualizadas.");
            
            // Actualizar verificación del requisito 75%
            await ActualizarVerificacionRequisito75();
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("Error inesperado", $"Ocurrió un error: {ex.Message}");
        }
        finally
        {
            isSavingEvaluacion = false;
            StateHasChanged();
        }
    }    private void EditarEvaluacion(proyectoAgiles.Services.EvaluacionDesempenoDto evaluacion)
    {
        editingEvaluacion = evaluacion;
        nuevaEvaluacion = new proyectoAgiles.Services.EvaluacionDesempenoDto
        {
            Id = evaluacion.Id,
            Cedula = evaluacion.Cedula,
            PeriodoAcademico = evaluacion.PeriodoAcademico,
            Anio = evaluacion.Anio,
            Semestre = evaluacion.Semestre,
            PuntajeObtenido = evaluacion.PuntajeObtenido,
            PuntajeMaximo = evaluacion.PuntajeMaximo,
            FechaEvaluacion = evaluacion.FechaEvaluacion,
            TipoEvaluacion = evaluacion.TipoEvaluacion,
            Observaciones = evaluacion.Observaciones,
            Estado = evaluacion.Estado,
            Evaluador = evaluacion.Evaluador
        };
        
        selectedEvaluacionPdf = null;
        evaluacionPdfFileName = null;
        showAgregarEvaluacionModal = true;
        StateHasChanged();
    }    private async Task EliminarEvaluacion(int id)
    {
        var confirmacion = await JSRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de que quieres eliminar esta evaluación? Esta acción no se puede deshacer.");
        
        if (confirmacion)
        {
            try
            {
                var success = await AuthService.EliminarEvaluacion(id);
                  if (success)
                {                    // Eliminar de la lista local
                    evaluaciones.RemoveAll(e => e.Id == id);
                    await MostrarNotificacionExito("🗑️ Evaluación Eliminada", "La evaluación de desempeño ha sido eliminada permanentemente del sistema.");
                    
                    // Actualizar estadísticas automáticamente
                    await Task.Delay(500); // Esperar medio segundo para que el backend procese
                    await CargarEstadisticas();
                    
                    // Actualizar verificación del requisito 75%
                    await ActualizarVerificacionRequisito75();
                    StateHasChanged();
                }else
                {
                    await MostrarNotificacionError("❌ Error de Eliminación", "No se pudo eliminar la evaluación. Verifica tu conexión e inténtalo nuevamente.");
                }
            }
            catch (Exception ex)
            {
                await MostrarNotificacionError("Error inesperado", $"Ocurrió un error al eliminar la evaluación: {ex.Message}");
            }
        }
    }private async Task VerPdfEvaluacion(int id)
    {
        try
        {
            Console.WriteLine($"VerPdfEvaluacion - Solicitando PDF para evaluación ID: {id}");
            
            var pdfBytes = await AuthService.ObtenerPdfEvaluacion(id);
            Console.WriteLine($"VerPdfEvaluacion - PDF recibido: {pdfBytes?.Length ?? 0} bytes");
            
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"evaluacion_{id}.pdf";
                
                Console.WriteLine($"VerPdfEvaluacion - DataURL generado: {pdfDataUrl.Substring(0, Math.Min(100, pdfDataUrl.Length))}...");
                
                // Usar la función JavaScript personalizada
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                
                if (!success)
                {
                    await MostrarNotificacionExito("PDF descargado", "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                Console.WriteLine("VerPdfEvaluacion - PDF vacío o nulo");
                await MostrarNotificacionError("PDF no disponible", "No se encontró el archivo PDF para esta evaluación.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"VerPdfEvaluacion - Error: {ex.Message}");
            await MostrarNotificacionError("Error", $"Error al obtener el PDF: {ex.Message}");
        }
    }

    private void CloseAgregarModal()
    {
        showAgregarModal = false;
        nuevaInvestigacion = new Investigacion();
        editingInvestigacion = null;
        selectedPdf = null;
        pdfFileName = null;
    }

    private string DeterminarEstado(DateTime fechaPublicacion)
    {
        // Si la fecha de publicación es futura, está en revisión
        if (fechaPublicacion > DateTime.Now)
        {
            return "En revisión";
        }
        // Si la fecha es pasada, está completado
        return "Completado";
    }

    private int GetDaysRemaining()
    {
        if (currentTimeConfig == null)
            return 0;
        
        var daysRemaining = (currentTimeConfig.EndDate - DateTime.Now).Days;
        return Math.Max(0, daysRemaining);
    }

    private Investigacion MapearDesdeDto(proyectoAgiles.Services.InvestigacionDto dto)
    {
        return new Investigacion
        {
            Id = dto.Id,
            Cedula = dto.Cedula,
            Titulo = dto.Titulo,
            Tipo = dto.Tipo,
            RevistaOEditorial = dto.RevistaOEditorial,
            Area = dto.CampoConocimiento,
            Estado = DeterminarEstado(dto.FechaPublicacion),
            FechaInicio = dto.FechaPublicacion,
            FechaFin = null,
            Descripcion = dto.Observacion,
            Filiacion = dto.Filiacion,
            TienePdf = dto.TienePdf // Agregar mapeo de TienePdf
        };
    }private async Task Logout()
    {
        await UserSession.ClearSessionAsync();
        Navigation.NavigateTo("/");
    }    private async Task VerificarRequisitos()
    {
        var cedula = UserSession.CurrentUser?.Cedula;
        var nivelActual = UserSession.CurrentUser?.Nivel;
        
        if (string.IsNullOrEmpty(cedula) || string.IsNullOrEmpty(nivelActual))
        {
            await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener la información del usuario actual.");
            return;
        }

        try
        {
            isLoadingRequisitos = true;
            StateHasChanged();

            // Obtener configuración de requisitos para el nivel actual
            var requisitosService = new ProyectoAgiles.Application.Services.RequisitosEscalafonService();
            configuracionRequisitos = requisitosService.GetRequisitosParaNivel(nivelActual);

            // Verificar si puede ascender
            if (!requisitosService.PuedeAscender(nivelActual))
            {
                await JSRuntime.InvokeVoidAsync("alert", 
                    $"Ha alcanzado el nivel máximo en el escalafón académico: {nivelActual}");
                return;
            }

            Console.WriteLine("VerificarRequisitos: Obteniendo datos EXCLUSIVAMENTE de la API...");
            
            // Usar solo verificación dinámica que viene de la API - NO hacer cálculos locales
            requisitosEscalafonDinamicos = await AuthService.VerificarRequisitosEscalafonDinamico(cedula, nivelActual);
            
            // Mantener compatibilidad con el sistema anterior para la UI
            var verificacion = await AuthService.VerificarRequisitosSubirNivel(cedula);
            requisitosVerificacion = verificacion;
            
            Console.WriteLine($"VerificarRequisitos: Datos obtenidos de API:");
            if (requisitosEscalafonDinamicos != null)
            {
                Console.WriteLine($"  - Capacitación cumple: {requisitosEscalafonDinamicos.Capacitacion.Cumple}");
                Console.WriteLine($"  - Capacitación valor: {requisitosEscalafonDinamicos.Capacitacion.ValorObtenido}");
                Console.WriteLine($"  - Cumple todos los requisitos: {requisitosEscalafonDinamicos.CumpleTodosRequisitos}");
            }
            
            showRequisitosModal = true;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al verificar requisitos: {ex.Message}");
        }
        finally
        {
            isLoadingRequisitos = false;
            StateHasChanged();
        }
    }    private async Task ShowRequisitosModal()
    {
        // Verificar configuración de tiempo antes de mostrar el modal
        await VerificarConfiguracionTiempo();
        
        requisitosVerificacion = null; // Limpiar verificación anterior
        requisitosEscalafonDinamicos = null; // Limpiar verificación dinámica anterior
        showRequisitosModal = true;
    }    private void CloseRequisitosModal()    {
        showRequisitosModal = false;
    }

    private async Task ShowHistorialModal()
    {
        showHistorialModal = true;
        await CargarHistorialEscalafones();
    }

    private void CloseHistorialModal()
    {
        showHistorialModal = false;
    }

    private async Task CargarHistorialEscalafones()
    {
        try
        {
            isLoadingHistorial = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser?.Cedula;
            if (string.IsNullOrEmpty(cedula))
            {
                await JSRuntime.InvokeVoidAsync("console.error", "No se encontró la cédula del usuario");
                return;
            }

            await JSRuntime.InvokeVoidAsync("console.log", $"Cargando historial para cédula: {cedula}");

            // Llamar al endpoint para obtener el historial
            var response = await HttpClient.GetAsync($"/api/escalafon/historial/{cedula}");
            
            await JSRuntime.InvokeVoidAsync("console.log", $"Respuesta del endpoint: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("console.log", $"Contenido de la respuesta: {responseContent}");
                
                var historial = await response.Content.ReadFromJsonAsync<List<HistorialEscalafonDto>>();
                historialEscalafones = historial ?? new List<HistorialEscalafonDto>();
                
                await JSRuntime.InvokeVoidAsync("console.log", $"Historial cargado: {historialEscalafones.Count} registros");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("console.error", $"Error en la respuesta: {response.StatusCode} - {errorContent}");
                historialEscalafones = new List<HistorialEscalafonDto>();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error cargando historial: {ex.Message}");
            historialEscalafones = new List<HistorialEscalafonDto>();
        }
        finally
        {
            isLoadingHistorial = false;
            StateHasChanged();
        }
    }

    private async Task CargarEstadisticas()
    {
        var cedula = UserSession.CurrentUser?.Cedula;
        if (string.IsNullOrEmpty(cedula))
        {
            Console.WriteLine("CargarEstadisticas: No se pudo obtener la cédula del usuario actual.");
            return;
        }

        try
        {
            Console.WriteLine($"CargarEstadisticas: Iniciando carga para cédula {cedula}");
            StateHasChanged();

            // Limpiar estadísticas anteriores para forzar recarga
            estadisticasDocente = null;
            StateHasChanged();

            // Agregar un pequeño delay para asegurar que la UI se actualice
            await Task.Delay(100);

            // Obtener estadísticas directamente de la API (ya excluye documentos utilizados)
            var estadisticasOriginales = await AuthService.ObtenerEstadisticasDocente(cedula);
            
            if (estadisticasOriginales is not null)
            {
                // Usar las estadísticas tal como las devuelve la API
                estadisticasDocente = estadisticasOriginales;
                
                Console.WriteLine($"CargarEstadisticas: Estadísticas cargadas exitosamente de la API");
                Console.WriteLine($"CargarEstadisticas: Total requisitos = {estadisticasDocente.Resumen?.TotalRequisitos}");
                Console.WriteLine($"CargarEstadisticas: Requisitos cumplidos = {estadisticasDocente.Resumen?.RequisitosCumplidos}");
                Console.WriteLine($"CargarEstadisticas: Porcentaje = {estadisticasDocente.Resumen?.PorcentajeCompletitud}%");
            }
            else
            {
                Console.WriteLine("CargarEstadisticas: Las estadísticas son null");
            }
            
            // Forzar actualización de la UI múltiples veces para asegurar que se vea
            StateHasChanged();
            await Task.Delay(50);
            StateHasChanged();
            
            // Actualizar resúmenes dinámicos para que sean consistentes con las estadísticas
            await ActualizarResumenesDinamicos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CargarEstadisticas: Error - {ex.Message}");
            Console.WriteLine($"CargarEstadisticas: StackTrace - {ex.StackTrace}");
            await MostrarNotificacionError("Error al cargar estadísticas", $"No se pudieron cargar las estadísticas: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void ShowEvaluacionesModal()
    {
        showEvaluacionesModal = true;
        StateHasChanged();
    }

    private void ShowSolicitudesModal()
    {
        showSolicitudesModal = true;
        StateHasChanged();
    }    private async Task SubirNivel()
    {
        // Verificar si hay configuración de tiempo activa
        if (!isTimeConfigurationActive)
        {
            await MostrarNotificacionError("Período Inactivo", "No se pueden crear solicitudes de escalafón. El período para solicitudes está inactivo. Contacta al administrador para más información.");
            return;
        }
        
        var cedula = UserSession.CurrentUser?.Cedula;
        var nivelActual = UserSession.CurrentUser?.Nivel;
        
        if (string.IsNullOrEmpty(cedula) || string.IsNullOrEmpty(nivelActual))
        {
            await MostrarNotificacionError("Error", "No se pudo obtener la información del usuario actual.");
            return;
        }

        try
        {
            // Usar el nivel objetivo de la configuración de requisitos (viene de la API)
            string nivelSolicitado = "";
            
            if (configuracionRequisitos != null && !string.IsNullOrEmpty(configuracionRequisitos.NivelObjetivo))
            {
                nivelSolicitado = configuracionRequisitos.NivelObjetivo;
                Console.WriteLine($"SubirNivel: Usando nivel objetivo de configuración: {nivelActual} -> {nivelSolicitado}");
            }
            else
            {
                await MostrarNotificacionError("Error", "No se pudo determinar el siguiente nivel de escalafón. La configuración de requisitos no está disponible.");
                return;
            }
            
            // Obtener requisitos desde la API para saber exactamente qué necesitamos
            var requisitosApi = await AuthService.VerificarRequisitosEscalafonDinamico(cedula, nivelActual);
            if (requisitosApi == null || !requisitosApi.CumpleTodosRequisitos)
            {
                await MostrarNotificacionError("Error", "No cumples todos los requisitos para ascender. Verifica los requisitos antes de continuar.");
                return;
            }
            
            // Seleccionar archivos más antiguos que cumplan los requisitos
            var archivosSeleccionados = await SeleccionarArchivosParaEscalafon(cedula, requisitosApi);
            
            // Obtener estadísticas del docente para completar la solicitud
            var estadisticas = await AuthService.ObtenerEstadisticasDocente(cedula);
            
            // Crear la solicitud de escalafón con los archivos específicos seleccionados
            var createSolicitudDto = new proyectoAgiles.Services.CreateSolicitudEscalafonDto
            {
                DocenteCedula = cedula,
                DocenteNombre = UserSession.CurrentUser?.FullName ?? "Nombre no disponible",
                DocenteEmail = UserSession.CurrentUser?.Email ?? "Email no disponible",
                DocenteTelefono = "", // No disponible en UserSession actual
                Facultad = "", // No disponible en UserSession actual  
                Carrera = "", // No disponible en UserSession actual
                NivelActual = nivelActual,
                NivelSolicitado = nivelSolicitado,
                AnosExperiencia = ObtenerAnosExperiencia(estadisticas),
                Publicaciones = GenerarResumenPublicacionesSeleccionadas(archivosSeleccionados.Investigaciones),
                Capacitaciones = GenerarResumenCapacitacionesSeleccionadas(archivosSeleccionados.Capacitaciones),
                Observaciones = "Solicitud generada automáticamente."
            };

            var response = await HttpClient.PostAsJsonAsync("/api/solicitudes-escalafon", createSolicitudDto);

            if (response.IsSuccessStatusCode)
            {
                // Marcar los archivos seleccionados como utilizados
                await MarcarArchivosComoUtilizados(archivosSeleccionados);
                
                // Cerrar el modal de requisitos
                showRequisitosModal = false;
                
                // Preparar notificación de éxito sin detalles de archivos
                var mensajeExito = $"Tu solicitud de escalafón de {nivelActual} a {nivelSolicitado} ha sido enviada exitosamente.";
                
                await MostrarNotificacionExito(
                    "Solicitud Enviada", 
                    mensajeExito
                );

                // Limpiar la verificación de requisitos para forzar una nueva verificación
                requisitosVerificacion = null;
                requisitosEscalafonDinamicos = null;
                
                // Recargar los datos para reflejar los archivos ya utilizados
                await CargarDatosActualizados();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                await MostrarNotificacionError("Error", $"No se pudo crear la solicitud: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("Error", $"Error al crear la solicitud: {ex.Message}");
        }
    }
    
    private string GenerarResumenPublicacionesSeleccionadas(List<InvestigacionSeleccionada> investigaciones)
    {
        if (!investigaciones.Any())
            return "Sin publicaciones seleccionadas";

        // USAR SOLO DATOS SIMPLES SIN CÁLCULOS COMPLEJOS - LA LÓGICA YA VIENE DE LA API
        var totalObras = investigaciones.Count; // Solo conteo simple
        var primerasFechas = investigaciones.Take(3).Select(i => i.FechaPublicacion.ToString("yyyy"));

        return $"Seleccionadas automáticamente: {totalObras} obra(s). " +
               $"Fechas: {string.Join(", ", primerasFechas)}" +
               (investigaciones.Count > 3 ? "..." : "") + ". Detalles desde API.";
    }

    private string GenerarResumenCapacitacionesSeleccionadas(List<CapacitacionSeleccionada> capacitaciones)
    {
        if (!capacitaciones.Any())
            return "Sin capacitaciones seleccionadas";

        // USAR SOLO CONTEO SIMPLE - LA LÓGICA DE HORAS Y REQUISITOS YA VIENE DE LA API
        return $"Seleccionadas automáticamente: {capacitaciones.Count} capacitación(es). " +
               "Detalles de horas y cumplimiento desde API.";
    }

    // Métodos para notificaciones profesionales con toast
    private async Task MostrarNotificacionExito(string titulo, string mensaje, int duracion = 5000)
    {
        await JSRuntime.InvokeVoidAsync("toastNotifications.success", titulo, mensaje, duracion);
    }

    private async Task MostrarNotificacionInfo(string titulo, string mensaje, int duracion = 5000)
    {
        await JSRuntime.InvokeVoidAsync("toastNotifications.info", titulo, mensaje, duracion);
    }

    private async Task MostrarNotificacionError(string titulo, string mensaje, int duracion = 7000)
    {
        await JSRuntime.InvokeVoidAsync("toastNotifications.error", titulo, mensaje, duracion);
    }

    private async Task MostrarNotificacionAdvertencia(string titulo, string mensaje, int duracion = 6000)
    {
        await JSRuntime.InvokeVoidAsync("toastNotifications.warning", titulo, mensaje, duracion);
    }

    // Métodos para Solicitudes
    private void VerDetalleSolicitud(int solicitudId)
    {
        var solicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
        if (solicitud != null)
        {
            solicitudSeleccionada = solicitud;
            showDetalleSolicitudModal = true;
            StateHasChanged();
        }
    }

    private void CloseDetalleSolicitudModal()
    {
        showDetalleSolicitudModal = false;
        solicitudSeleccionada = null;
        StateHasChanged();
    }

    private async Task CancelarSolicitudDetalle(int solicitudId)
    {
        var confirmacion = await JSRuntime.InvokeAsync<bool>("confirm", 
            "¿Está seguro de que desea cancelar esta solicitud? Esta acción no se puede deshacer.");
        
        if (confirmacion)
        {
            try
            {
                // Aquí iría la lógica para cancelar la solicitud en el servidor
                var solicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
                if (solicitud != null)
                {
                    solicitud.Estado = "Cancelada";
                    solicitudSeleccionada = solicitud; // Actualizar la solicitud seleccionada
                    StateHasChanged();
                    await MostrarNotificacionExito("✅ Solicitud Cancelada", "La solicitud ha sido cancelada exitosamente y se ha notificado a la comisión académica.");
                    
                    // Cerrar el modal de detalle después de 2 segundos
                    await Task.Delay(2000);
                    CloseDetalleSolicitudModal();
                }
            }
            catch (Exception ex)
            {
                await MostrarNotificacionError("❌ Error", $"No se pudo cancelar la solicitud: {ex.Message}");
            }
        }
    }

    private async Task CancelarSolicitud(int solicitudId)
    {
        var confirmacion = await JSRuntime.InvokeAsync<bool>("confirm", 
            "¿Está seguro de que desea cancelar esta solicitud?");
        
        if (confirmacion)
        {
            try
            {
                // Aquí iría la lógica para cancelar la solicitud en el servidor
                var solicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
                if (solicitud != null)
                {
                    solicitud.Estado = "Cancelada";
                    StateHasChanged();
                    await MostrarNotificacionExito("Solicitud Cancelada", "La solicitud ha sido cancelada exitosamente.");
                }
            }
            catch (Exception ex)
            {
                await MostrarNotificacionError("Error", $"No se pudo cancelar la solicitud: {ex.Message}");
            }
        }
    }

    // Métodos para Apelación de Solicitudes
    
    private void AbrirModalApelacion(int solicitudId)
    {
        var solicitud = solicitudes.FirstOrDefault(s => s.Id == solicitudId);
        if (solicitud != null)
        {
            solicitudParaApelar = solicitud;
            justificacionApelacion = string.Empty;
            archivosApelacion.Clear();
            errorMensajeArchivos = null;
            showApelacionModal = true;
            StateHasChanged();
        }
    }

    private void CerrarModalApelacion()
    {
        showApelacionModal = false;
        solicitudParaApelar = null;
        justificacionApelacion = string.Empty;
        archivosApelacion.Clear();
        errorMensajeArchivos = null;
        StateHasChanged();
    }

    private async Task MostrarConfirmacionApelacion()
    {
        if (solicitudParaApelar == null)
        {
            await MostrarNotificacionError("❌ Error", "No se encontró la solicitud para apelar.");
            return;
        }

        if (string.IsNullOrWhiteSpace(justificacionApelacion))
        {
            await MostrarNotificacionError("❌ Datos Incompletos", "Debe proporcionar una justificación para la apelación.");
            return;
        }
        
        showConfirmacionApelacionModal = true;
        StateHasChanged();
    }

    private void CerrarConfirmacionApelacion()
    {
        showConfirmacionApelacionModal = false;
        StateHasChanged();
    }

    private async Task ProcesarApelacion()
    {
        // Validaciones iniciales
        if (solicitudParaApelar == null)
        {
            await MostrarNotificacionError("❌ Error", "No se encontró la solicitud para apelar.");
            return;
        }

        if (string.IsNullOrWhiteSpace(justificacionApelacion))
        {
            await MostrarNotificacionError("❌ Datos Incompletos", "Debe proporcionar una justificación para la apelación.");
            return;
        }

        try
        {
            isCreatingApelacion = true;
            StateHasChanged();

            // Cerrar el modal de confirmación primero
            showConfirmacionApelacionModal = false;
            StateHasChanged();

            // Crear contenido multipart para enviar archivos
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent(justificacionApelacion), "observacionesApelacion");
            content.Add(new StringContent("ComisionAcademica"), "destinatario");

            // Agregar archivos si los hay
            if (archivosApelacion.Any())
            {
                foreach (var archivo in archivosApelacion)
                {
                    var fileContent = new StreamContent(archivo.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024));
                    fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(archivo.ContentType);
                    content.Add(fileContent, "archivos", archivo.Name);
                }
            }

            // Llamar al endpoint de apelación
            var response = await HttpClient.PostAsync($"/api/solicitudes-escalafon/{solicitudParaApelar.Id}/apelar", content);

            if (response.IsSuccessStatusCode)
            {
                // Cerrar modal de apelación
                showApelacionModal = false;
                
                // Actualizar la lista de solicitudes
                await ImportarSolicitudes();
                
                var mensajeExito = archivosApelacion.Any() ? 
                    $"Su apelación con {archivosApelacion.Count} archivo(s) adjunto(s) ha sido enviada exitosamente a la Comisión Académica de Escalafón." :
                    "Su apelación ha sido enviada exitosamente a la Comisión Académica de Escalafón.";
                
                await MostrarNotificacionExito("✅ Apelación Enviada", 
                    $"{mensajeExito} Recibirá una notificación por correo electrónico cuando sea procesada.");
                
                // Limpiar datos
                solicitudParaApelar = null;
                justificacionApelacion = string.Empty;
                archivosApelacion.Clear();
                errorMensajeArchivos = null;
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                await MostrarNotificacionError("❌ Error al Crear Apelación", 
                    $"No se pudo procesar su apelación: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("❌ Error de Conexión", 
                $"Error al enviar la apelación: {ex.Message}");
        }
        finally
        {
            isCreatingApelacion = false;
            StateHasChanged();
        }
    }

    private void HandleArchivosApelacionSelected(InputFileChangeEventArgs e)
    {
        errorMensajeArchivos = null;
        var archivosSeleccionados = e.GetMultipleFiles(5).ToList(); // Máximo 5 archivos

        foreach (var archivo in archivosSeleccionados)
        {
            // Validar tamaño (10MB máximo)
            if (archivo.Size > 10 * 1024 * 1024)
            {
                errorMensajeArchivos = $"El archivo '{archivo.Name}' excede el tamaño máximo de 10MB.";
                return;
            }

            // Validar tipo de archivo
            var extensionesPermitidas = new[] { ".pdf", ".doc", ".docx", ".jpg", ".jpeg", ".png" };
            var extension = Path.GetExtension(archivo.Name).ToLower();
            if (!extensionesPermitidas.Contains(extension))
            {
                errorMensajeArchivos = $"El archivo '{archivo.Name}' no tiene un formato válido. Formatos permitidos: PDF, DOC, DOCX, JPG, PNG.";
                return;
            }

            // Evitar duplicados
            if (!archivosApelacion.Any(a => a.Name == archivo.Name && a.Size == archivo.Size))
            {
                archivosApelacion.Add(archivo);
            }
        }

        StateHasChanged();
    }

    private void RemoverArchivoApelacion(IBrowserFile archivo)
    {
        archivosApelacion.Remove(archivo);
        errorMensajeArchivos = null;
        StateHasChanged();
    }

    // Método para mapear estados del backend a estados legibles
    private string MapearEstado(string? status)
    {
        return status switch
        {
            "PendientePresidente" => "En Revisión - Presidente",
            "PendienteTTHH" => "En Revisión - Talento Humano",
            "PendienteComision" => "En Revisión - Comisión",
            "RechazadoPresidente" => "Rechazada por Presidente",
            "RechazadoTTHH" => "Rechazada por Talento Humano",
            "RechazadoComision" => "Rechazada por Comisión",
            "Rechazado" => "Rechazada", // Estado genérico de rechazo
            "PendienteApelacion" => "Apelación Pendiente",
            "AprobadoPresidente" => "En Revisión - Siguiente Nivel",
            "AprobadoTTHH" => "En Revisión - Siguiente Nivel",
            "AprobadoComision" => "Aprobada",
            "Completado" => "Completada",
            null => "Pendiente",
            _ => status
        };
    }

    // Métodos auxiliares para generar resúmenes detallados de la solicitud
    private int ObtenerAnosExperiencia(EstadisticasDocenteResponse? estadisticas)
    {
        // Mostrar solo el valor que viene de la API, sin cálculos locales
        if (estadisticas?.Secciones?.Experiencia?.Datos != null)
        {
            var datosExperiencia = estadisticas.Secciones.Experiencia.Datos;
            return (int)Math.Round(datosExperiencia.AñosObtenidos);
        }
        return 0;
    }

    private string GenerarResumenPublicaciones(EstadisticasDocenteResponse? estadisticas)
    {
        // Mostrar solo el resumen que viene de la API, sin cálculos locales
        if (estadisticas?.Secciones?.Obras?.Datos == null)
            return "Sin publicaciones registradas";

        var detalles = estadisticas.Secciones.Obras.Datos.Detalles;
        if (string.IsNullOrWhiteSpace(detalles))
            return "Sin publicaciones registradas";
        return detalles;
    }

    private string GenerarResumenCapacitaciones(EstadisticasDocenteResponse? estadisticas)
    {
        // Mostrar solo el resumen que viene de la API, sin cálculos locales
        if (estadisticas?.Secciones?.Capacitaciones?.Datos == null)
            return "Sin capacitaciones registradas";

        var detalles = estadisticas.Secciones.Capacitaciones.Datos.Detalles;
        if (string.IsNullOrWhiteSpace(detalles))
            return "Sin capacitaciones registradas";
        return detalles;
    }

    public class ClassItem
    {
        public string CourseName { get; set; } = string.Empty;
        public string Topic { get; set; } = string.Empty;
        public string Time { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public string Location { get; set; } = string.Empty;
    }    public class Investigacion
    {
        public int Id { get; set; }
        public string Cedula { get; set; } = string.Empty;
        public string Titulo { get; set; } = string.Empty;
        public string Tipo { get; set; } = string.Empty;
        public string RevistaOEditorial { get; set; } = string.Empty;
        public string Area { get; set; } = string.Empty; // Mapeado desde CampoConocimiento
        public string Estado { get; set; } = "En revisión";
        public DateTime FechaInicio { get; set; } = DateTime.Today; // Mapeado desde FechaPublicacion
        public DateTime? FechaFin { get; set; }
        public string Descripcion { get; set; } = string.Empty; // Mapeado desde Observacion
        public string Filiacion { get; set; } = string.Empty;
        public bool TienePdf { get; set; } // Agregar propiedad para saber si tiene PDF
        public bool TieneFiliacionUTA { get; set; } // Agregar propiedad para saber si tiene filiación UTA
    }    public class VerificacionRequisito75Dto
    {
        public string Cedula { get; set; } = string.Empty;
        public bool CumpleRequisito { get; set; }
        public int EvaluacionesAnalizadas { get; set; }
        public int EvaluacionesQueAlcanzan75 { get; set; }
        public decimal PorcentajePromedioUltimasCuatro { get; set; }
        public string Mensaje { get; set; } = string.Empty;
        public List<proyectoAgiles.Services.EvaluacionDesempenoDto> EvaluacionesConsideradas { get; set; } = new();
    }

    public class SolicitudDto
    {
        public int Id { get; set; }
        public string TipoSolicitud { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
        public DateTime FechaSolicitud { get; set; }
        public DateTime? FechaRespuesta { get; set; }
        public string NivelActual { get; set; } = string.Empty;
        public string NivelSolicitado { get; set; } = string.Empty;
        public string Observaciones { get; set; } = string.Empty;
        public string? MotivoRechazo { get; set; } = string.Empty;
        public string? MotivoRechazoConsejo { get; set; } = string.Empty;
    }

    public class HistorialEscalafonDto
    {
        public int Id { get; set; }
        public string NivelAnterior { get; set; } = string.Empty;
        public string NivelNuevo { get; set; } = string.Empty;
        public DateTime FechaPromocion { get; set; }
        public string EstadoSolicitud { get; set; } = string.Empty;
        public List<string> DocumentosUtilizados { get; set; } = new();
        public DocumentosDetallados DocumentosDetalles { get; set; } = new();
        public string ObservacionesFinales { get; set; } = string.Empty;
        public string AprobadoPor { get; set; } = string.Empty;
    }

    public class DocumentosDetallados
    {
        public List<InvestigacionUtilizada> Investigaciones { get; set; } = new();
        public List<EvaluacionUtilizada> Evaluaciones { get; set; } = new();
        public List<CapacitacionUtilizada> Capacitaciones { get; set; } = new();
        public VerificacionRequisitos VerificacionRequisitos { get; set; } = new();
    }

    public class InvestigacionUtilizada
    {
        public int Id { get; set; }
        public string Titulo { get; set; } = string.Empty;
        public string Tipo { get; set; } = string.Empty;
        public string RevistaOEditorial { get; set; } = string.Empty;
        public DateTime FechaPublicacion { get; set; }
        public string Filiacion { get; set; } = string.Empty;
        public bool TieneFiliacionUTA { get; set; }
    }

    public class EvaluacionUtilizada
    {
        public int Id { get; set; }
        public string PeriodoAcademico { get; set; } = string.Empty;
        public int Anio { get; set; }
        public int Semestre { get; set; }
        public decimal PuntajeObtenido { get; set; }
        public decimal PuntajeMaximo { get; set; }
        public decimal Porcentaje { get; set; }
        public string Estado { get; set; } = string.Empty;
    }

    public class CapacitacionUtilizada
    {
        public int Id { get; set; }
        public string NombreCurso { get; set; } = string.Empty;
        public string Facilitador { get; set; } = string.Empty;
        public int HorasAcademicas { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public string Tipo { get; set; } = string.Empty;
        public bool EsPedagogica { get; set; }
    }

    public class VerificacionRequisitos
    {
        public int TotalInvestigaciones { get; set; }
        public int InvestigacionesConUTA { get; set; }
        public int TotalHorasCapacitacion { get; set; }
        public int HorasPedagogicas { get; set; }
        public decimal PromedioEvaluaciones { get; set; }
        public int PeriodosEvaluados { get; set; }
        public bool CumpleTodosRequisitos { get; set; }
    }
    
    private void ShowCapacitacionesModal()
    {
        // Solo abrir el modal, NO cargar datos automáticamente
        // NO limpiar la lista - mantener los datos ya importados
        showCapacitacionesModal = true;
        StateHasChanged();
    }

    private void CloseCapacitacionesModal()
    {
        showCapacitacionesModal = false;
        StateHasChanged();
    }    private async Task CargarCapacitaciones()
    {
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula;
            if (string.IsNullOrEmpty(cedula))
                return;

            // Cargar solo capacitaciones disponibles (no utilizadas en escalafones previos)
            var response = await HttpClient.GetAsync($"/api/ditic/disponibles/{cedula}");
            List<ProyectoAgiles.Application.DTOs.DiticDto>? apiCapacitaciones = null;
            
            if (response.IsSuccessStatusCode)
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                apiCapacitaciones = System.Text.Json.JsonSerializer.Deserialize<List<ProyectoAgiles.Application.DTOs.DiticDto>>(
                    jsonResponse, 
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            if (apiCapacitaciones is not null)
            {
                capacitaciones = apiCapacitaciones.ToList();
                
                Console.WriteLine($"Capacitaciones cargadas: {capacitaciones.Count}");
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar capacitaciones: {ex.Message}");
        }
    }

    private async Task RecargarCapacitacionesYActualizarResumen()
    {
        Console.WriteLine("RecargarCapacitacionesYActualizarResumen: Iniciando...");
        
        await CargarCapacitaciones();
        Console.WriteLine($"RecargarCapacitacionesYActualizarResumen: Capacitaciones cargadas: {capacitaciones.Count}");
        
        // Forzar actualización inmediata de la UI
        StateHasChanged();
        
        // Actualizar estadísticas automáticamente después de un pequeño delay para el backend
        await Task.Delay(500); 
        await CargarEstadisticas();
        
        Console.WriteLine("RecargarCapacitacionesYActualizarResumen: Estadísticas actualizadas");
        StateHasChanged();
    }

    private async Task ImportarCapacitaciones()
    {
        isLoadingCapacitaciones = true;
        StateHasChanged();
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula;
            if (string.IsNullOrEmpty(cedula))
            {
                await MostrarNotificacionError("❌ Error de importación", "No se pudo obtener la cédula del usuario.");
                return;
            }
            
            // Cargar capacitaciones desde la API
            await CargarCapacitaciones();
            
            // Actualizar resúmenes dinámicos para obtener configuración de requisitos desde la API
            await ActualizarResumenesDinamicos();
            
            // Forzar actualización de UI
            StateHasChanged();
            
            Console.WriteLine("ImportarCapacitaciones: Valores obtenidos desde API");
            Console.WriteLine($"  - Horas totales: {horasCapacitacionObtenidas}/{horasCapacitacionRequeridas}");
            Console.WriteLine($"  - Horas pedagógicas: {horasPedagogicasObtenidas}/{horasPedagogicasRequeridas}");
            Console.WriteLine($"  - Cumple requisitos: {cumpleCapacitaciones}");
            
            if (capacitaciones.Any())
            {
                await MostrarNotificacionExito($"📚 Capacitaciones Importadas", $"Se han cargado exitosamente {capacitaciones.Count} capacitación{(capacitaciones.Count > 1 ? "es" : "")} desde la base de datos institucional.");
            }
            else
            {
                await MostrarNotificacionInfo("ℹ️ Sin Datos Disponibles", "No se encontraron capacitaciones DITIC asociadas a tu cédula en el sistema.");
            }
        }
        catch (Exception ex)
        {
            await MostrarNotificacionError("❌ Error de importación", $"No se pudieron cargar las capacitaciones: {ex.Message}");
        }
        finally
        {
            isLoadingCapacitaciones = false;
            StateHasChanged();
        }
    }

    private async Task GuardarCapacitacion()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(nuevaCapacitacion.NombreCapacitacion) ||
                string.IsNullOrWhiteSpace(nuevaCapacitacion.Institucion) ||                nuevaCapacitacion.HorasAcademicas <= 0)
            {
                await MostrarNotificacionError("🔒 Error de Validación", "Todos los campos obligatorios deben estar completados antes de guardar la capacitación.");
                return;
            }

            isSavingCapacitacion = true;
            StateHasChanged();

            var cedula = UserSession.CurrentUser?.Cedula ?? string.Empty;
            if (string.IsNullOrEmpty(cedula))
            {
                await MostrarNotificacionError("Error", "No se pudo obtener la cédula del usuario.");
                return;
            }            if (editingCapacitacion is not null)
            {
                // Actualizar capacitación existente (datos)
                var updateDto = new ProyectoAgiles.Application.DTOs.UpdateDiticDto
                {
                    Id = editingCapacitacion.Id,
                    Cedula = cedula,
                    NombreCapacitacion = nuevaCapacitacion.NombreCapacitacion,
                    Institucion = nuevaCapacitacion.Institucion,
                    TipoCapacitacion = nuevaCapacitacion.TipoCapacitacion,
                    Modalidad = nuevaCapacitacion.Modalidad,
                    HorasAcademicas = nuevaCapacitacion.HorasAcademicas,
                    FechaInicio = nuevaCapacitacion.FechaInicio,
                    FechaFin = nuevaCapacitacion.FechaFin,
                    Anio = nuevaCapacitacion.Anio,
                    Estado = nuevaCapacitacion.Estado,
                    Calificacion = nuevaCapacitacion.Calificacion,
                    CalificacionMinima = nuevaCapacitacion.CalificacionMinima,
                    Descripcion = nuevaCapacitacion.Descripcion,
                    NumeroCertificado = nuevaCapacitacion.NumeroCertificado,
                    Instructor = nuevaCapacitacion.Instructor,
                    Observaciones = nuevaCapacitacion.Observaciones,
                    ExencionPorAutoridad = nuevaCapacitacion.ExencionPorAutoridad,
                    CargoAutoridad = nuevaCapacitacion.CargoAutoridad,
                    FechaInicioAutoridad = nuevaCapacitacion.FechaInicioAutoridad,
                    FechaFinAutoridad = nuevaCapacitacion.FechaFinAutoridad
                };
                var updated = await AuthService.ActualizarCapacitacion(updateDto);
                
                // Si se seleccionó un nuevo PDF, actualizar el certificado
                if (selectedCapacitacionPdf is not null)
                {
                    await AuthService.ActualizarCertificadoCapacitacion(editingCapacitacion.Id, selectedCapacitacionPdf);
                }                  await MostrarNotificacionExito("🎓 Capacitación Actualizada", "La capacitación DITIC ha sido actualizada correctamente en el sistema académico.");
                await RecargarCapacitacionesYActualizarResumen();
                CloseAgregarCapacitacionModal();
            }
            else            {                if (selectedCapacitacionPdf is not null)
                {
                    // Crear con PDF usando AuthService con parámetros individuales
                    var created = await AuthService.CrearCapacitacionConPdf(
                        cedula,
                        nuevaCapacitacion.NombreCapacitacion,
                        nuevaCapacitacion.Institucion,
                        nuevaCapacitacion.TipoCapacitacion,
                        nuevaCapacitacion.Modalidad,
                        nuevaCapacitacion.HorasAcademicas,
                        nuevaCapacitacion.FechaInicio,
                        nuevaCapacitacion.FechaFin,
                        nuevaCapacitacion.Anio,
                        nuevaCapacitacion.Estado,
                        nuevaCapacitacion.Calificacion,
                        nuevaCapacitacion.CalificacionMinima,
                        nuevaCapacitacion.Descripcion,
                        nuevaCapacitacion.NumeroCertificado,
                        nuevaCapacitacion.Instructor,
                        nuevaCapacitacion.Observaciones,
                        nuevaCapacitacion.ExencionPorAutoridad,
                        nuevaCapacitacion.CargoAutoridad,
                        nuevaCapacitacion.FechaInicioAutoridad,
                        nuevaCapacitacion.FechaFinAutoridad,
                        selectedCapacitacionPdf
                    );                    await MostrarNotificacionExito("🎓 Capacitación Registrada", "La capacitación DITIC ha sido creada exitosamente con su certificado PDF adjunto.");
                    await RecargarCapacitacionesYActualizarResumen();
                    
                    Console.WriteLine("GuardarCapacitacion: Capacitación con PDF guardada y estadísticas actualizadas.");
                    CloseAgregarCapacitacionModal();
                }else
                {
                    // Crear sin PDF
                    var createDto = new ProyectoAgiles.Application.DTOs.CreateDiticDto
                    {
                        Cedula = cedula,
                        NombreCapacitacion = nuevaCapacitacion.NombreCapacitacion,
                        Institucion = nuevaCapacitacion.Institucion,
                        TipoCapacitacion = nuevaCapacitacion.TipoCapacitacion,
                        Modalidad = nuevaCapacitacion.Modalidad,
                        HorasAcademicas = nuevaCapacitacion.HorasAcademicas,
                        FechaInicio = nuevaCapacitacion.FechaInicio,
                        FechaFin = nuevaCapacitacion.FechaFin,
                        Anio = nuevaCapacitacion.Anio,
                        Estado = nuevaCapacitacion.Estado,
                        Calificacion = nuevaCapacitacion.Calificacion,
                        CalificacionMinima = nuevaCapacitacion.CalificacionMinima,
                        Descripcion = nuevaCapacitacion.Descripcion,
                        NumeroCertificado = nuevaCapacitacion.NumeroCertificado,
                        Instructor = nuevaCapacitacion.Instructor,
                        Observaciones = nuevaCapacitacion.Observaciones,
                        ExencionPorAutoridad = nuevaCapacitacion.ExencionPorAutoridad,
                        CargoAutoridad = nuevaCapacitacion.CargoAutoridad,
                        FechaInicioAutoridad = nuevaCapacitacion.FechaInicioAutoridad,
                        FechaFinAutoridad = nuevaCapacitacion.FechaFinAutoridad
                    };
                    var created = await AuthService.CrearCapacitacion(createDto);                    await MostrarNotificacionExito("🎓 Capacitación Registrada", "La capacitación DITIC ha sido creada correctamente en el sistema académico.");
                    await RecargarCapacitacionesYActualizarResumen();
                    
                    Console.WriteLine("GuardarCapacitacion: Estadísticas actualizadas.");
                    CloseAgregarCapacitacionModal();
                }
            }
        }
        catch (Exception ex)
        {
            // Si la excepción contiene un mensaje de error del backend, mostrarlo
            var mensajeError = ex.Message;
            if (ex.InnerException != null)
            {
                mensajeError += $"\nDetalle: {ex.InnerException.Message}";
            }
            // Si el mensaje parece contener JSON, intentar extraer el mensaje
            if (mensajeError.Contains("{"))
            {
                try
                {
                    var jsonDoc = JsonDocument.Parse(mensajeError.Substring(mensajeError.IndexOf('{')));
                    if (jsonDoc.RootElement.TryGetProperty("message", out var msgProp))
                    {
                        mensajeError = msgProp.GetString() ?? mensajeError;
                    }
                    else if (jsonDoc.RootElement.TryGetProperty("error", out var errProp))
                    {
                        mensajeError = errProp.GetString() ?? mensajeError;
                    }
                }
                catch { /* Ignorar errores de parseo */ }
            }
            await MostrarNotificacionError("Error al guardar capacitación", mensajeError);
        }
        finally
        {
            isSavingCapacitacion = false;
            StateHasChanged();
        }
    }    private void ShowAgregarCapacitacion()
    {
        nuevaCapacitacion = new ProyectoAgiles.Application.DTOs.DiticDto
        {
            Cedula = UserSession.CurrentUser?.Cedula ?? "",
            FechaInicio = DateTime.Now,
            FechaFin = DateTime.Now.AddDays(30),
            Anio = DateTime.Now.Year,
            CalificacionMinima = 70,
            Estado = "Completada",
            Modalidad = "Presencial",
            TipoCapacitacion = "Técnica"
        };
        editingCapacitacion = null;
        selectedCapacitacionPdf = null;
        capacitacionPdfFileName = null;
        showAgregarCapacitacionModal = true;
        StateHasChanged();
    }

    private void CloseAgregarCapacitacionModal()
    {
        showAgregarCapacitacionModal = false;
        editingCapacitacion = null;
        nuevaCapacitacion = new ProyectoAgiles.Application.DTOs.DiticDto();
        selectedCapacitacionPdf = null;
        capacitacionPdfFileName = null;
        StateHasChanged();
    }

    private void EditarCapacitacion(ProyectoAgiles.Application.DTOs.DiticDto capacitacion)
    {
        editingCapacitacion = capacitacion;
        nuevaCapacitacion = new ProyectoAgiles.Application.DTOs.DiticDto
        {
            Id = capacitacion.Id,
            Cedula = capacitacion.Cedula,
            NombreCapacitacion = capacitacion.NombreCapacitacion,
            Institucion = capacitacion.Institucion,
            TipoCapacitacion = capacitacion.TipoCapacitacion,
            Modalidad = capacitacion.Modalidad,
            HorasAcademicas = capacitacion.HorasAcademicas,
            FechaInicio = capacitacion.FechaInicio,
            FechaFin = capacitacion.FechaFin,
            Anio = capacitacion.Anio,
            Estado = capacitacion.Estado,
            Calificacion = capacitacion.Calificacion,
            CalificacionMinima = capacitacion.CalificacionMinima,
            Descripcion = capacitacion.Descripcion,
            Instructor = capacitacion.Instructor,
            EsPedagogica = capacitacion.EsPedagogica
        };
        
        selectedCapacitacionPdf = null;
        capacitacionPdfFileName = null;
        showAgregarCapacitacionModal = true;
        StateHasChanged();
    }    private async Task EliminarCapacitacion(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de que desea eliminar esta capacitación? Esta acción no se puede deshacer.");
        if (confirmed)
        {
            try
            {
                var success = await AuthService.EliminarCapacitacion(id);                if (success)
                {
                    await MostrarNotificacionExito("🗑️ Capacitación Eliminada", "La capacitación DITIC ha sido eliminada permanentemente del sistema.");
                    await RecargarCapacitacionesYActualizarResumen();
                    StateHasChanged();
                }                else
                {
                    await MostrarNotificacionError("❌ Error de Eliminación", "No se pudo eliminar la capacitación. Verifica tu conexión e inténtalo nuevamente.");
                }
            }
            catch (Exception ex)
            {
                await MostrarNotificacionError("Error inesperado", $"Ocurrió un error al eliminar la capacitación: {ex.Message}");
            }
        }
    }

    private async Task VerPdfCapacitacion(int id)
    {
        try
        {
            var pdfBytes = await AuthService.ObtenerPdfCapacitacion(id);
            if (pdfBytes is not null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var pdfDataUrl = $"data:application/pdf;base64,{base64}";
                var fileName = $"capacitacion_{id}.pdf";
                var success = await JSRuntime.InvokeAsync<bool>("showPdf", pdfDataUrl, fileName);
                if (!success)
                {
                    await MostrarNotificacionExito("PDF descargado", "El PDF se ha descargado a tu carpeta de descargas.");
                }
            }
            else
            {
                await MostrarNotificacionError("PDF no disponible", "No se encontró el archivo PDF para esta capacitación.");
            }
        }        catch (Exception ex)
        {
            await MostrarNotificacionError("Error", $"Error al obtener el PDF: {ex.Message}");
        }
    }

    private async Task ActualizarResumenesDinamicos()
    {
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula;
            var nivelActual = UserSession.CurrentUser?.Nivel;
            
            if (string.IsNullOrEmpty(cedula) || string.IsNullOrEmpty(nivelActual))
                return;

            // Asegurar que tenemos la configuración de requisitos cargada
            if (configuracionRequisitos == null)
            {
                Console.WriteLine("ActualizarResumenesDinamicos: Configuración no disponible, cargando...");
                CargarConfiguracionRequisitos();
            }

            // Obtener verificación de requisitos dinámicos - TODO viene de la API
            var verificacion = await AuthService.VerificarRequisitosEscalafonDinamico(cedula, nivelActual);
            if (verificacion != null)
            {
                requisitosEscalafonDinamicos = verificacion;
                
                // Actualizar variables para obras con UTA
                cumpleObrasUTA = verificacion.ObrasRelevantes.Cumple;
                if (configuracionRequisitos != null)
                {
                    obrasConUTARequeridas = configuracionRequisitos.ObrasRelevantesConUTA;
                    totalObrasRequeridas = configuracionRequisitos.ObrasRelevantesMinimoTotal;
                }
                else
                {
                    // Valores por defecto si no hay configuración disponible
                    obrasConUTARequeridas = 2;
                    totalObrasRequeridas = 2;
                }
                
                // Extraer valores obtenidos del mensaje de verificación
                ExtractObrasValues(verificacion.ObrasRelevantes.ValorObtenido);
                
                // Actualizar variables para evaluaciones
                cumpleEvaluaciones = verificacion.EvaluacionDesempeno.Cumple;
                if (configuracionRequisitos != null)
                {
                    porcentajeEvaluacionRequerido = configuracionRequisitos.PorcentajeEvaluacionMinimo;
                    periodosEvaluacionRequeridos = configuracionRequisitos.PeriodosEvaluacionRequeridos;
                }
                else
                {
                    // Valores por defecto si no hay configuración disponible
                    porcentajeEvaluacionRequerido = 75;
                    periodosEvaluacionRequeridos = 4;
                }
                // OBTENER LOS VALORES DIRECTAMENTE DESDE LA API EN LUGAR DE PARSEAR TEXTO
                if (estadisticasDocente?.Secciones?.Evaluaciones?.Datos != null)
                {
                    // Usar los valores que vienen directamente de estadisticasDocente (API)
                    var datosEvaluaciones = estadisticasDocente.Secciones.Evaluaciones.Datos;
                    porcentajeEvaluacionObtenido = datosEvaluaciones.PromedioObtenido;
                    periodosEvaluacionAnalizados = datosEvaluaciones.EvaluacionesAnalizadas;
                    
                    Console.WriteLine("ActualizarResumenesDinamicos: Valores de evaluaciones obtenidos directamente de estadisticasDocente (API)");
                    Console.WriteLine($"  - Porcentaje obtenido desde API: {porcentajeEvaluacionObtenido}%");
                    Console.WriteLine($"  - Evaluaciones analizadas desde API: {periodosEvaluacionAnalizados}");
                }
                else
                {
                    // Si no hay estadisticasDocente, usar verificacion como fallback
                    Console.WriteLine("ActualizarResumenesDinamicos: Fallback - extrayendo valores de verificacion.EvaluacionDesempeno");
                    ExtractEvaluacionValues(verificacion.EvaluacionDesempeno.ValorObtenido);
                    periodosEvaluacionAnalizados = 4; // Fallback
                }
                
                // Actualizar configuración de requisitos para capacitaciones
                if (configuracionRequisitos != null)
                {
                    horasCapacitacionRequeridas = configuracionRequisitos.HorasCapacitacionRequeridas;
                    horasPedagogicasRequeridas = configuracionRequisitos.HorasCapacitacionPedagogicas;
                }
                else
                {
                    // Valores por defecto si no hay configuración disponible
                    horasCapacitacionRequeridas = 96;
                    horasPedagogicasRequeridas = 24;
                }
                
                // Usar SIEMPRE los valores que vienen de la API - NO hacer cálculos locales
                Console.WriteLine("ActualizarResumenesDinamicos: Usando valores de API para capacitaciones");
                
                // OBTENER LOS VALORES DIRECTAMENTE DESDE LA API EN LUGAR DE PARSEAR TEXTO
                if (estadisticasDocente?.Secciones?.Capacitaciones?.Datos != null)
                {
                    // Usar los valores que vienen directamente de estadisticasDocente (API)
                    horasCapacitacionObtenidas = estadisticasDocente.Secciones.Capacitaciones.Datos.HorasObtenidas;
                    horasPedagogicasObtenidas = estadisticasDocente.Secciones.Capacitaciones.Datos.HorasPedagogicasObtenidas;
                    cumpleCapacitaciones = estadisticasDocente.Secciones.Capacitaciones.Datos.Cumple; // También obtener el cumplimiento desde la API
                    
                    Console.WriteLine("ActualizarResumenesDinamicos: Valores obtenidos directamente de estadisticasDocente (API)");
                    Console.WriteLine($"  - Horas obtenidas desde API: {horasCapacitacionObtenidas}");
                    Console.WriteLine($"  - Horas pedagógicas obtenidas desde API: {horasPedagogicasObtenidas}");
                    Console.WriteLine($"  - Cumple requisitos desde API: {cumpleCapacitaciones}");
                }
                else
                {
                    // Si no hay estadisticasDocente, usar verificacion como fallback
                    Console.WriteLine("ActualizarResumenesDinamicos: Fallback - usando verificacion.Capacitacion");
                    cumpleCapacitaciones = verificacion.Capacitacion.Cumple;
                    ExtractCapacitacionValues(verificacion.Capacitacion.ValorObtenido);
                }
                
                Console.WriteLine($"ActualizarResumenesDinamicos: Variables actualizadas desde API");
                Console.WriteLine($"  - Nivel: {nivelActual}");
                Console.WriteLine($"  - Obras: {obrasConUTAObtenidas}/{obrasConUTARequeridas} UTA, {totalObrasObtenidas}/{totalObrasRequeridas} total");
                Console.WriteLine($"  - Evaluaciones: {porcentajeEvaluacionObtenido}%/{porcentajeEvaluacionRequerido}%");
                Console.WriteLine($"  - Capacitaciones: {horasCapacitacionObtenidas}h/{horasCapacitacionRequeridas}h, {horasPedagogicasObtenidas}h/{horasPedagogicasRequeridas}h ped");
                Console.WriteLine($"  - Cumple todos los requisitos: {verificacion.CumpleTodosRequisitos}");
                
                // Forzar actualización de la UI
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("ActualizarResumenesDinamicos: No se pudo obtener verificación de requisitos");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error actualizando resúmenes dinámicos: {ex.Message}");
        }
    }

    private void ExtractObrasValues(string valorObtenido)
    {
        try
        {
            // Formato esperado: "6 obra(s) total, 1 con filiación UTA"
            var match = System.Text.RegularExpressions.Regex.Match(
                valorObtenido, 
                @"(\d+)\s+obra\(s\)\s+total,\s+(\d+)\s+con\s+filiación\s+UTA", 
                System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                
            if (match.Success)
            {
                totalObrasObtenidas = int.Parse(match.Groups[1].Value);
                obrasConUTAObtenidas = int.Parse(match.Groups[2].Value);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extrayendo valores de obras: {ex.Message}");
        }
    }

    private void ExtractEvaluacionValues(string valorObtenido)
    {
        try
        {
            // Formato esperado: "80.8% promedio"
            var match = System.Text.RegularExpressions.Regex.Match(
                valorObtenido, 
                @"(\d+(?:\.\d+)?)\s*%", 
                System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                
            if (match.Success)
            {
                porcentajeEvaluacionObtenido = decimal.Parse(match.Groups[1].Value, System.Globalization.CultureInfo.InvariantCulture);
            }
            
            // El número de evaluaciones analizadas debe venir de la API
            // periodosEvaluacionAnalizados se obtiene desde verificacion o estadisticasDocente
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extrayendo valores de evaluaciones: {ex.Message}");
        }
    }

    private void ExtractCapacitacionValues(string valorObtenido)
    {
        // FALLBACK: Parsear el texto solo si no tenemos valores directos de la API
        
        try
        {
            // Formato esperado: "108h (40h pedagógicas)" o similar
            var matchHoras = System.Text.RegularExpressions.Regex.Match(
                valorObtenido, 
                @"(\d+)\s*h", 
                System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                
            if (matchHoras.Success)
            {
                horasCapacitacionObtenidas = int.Parse(matchHoras.Groups[1].Value);
                Console.WriteLine($"ExtractCapacitacionValues: Horas obtenidas del texto: {horasCapacitacionObtenidas}");
            }
            
            var matchPedagogicas = System.Text.RegularExpressions.Regex.Match(
                valorObtenido, 
                @"\((\d+)\s*h\s+pedagógicas?\)", 
                System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                
            if (matchPedagogicas.Success)
            {
                horasPedagogicasObtenidas = int.Parse(matchPedagogicas.Groups[1].Value);
                Console.WriteLine($"ExtractCapacitacionValues: Horas pedagógicas obtenidas del texto: {horasPedagogicasObtenidas}");
            }
            
            Console.WriteLine($"ExtractCapacitacionValues: Valores parseados del texto '{valorObtenido}'");
            Console.WriteLine($"  - Horas totales: {horasCapacitacionObtenidas}");
            Console.WriteLine($"  - Horas pedagógicas: {horasPedagogicasObtenidas}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en ExtractCapacitacionValues: {ex.Message}");
        }
    }

    private async Task ActualizarVerificacionRequisito75()
    {
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula;
            if (string.IsNullOrEmpty(cedula))
                return;

            // Obtener verificación del requisito 75%
            var apiBaseUrl = "http://localhost:5200";
            var verificacionResponse = await new HttpClient().GetAsync($"{apiBaseUrl}/api/EvaluacionesDesempeno/verificar-requisito-75/{cedula}");
            if (verificacionResponse.IsSuccessStatusCode)
            {
                var verificacionJson = await verificacionResponse.Content.ReadAsStringAsync();
                verificacionRequisito = System.Text.Json.JsonSerializer.Deserialize<VerificacionRequisito75Dto>(verificacionJson, 
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al actualizar verificación requisito 75%: {ex.Message}");
        }
    }

    // Métodos para selección inteligente de archivos
    private async Task<ArchivosSeleccionados> SeleccionarArchivosParaEscalafon(string cedula, proyectoAgiles.Services.VerificacionRequisitosEscalafonDto requisitos)
    {
        var archivosSeleccionados = new ArchivosSeleccionados();
        
        try
        {
            // Seleccionar investigaciones más antiguas que cumplan el requisito
            if (requisitos.ObrasRelevantes != null && !string.IsNullOrEmpty(requisitos.ObrasRelevantes.ValorRequerido))
            {
                if (int.TryParse(requisitos.ObrasRelevantes.ValorRequerido, out int investigacionesRequeridas))
                {
                    archivosSeleccionados.Investigaciones = await SeleccionarInvestigacionesMasAntiguas(cedula, investigacionesRequeridas);
                }
            }
            
            // Seleccionar evaluaciones más antiguas que cumplan el requisito
            if (requisitos.EvaluacionDesempeno != null && !string.IsNullOrEmpty(requisitos.EvaluacionDesempeno.ValorRequerido))
            {
                var evaluacionesRequeridas = ObtenerNumeroEvaluacionesNecesarias(requisitos.EvaluacionDesempeno.ValorRequerido);
                archivosSeleccionados.Evaluaciones = await SeleccionarEvaluacionesMasAntiguas(cedula, evaluacionesRequeridas);
            }
            
            // Seleccionar capacitaciones más antiguas que cumplan el requisito
            if (requisitos.Capacitacion != null && !string.IsNullOrEmpty(requisitos.Capacitacion.ValorRequerido))
            {
                if (int.TryParse(requisitos.Capacitacion.ValorRequerido, out int horasRequeridas))
                {
                    archivosSeleccionados.Capacitaciones = await SeleccionarCapacitacionesMasAntiguas(cedula, horasRequeridas);
                }
            }
            
            Console.WriteLine($"SeleccionarArchivosParaEscalafon: Archivos seleccionados para {cedula}");
            Console.WriteLine($"  - Investigaciones: {archivosSeleccionados.Investigaciones.Count}");
            Console.WriteLine($"  - Evaluaciones: {archivosSeleccionados.Evaluaciones.Count}");
            Console.WriteLine($"  - Capacitaciones: {archivosSeleccionados.Capacitaciones.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en SeleccionarArchivosParaEscalafon: {ex.Message}");
        }
        
        return archivosSeleccionados;
    }
    
    private async Task<List<InvestigacionSeleccionada>> SeleccionarInvestigacionesMasAntiguas(string cedula, int cantidadRequerida)
    {
        var investigacionesSeleccionadas = new List<InvestigacionSeleccionada>();
        
        try
        {
            // Obtener investigaciones disponibles (no utilizadas) desde la API
            var response = await HttpClient.GetAsync($"/api/investigaciones/disponibles/{cedula}");
            if (response.IsSuccessStatusCode)
            {
                var investigacionesDisponibles = await response.Content.ReadFromJsonAsync<List<Investigacion>>();
                
                if (investigacionesDisponibles != null)
                {
                    // Filtrar solo las que tienen filiación UTA y ordenar por fecha más antigua
                    var investigacionesConUTA = investigacionesDisponibles
                        .Where(i => !string.IsNullOrEmpty(i.Filiacion) && 
                                   i.Filiacion.ToUpper().Contains("UTA"))
                        .OrderBy(i => i.FechaInicio)
                        .Take(cantidadRequerida)
                        .ToList();
                    
                    foreach (var inv in investigacionesConUTA)
                    {
                        investigacionesSeleccionadas.Add(new InvestigacionSeleccionada
                        {
                            Id = inv.Id,
                            Titulo = inv.Titulo,
                            FechaPublicacion = inv.FechaInicio,
                            Filiacion = inv.Filiacion,
                            TieneFiliacionUTA = true
                        });
                    }
                    
                    Console.WriteLine($"SeleccionarInvestigacionesMasAntiguas: Seleccionadas {investigacionesSeleccionadas.Count} investigaciones disponibles");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al seleccionar investigaciones: {ex.Message}");
        }
        
        return investigacionesSeleccionadas;
    }
    
    private async Task<List<EvaluacionSeleccionada>> SeleccionarEvaluacionesMasAntiguas(string cedula, int cantidadRequerida)
    {
        var evaluacionesSeleccionadas = new List<EvaluacionSeleccionada>();
        
        try
        {
            // Obtener todas las evaluaciones no utilizadas, ordenadas por fecha más antigua
            var response = await HttpClient.GetAsync($"/api/evaluaciones/disponibles/{cedula}");
            if (response.IsSuccessStatusCode)
            {
                var evaluacionesDisponibles = await response.Content.ReadFromJsonAsync<List<proyectoAgiles.Services.EvaluacionDesempenoDto>>();
                
                if (evaluacionesDisponibles != null)
                {
                    // Seleccionar las evaluaciones más antiguas con puntaje >= 75
                    var evaluacionesValidas = evaluacionesDisponibles
                        .Where(e => e.PuntajeObtenido >= 75)
                        .OrderBy(e => e.Anio)
                        .ThenBy(e => e.Semestre)
                        .Take(cantidadRequerida)
                        .ToList();
                    
                    foreach (var eval in evaluacionesValidas)
                    {
                        evaluacionesSeleccionadas.Add(new EvaluacionSeleccionada
                        {
                            Id = eval.Id,
                            PeriodoAcademico = eval.PeriodoAcademico,
                            Anio = eval.Anio,
                            Semestre = eval.Semestre,
                            Porcentaje = eval.PuntajeObtenido, // Usar PuntajeObtenido en lugar de Porcentaje
                            FechaEvaluacion = new DateTime(eval.Anio, eval.Semestre <= 1 ? 6 : 12, 15) // Agregar día
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al seleccionar evaluaciones: {ex.Message}");
        }
        
        return evaluacionesSeleccionadas;
    }
    
    private async Task<List<CapacitacionSeleccionada>> SeleccionarCapacitacionesMasAntiguas(string cedula, int horasRequeridas)
    {
        var capacitacionesSeleccionadas = new List<CapacitacionSeleccionada>();
        
        try
        {
            // Obtener todas las capacitaciones no utilizadas, ordenadas por fecha más antigua
            var response = await HttpClient.GetAsync($"/api/capacitaciones/disponibles/{cedula}");
            if (response.IsSuccessStatusCode)
            {
                var capacitacionesDisponibles = await response.Content.ReadFromJsonAsync<List<ProyectoAgiles.Application.DTOs.DiticDto>>();
                
                if (capacitacionesDisponibles != null)
                {
                    // Seleccionar capacitaciones más antiguas hasta cumplir las horas requeridas
                    var capacitacionesOrdenadas = capacitacionesDisponibles
                        .OrderBy(c => c.FechaInicio)
                        .ToList();
                    
                    int horasAcumuladas = 0;
                    foreach (var cap in capacitacionesOrdenadas)
                    {
                        if (horasAcumuladas >= horasRequeridas)
                            break;
                            
                        capacitacionesSeleccionadas.Add(new CapacitacionSeleccionada
                        {
                            Id = cap.Id,
                            NombreCurso = cap.NombreCapacitacion,
                            HorasAcademicas = cap.HorasAcademicas,
                            FechaInicio = cap.FechaInicio,
                            EsPedagogica = cap.EsPedagogica
                        });
                        
                        horasAcumuladas += cap.HorasAcademicas;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al seleccionar capacitaciones: {ex.Message}");
        }
        
        return capacitacionesSeleccionadas;
    }
    
    private async Task MarcarArchivosComoUtilizados(ArchivosSeleccionados archivos)
    {
        try
        {
            var request = new MarcarArchivosUtilizadosRequest
            {
                InvestigacionesIds = archivos.Investigaciones.Select(i => i.Id).ToList(),
                EvaluacionesIds = archivos.Evaluaciones.Select(e => e.Id).ToList(),
                CapacitacionesIds = archivos.Capacitaciones.Select(c => c.Id).ToList()
            };
            
            var response = await HttpClient.PostAsJsonAsync("/api/escalafon/marcar-utilizados", request);
            
            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Archivos marcados como utilizados exitosamente");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error al marcar archivos como utilizados: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en MarcarArchivosComoUtilizados: {ex.Message}");
        }
    }
    
    private int ObtenerNumeroEvaluacionesNecesarias(string valorRequerido)
    {
        // Extraer número de evaluaciones necesarias del string de requisitos
        // Ejemplo: "4 evaluaciones con 75% mínimo" -> 4
        var match = System.Text.RegularExpressions.Regex.Match(valorRequerido, @"(\d+)");
        if (match.Success)
        {
            return int.Parse(match.Groups[1].Value);
        }
        return 4; // Default fallback
    }
    
    private async Task CargarDatosActualizados()
    {
        // Método para recargar todos los datos después de marcar archivos como utilizados
        try
        {
            var cedula = UserSession.CurrentUser?.Cedula;
            if (!string.IsNullOrEmpty(cedula))
            {
                // Recargar investigaciones
                await LoadInvestigaciones();
                
                // Recargar evaluaciones si ya estaban cargadas
                if (evaluaciones != null && evaluaciones.Any())
                {
                    await ImportarEvaluaciones();
                }
                
                // Recargar capacitaciones si ya estaban cargadas
                if (capacitaciones != null && capacitaciones.Any())
                {
                    await CargarCapacitaciones();
                }
                
                // Recargar datos del dashboard
                await LoadDashboardData();
                
                // Recargar historial
                await CargarHistorialEscalafones();
                
                Console.WriteLine("CargarDatosActualizados: Todos los datos han sido recargados");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al recargar datos: {ex.Message}");
        }
    }

    // Clases para la selección de archivos
    public class ArchivosSeleccionados
    {
        public List<InvestigacionSeleccionada> Investigaciones { get; set; } = new();
        public List<EvaluacionSeleccionada> Evaluaciones { get; set; } = new();
        public List<CapacitacionSeleccionada> Capacitaciones { get; set; } = new();
    }
    
    public class InvestigacionSeleccionada
    {
        public int Id { get; set; }
        public string Titulo { get; set; } = string.Empty;
        public DateTime FechaPublicacion { get; set; }
        public string Filiacion { get; set; } = string.Empty;
        public bool TieneFiliacionUTA { get; set; }
    }
    
    public class EvaluacionSeleccionada
    {
        public int Id { get; set; }
        public string PeriodoAcademico { get; set; } = string.Empty;
        public int Anio { get; set; }
        public int Semestre { get; set; }
        public decimal Porcentaje { get; set; }
        public DateTime FechaEvaluacion { get; set; }
    }
    
    public class CapacitacionSeleccionada
    {
        public int Id { get; set; }
        public string NombreCurso { get; set; } = string.Empty;
        public int HorasAcademicas { get; set; }
        public DateTime FechaInicio { get; set; }
        public bool EsPedagogica { get; set; }
    }
    
    public class MarcarArchivosUtilizadosRequest
    {
        public List<int> InvestigacionesIds { get; set; } = new();
        public List<int> EvaluacionesIds { get; set; } = new();
        public List<int> CapacitacionesIds { get; set; } = new();
    }

    public class TimeConfiguration
    {
        public int Id { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string Description { get; set; } = "";
        public bool IsActive { get; set; }
        public DateTime CreatedDate { get; set; }
        public string CreatedBy { get; set; } = "";
    }
}
